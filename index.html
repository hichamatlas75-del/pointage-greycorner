<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Grey Corner ‚Ä¢ Master Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet" />

<style>
  html,body{
    height:100%; margin:0; overflow-y:auto; overflow-x:hidden;
    background: radial-gradient(1200px 600px at 50% -10%, rgba(255,180,60,0.08), transparent 60%),
                linear-gradient(180deg,#02040a,#050816 40%,#02040a);
    font-family:'Plus Jakarta Sans',sans-serif; color:#e5e7eb;
  }
  .card{
    width:100%; max-width:420px; min-height:96vh; border-radius:42px; padding:18px;
    display:flex; flex-direction:column; background:linear-gradient(145deg,rgba(20,23,35,.75),rgba(5,7,15,.85));
    backdrop-filter:blur(18px); -webkit-backdrop-filter:blur(18px); border:1px solid rgba(255,255,255,.08);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04), 0 40px 80px rgba(0,0,0,.8), 0 0 40px rgba(255,170,60,.08);
    position:relative; margin:auto;
  }
  .gold{ color:#ffcc73; letter-spacing:.08em; }
  .muted{ color:rgba(229,231,235,.65); }
  .scroll{ overflow-y:auto; scrollbar-width:none; }
  .scroll::-webkit-scrollbar{ display:none }

  .btn-planning{ background: linear-gradient(180deg,#2F7BFF,#1A4ED8) !important; color:#fff !important; padding:16px 14px; border-radius:22px; font-size:12px; font-weight:900; text-transform:uppercase; width:100%; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow:0 14px 30px rgba(0,0,0,.45); transition:.25s; }
  .btn-ramadan{ background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10); color:rgba(229,231,235,.92); padding:12px 14px; border-radius:18px; font-size:11px; font-weight:900; text-transform:uppercase; width:100%; display:flex; align-items:center; justify-content:center; gap:10px; transition:.2s; }
  .btn-main{ background: linear-gradient(180deg,#ffd68a,#ffb347); color:#1a1305; font-weight:900; border-radius:26px; padding:26px; font-size:26px; box-shadow: 0 12px 25px rgba(255,170,60,.35); transition:.25s; }
  .btn-main:disabled{ opacity:.45; }

  .inpt{ width:100%; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:12px; color:#fff; font-weight:800; font-size:12px; outline:none; }
  .btn-login{ width:100%; border-radius:18px; padding:12px; font-size:12px; font-weight:900; text-transform:uppercase; background:rgba(255,204,115,.18); border:1px solid rgba(255,204,115,.28); color:#ffd68a; }

  .drawer-header{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px; margin-top:10px; display:flex; justify-content:space-between; cursor:pointer; }
  .staff-btn{ padding:14px; border-radius:14px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.06); font-size:11px; font-weight:800; text-align:center; color:white; }

  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:9999; background:rgba(0,0,0,.8); color:#fff; padding:10px 20px; border-radius:14px; font-size:12px; font-weight:900; display:none; }
</style>
</head>

<body class="flex items-center justify-center p-4">
  <div class="card">
    <div class="text-center mb-4 flex-shrink-0">
      <img id="logo" src="images/LOGO GREY CORNER.png" class="h-14 mx-auto cursor-pointer" alt="Grey Corner" />
      <div class="text-[10px] font-black uppercase tracking-widest muted mt-2">Pointage s√©curis√©</div>
    </div>

    <!-- LOGIN -->
    <div id="loginWrap" class="bg-white/5 border border-white/10 rounded-[22px] p-4">
      <div class="text-[10px] font-black uppercase tracking-widest muted mb-2">Connexion</div>
      <div class="space-y-2">
        <input id="loginEmail" class="inpt" type="email" placeholder="Email" autocomplete="username" />
        <input id="loginPass" class="inpt" type="password" placeholder="Mot de passe" autocomplete="current-password" />
        <button id="btnLogin" class="btn-login">Se connecter</button>
        <div id="loginMsg" class="text-[10px] font-black text-red-300"></div>
      </div>
    </div>

    <!-- SESSION -->
    <div id="sessionBar" class="hidden mb-3 flex items-center justify-between">
      <div class="text-[10px] font-black uppercase gold">Connect√©: <span id="roleLabel" class="text-white">‚Äî</span></div>
      <button id="btnLogout" class="text-[9px] font-black px-3 py-1 rounded-full bg-white/10 border border-white/10">Quitter</button>
    </div>

    <button onclick="window.open('https://grey-corner-app.pages.dev/', '_blank')" class="btn-planning mb-2">üóìÔ∏è PLANNING</button>
    <button onclick="window.open('https://ramadan-greycorner.pages.dev/', '_blank')" class="btn-ramadan mb-3">üåô MENU RAMADAN</button>

    <!-- APP -->
    <div id="app" class="hidden flex flex-col flex-grow overflow-hidden">

      <!-- DEVICE BIND VIEW (GERANT) -->
      <div id="deviceBind" class="hidden">
        <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
          <div class="text-[11px] font-black gold uppercase mb-2">üõ†Ô∏è Affecter cet appareil</div>
          <div class="text-[10px] font-black muted mb-3">
            Cet appareil sera verrouill√© sur 1 employ√© + PIN. Pour changer, repassez ici en mode g√©rant.
          </div>

          <!-- Optionnel: PIN manager local (si tu veux) -->
          <div class="mb-2 text-[10px] font-black muted">PIN Manager (optionnel)</div>
          <input id="mgrPin" class="inpt mb-3" type="password" inputmode="numeric" maxlength="6" placeholder="Laisser vide si non utilis√©" />

          <div class="mb-2 text-[10px] font-black muted">Employ√©</div>
          <select id="bindEmpSelect" class="inpt mb-3" style="appearance:none;">
          </select>

          <div class="mb-2 text-[10px] font-black muted">Cr√©er PIN employ√© (4 chiffres)</div>
          <input id="bindEmpPin" class="inpt mb-3" type="password" inputmode="numeric" maxlength="4" placeholder="ex: 1234" />

          <button id="btnBind" class="btn-login">Verrouiller l‚Äôappareil</button>

          <button id="btnExitBind" class="mt-3 w-full text-[10px] font-black uppercase tracking-widest text-gray-300/80 underline">
            Fermer
          </button>
        </div>
      </div>

      <!-- PIN GATE (EMPLOYE) -->
      <div id="pinGate" class="hidden">
        <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
          <div class="text-[11px] font-black gold uppercase mb-1">üîê PIN employ√©</div>
          <div class="text-[10px] font-black muted mb-3">Tape ton PIN pour activer le pointage.</div>
          <input id="pinInput" class="inpt mb-3" type="password" inputmode="numeric" maxlength="4" placeholder="PIN (4 chiffres)" />
          <button id="btnUnlock" class="btn-login">D√©verrouiller</button>

          <button id="btnBackToMenu" class="mt-3 w-full text-[10px] font-black uppercase tracking-widest text-gray-300/80 underline">
            Retour (changer nom)
          </button>
        </div>
      </div>

      <!-- MAIN POINTAGE -->
      <div id="action" class="hidden flex flex-col flex-grow justify-center">
        <div id="username" class="text-3xl font-black text-yellow-200 text-center mb-6">--</div>

        <div id="pointage-zone" class="text-center">
          <div id="status" class="text-[10px] mb-4 muted uppercase">Localisation GPS...</div>
          <button id="btn" class="btn-main w-full" disabled>Valider Arriv√©e</button>
        </div>

        <button id="btnResetDevice" class="mt-8 text-[9px] text-gray-500 uppercase tracking-widest">R√©initialiser l'appareil</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ===================== CONFIG ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyC5al_6xWbJC8S0FAvaEnRmx9BvYtGgnAM",
  authDomain: "grey-corner-presence.firebaseapp.com",
  databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "grey-corner-presence",
  storageBucket: "grey-corner-presence.firebasestorage.app",
  messagingSenderId: "730206093359",
  appId: "1:730206093359:web:59e3c145120807f29e46da"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const CAFE_LAT=34.0343959, CAFE_LON=-5.0155941, RAYON_MAX=200;

const equipe = [
  {n:"BENKHADA ABDESLAM",t:"caisse"},{n:"ENNHAILI SOUMIA",t:"caisse"},{n:"SALIL HOUDA",t:"caisse"},
  {n:"CHKAIRI YOUSSEF",t:"bar"},{n:"ELKOBBI MOSTAFA",t:"bar"},{n:"FILALI ABDERAFI",t:"bar"},{n:"KHALOUQ RACHID",t:"bar"},
  {n:"BOUCHNAK NAOUAL",t:"cuisine"},{n:"BELQASSE KHAOULA",t:"cuisine"},{n:"BOURAHMA ANAS",t:"cuisine"},
  {n:"IDRISSI SAAD",t:"cuisine"},{n:"LEMSSIEH JAWAD",t:"cuisine"},{n:"MAJDOUB JIHANE",t:"cuisine"},
  {n:"MOUJAHID IMANE",t:"cuisine"},{n:"ZAIR FATIMA",t:"cuisine"},{n:"ELGORRAMY ANISSA",t:"menage"},
  {n:"ELGORRAMY SOUAD",t:"menage"},{n:"ELMCHAOURI SOUAD",t:"menage"},{n:"SBAI HAKIMA",t:"menage"},
  {n:"ALAOUI LAZIZ",t:"service"},{n:"GUETIBI AMINE",t:"service"},{n:"HATTAF MOHAMED",t:"service"},
  {n:"HIDARA YOUSSEF",t:"service"},{n:"KAFOUNI ZAKARIAE",t:"service"},{n:"MOHSINE YOUNESS",t:"service"}
];

// Exclusion pointage (pas de t√©l√©phone)
const NO_PHONE_KEYS = new Set(["ELMCHAOURI_SOUAD", "SBAI_HAKIMA"]);

function keyStaff(n){ return String(n||'').trim().replace(/\s+/g,'_').toUpperCase(); }

const dateStr = new Intl.DateTimeFormat('fr-CA',{
  timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'
}).format(new Date());

/* ===================== UI HELPERS ===================== */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.style.display="block";
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.style.display="none",2400);
}

function show(elId){ document.getElementById(elId).classList.remove('hidden'); }
function hide(elId){ document.getElementById(elId).classList.add('hidden'); }

function nowCasablancaHHMM(){
  const parts = new Intl.DateTimeFormat('fr-FR',{
    timeZone:'Africa/Casablanca',hour:'2-digit',minute:'2-digit',hour12:false
  }).formatToParts(new Date());
  const h = parts.find(p=>p.type==='hour')?.value ?? '00';
  const m = parts.find(p=>p.type==='minute')?.value ?? '00';
  return `${h}:${m}`;
}

function hhmmToMin(hhmm){
  if(!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return null;
  const [h,m]=hhmm.split(':').map(Number);
  return h*60+m;
}
function computeRetard(hA, hP){
  const a = hhmmToMin(hA);
  const p = hhmmToMin(hP);
  if(a===null || p===null) return { late:false, minutesLate:0 };
  const diff=a-p;
  return { late: diff>0, minutesLate: Math.max(0,diff) };
}

/* ===================== PIN HASH (local) ===================== */
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function isValidPin4(pin){ return /^\d{4}$/.test(pin); }

/* ===================== STATE ===================== */
let roleRuntime = null;   // 'gerant' | 'equipe'
let unlocked = false;     // pin ok
let boundName = localStorage.getItem('gc_bound_name') || null;
let boundKey  = localStorage.getItem('gc_bound_key')  || null;
let boundPinHash = localStorage.getItem('gc_bound_pin_hash') || null;

// ancien mode (choix libre) : on ne l‚Äôutilise plus, mais on purge si besoin
let legacySelected = localStorage.getItem('gc_staff_name');

/* ===================== SAFETY PURGE ===================== */
(function purgeNoPhone(){
  if(legacySelected && NO_PHONE_KEYS.has(keyStaff(legacySelected))){
    localStorage.removeItem('gc_staff_name');
  }
  if(boundKey && NO_PHONE_KEYS.has(boundKey)){
    localStorage.removeItem('gc_bound_name');
    localStorage.removeItem('gc_bound_key');
    localStorage.removeItem('gc_bound_pin_hash');
    boundName = boundKey = boundPinHash = null;
  }
})();

/* ===================== AUTH / ROLE ===================== */
async function fetchRole(uid){
  const snap = await db.ref("users/"+uid).once("value");
  return snap.val() || null;
}

document.getElementById("btnLogin").onclick = async () => {
  const email=(document.getElementById("loginEmail").value||"").trim();
  const pass =(document.getElementById("loginPass").value||"").trim();
  document.getElementById("loginMsg").textContent="";
  try{
    await auth.signInWithEmailAndPassword(email, pass);
  }catch(e){
    document.getElementById("loginMsg").textContent="Identifiants invalides.";
  }
};

document.getElementById("btnLogout").onclick = async () => {
  try{ await auth.signOut(); }catch(e){}
  localStorage.clear();
  location.reload();
};

auth.onAuthStateChanged(async (user)=>{
  if(!user){
    roleRuntime=null;
    hide('sessionBar'); hide('app');
    show('loginWrap');
    return;
  }

  roleRuntime = await fetchRole(user.uid);
  if(roleRuntime !== 'gerant' && roleRuntime !== 'equipe'){
    await auth.signOut();
    roleRuntime=null;
    toast("Compte non autoris√©.");
    return;
  }

  // UI
  hide('loginWrap'); show('sessionBar'); show('app');
  document.getElementById('roleLabel').textContent = roleRuntime;

  // init flow
  initFlow();
});

/* ===================== DEVICE BIND (GERANT) ===================== */
// Triple click logo -> ouvrir bind device (gerant)
let logoClicks=0, logoTimer=null;
document.getElementById('logo').addEventListener('click', ()=>{
  logoClicks++;
  clearTimeout(logoTimer);
  if(logoClicks===3){
    logoClicks=0;
    if(roleRuntime === 'gerant'){
      openBindDevice();
    }else{
      toast("Acc√®s supervision r√©serv√© au g√©rant.");
    }
  }
  logoTimer=setTimeout(()=>logoClicks=0, 500);
});

function fillBindSelect(){
  const sel = document.getElementById('bindEmpSelect');
  sel.innerHTML = "";
  equipe
    .filter(e => !NO_PHONE_KEYS.has(keyStaff(e.n)))
    .slice()
    .sort((a,b)=>a.n.localeCompare(b.n))
    .forEach(e=>{
      const opt=document.createElement('option');
      opt.value = e.n;
      opt.textContent = e.n;
      sel.appendChild(opt);
    });
}

function openBindDevice(){
  fillBindSelect();
  hide('pinGate'); hide('action');
  show('deviceBind');
}

document.getElementById('btnExitBind').onclick = () => {
  hide('deviceBind');
  initFlow();
};

document.getElementById('btnBind').onclick = async () => {
  if(roleRuntime !== 'gerant'){ toast("Non autoris√©."); return; }

  const mgrPin = (document.getElementById('mgrPin').value||"").trim();
  // Optionnel: si tu veux forcer un PIN manager, d√©commente :
  // if(mgrPin !== "9999") { toast("PIN Manager incorrect."); return; }

  const name = document.getElementById('bindEmpSelect').value;
  const pin  = (document.getElementById('bindEmpPin').value||"").trim();

  if(!name){ toast("Choisir un employ√©."); return; }
  if(!isValidPin4(pin)){ toast("PIN employ√©: 4 chiffres."); return; }

  const k = keyStaff(name);
  if(NO_PHONE_KEYS.has(k)){ toast("Profil pointage manuel."); return; }

  const hash = await sha256Hex(pin + "|" + k); // hash li√© √† l‚Äôemploy√©

  localStorage.setItem('gc_bound_name', name);
  localStorage.setItem('gc_bound_key', k);
  localStorage.setItem('gc_bound_pin_hash', hash);

  // on nettoie l‚Äôancien mode
  localStorage.removeItem('gc_staff_name');

  toast("Appareil verrouill√© ‚úÖ");
  hide('deviceBind');
  initFlow();
};

/* ===================== PIN GATE (EMPLOYE) ===================== */
document.getElementById('btnUnlock').onclick = async () => {
  const pin = (document.getElementById('pinInput').value||"").trim();
  if(!isValidPin4(pin)){ toast("PIN: 4 chiffres."); return; }
  if(!boundKey || !boundPinHash){ toast("Appareil non affect√©."); return; }

  const tryHash = await sha256Hex(pin + "|" + boundKey);
  if(tryHash !== boundPinHash){
    toast("PIN incorrect ‚ùå");
    return;
  }

  unlocked = true;
  toast("D√©verrouill√© ‚úÖ");
  hide('pinGate');
  showAction();
};

document.getElementById('btnBackToMenu').onclick = () => {
  // Pour changer employ√©: uniquement g√©rant via bind device
  toast("Changement employ√©: supervision g√©rant (triple clic logo).");
};

/* ===================== RESET DEVICE (local) ===================== */
document.getElementById('btnResetDevice').onclick = async () => {
  // reset complet => exiger PIN employ√©
  const pin = prompt("PIN employ√© pour r√©initialiser l'appareil :");
  if(pin === null) return;
  if(!boundKey || !boundPinHash){ toast("Aucun PIN configur√©."); return; }
  if(!isValidPin4(pin)){ toast("PIN invalide."); return; }

  const tryHash = await sha256Hex(pin.trim() + "|" + boundKey);
  if(tryHash !== boundPinHash){
    toast("PIN incorrect ‚ùå");
    return;
  }

  localStorage.clear();
  location.reload();
};

/* ===================== FLOW ===================== */
function initFlow(){
  unlocked = false;
  hide('deviceBind'); hide('pinGate'); hide('action');

  // si appareil non affect√© -> seul g√©rant peut l‚Äôaffecter
  if(!boundKey || !boundName || !boundPinHash){
    if(roleRuntime === 'gerant'){
      toast("Appareil non affect√©. Triple clic logo ‚Üí Affecter.");
    }else{
      toast("Appareil non configur√©. Demander au g√©rant.");
    }
    return;
  }

  // block no-phone
  if(NO_PHONE_KEYS.has(boundKey)){
    toast("Pointage manuel (pas t√©l√©phone).");
    return;
  }

  // √©cran PIN
  show('pinGate');
  document.getElementById('pinInput').value = "";
  document.getElementById('username').textContent = boundName;
}

function showAction(){
  if(!boundName) return;
  hide('deviceBind'); hide('pinGate');
  show('action');

  document.getElementById('username').textContent = boundName;
  checkGPS();
  listenPointage();
}

/* ===================== GPS ===================== */
function checkGPS(){
  const status = document.getElementById('status');
  document.getElementById('btn').disabled = true;

  if(!navigator.geolocation){
    status.innerHTML = `<span class="text-red-300 font-black">GPS indisponible</span>`;
    return;
  }

  navigator.geolocation.getCurrentPosition(p=>{
    const d = getDist(p.coords.latitude, p.coords.longitude, CAFE_LAT, CAFE_LON);
    if(d <= RAYON_MAX){
      status.innerHTML = `<span class="text-emerald-300 font-black">ZONE OK ‚úÖ</span>`;
      if(unlocked) document.getElementById('btn').disabled = false;
    }else{
      status.innerHTML = `<span class="text-red-300 font-black">HORS ZONE (${Math.round(d)}m)</span>`;
    }
  }, err=>{
    status.innerHTML = `<span class="text-red-300 font-black">GPS refus√© / erreur</span>`;
  }, {enableHighAccuracy:true, timeout:12000, maximumAge:0});
}

function getDist(a,b,c,d){
  const R=6371e3; const dLat=(c-a)*Math.PI/180; const dLon=(d-b)*Math.PI/180;
  const q=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q));
}

/* ===================== LISTEN / WRITE PUNCH ===================== */
function listenPointage(){
  const staffKey = boundKey;

  // √©coute si d√©j√† point√©
  db.ref('punches/'+dateStr+'/'+staffKey).on('value', s=>{
    const v = s.val();
    if(v && v.hA){
      document.getElementById('pointage-zone').innerHTML = `
        <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
          <div class="text-emerald-400 font-black text-xl">POINT√â ‚úÖ</div>
          <div class="text-2xl font-black mt-1">${v.hA}</div>
        </div>`;
      document.getElementById('btn').disabled = true;
    }
  });

  // reset distant (si tu gardes)
  db.ref(`system_control/resets/${staffKey}`).on('value', s=>{
    if(s.val()){
      db.ref(`system_control/resets/${staffKey}`).remove();
      localStorage.clear(); location.reload();
    }
  });
}

// Action bouton
document.getElementById('btn').onclick = async () => {
  if(!unlocked){ toast("PIN requis."); return; }
  if(!boundKey){ toast("Appareil non affect√©."); return; }

  const staffKey = boundKey;

  // bloc no-phone
  if(NO_PHONE_KEYS.has(staffKey)){
    toast("Pointage manuel.");
    return;
  }

  const btn = document.getElementById('btn');
  btn.disabled = true;

  const hA = nowCasablancaHHMM();
  const ref = db.ref('punches/'+dateStr+'/'+staffKey);

  // IMPORTANT: tes rules exigent empKey + retard + retardMin + timestamp
  ref.transaction(current=>{
    current = current || {};

    // 1 seul pointage pour equipe
    if(current.hA && roleRuntime !== 'gerant') return;

    const hP = current.hP || null;
    const r = hP ? computeRetard(hA, hP) : { late:false, minutesLate:0 };

    return {
      ...current,
      empKey: staffKey,
      hA: hA,
      retard: !!r.late,
      retardMin: Number(r.minutesLate || 0),
      timestamp: firebase.database.ServerValue.TIMESTAMP
    };
  }, (err, committed)=>{
    if(err){
      toast("Erreur enregistrement.");
      btn.disabled = false;
      return;
    }
    if(!committed){
      toast("D√©j√† point√© ‚úÖ");
      btn.disabled = true;
      return;
    }
    toast("Pointage enregistr√© ‚úÖ");
    btn.disabled = true;
  });
};
</script>
</body>
</html>