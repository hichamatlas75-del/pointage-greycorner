<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grey Corner â€¢ Ramadan Kareem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        html, body { 
            height: 100%; margin: 0; overflow: hidden; 
            background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
        }
        
        body::before {
            content: ""; position: absolute; inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/arabesque.png');
            opacity: 0.1; pointer-events: none;
        }

        .main-container { 
            height: 100vh; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; padding: 1rem; position: relative;
        }

        .glass-card { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(15px);
            border: 1px solid rgba(197, 160, 89, 0.3); 
            width: 100%; max-width: 380px; height: 92vh; 
            border-radius: 2.5rem; padding: 1.5rem;
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 0 40px rgba(197, 160, 89, 0.1);
        }

        /* --- TICKER RAMADAN (60PX) --- */
        .info-ticker-container {
            background: rgba(197, 160, 89, 0.1); 
            border: 1px solid #c5a059; 
            border-radius: 16px;
            margin-bottom: 15px;
            overflow: hidden;
            white-space: nowrap;
            height: 60px;
            z-index: 50;
            display: none; 
            align-items: center;
            box-shadow: inset 0 0 15px rgba(197, 160, 89, 0.2);
        }

        .ticker-text {
            display: inline-block;
            padding-left: 100%;
            animation: ticker 22s linear infinite;
            color: #f3e8d2;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        .admin-reset {
            position: absolute; top: 25px; right: 25px;
            padding: 6px 10px; border-radius: 8px;
            background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171; font-size: 8px; font-weight: 800;
            cursor: pointer; z-index: 100;
        }

        .staff-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            overflow-y: auto; flex-grow: 1; padding: 5px; margin-bottom: 10px;
        }

        .category-title {
            grid-column: span 2; font-size: 10px; font-weight: 800; color: #c5a059;
            text-transform: uppercase; letter-spacing: 0.2em;
            padding: 15px 0 5px 0; border-bottom: 1px solid rgba(197, 160, 89, 0.2);
            display: flex; align-items: center; gap: 8px;
        }

        .btn-staff { 
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(197, 160, 89, 0.15);
            height: 55px; font-size: 10px; font-weight: 700; border-radius: 14px; 
            text-transform: uppercase; display: flex; align-items: center; justify-content: center; 
            text-align: center; transition: all 0.3s ease; color: #d1d5db;
        }

        .btn-staff.selected { 
            border-color: #c5a059 !important; background: rgba(197, 160, 89, 0.2) !important; 
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.3); color: #ffffff !important;
        }

        /* Couleurs RamadanisÃ©es pour les fonctions */
        .type-admin { border-left: 3px solid #f472b6; }
        .type-bar { border-left: 3px solid #818cf8; }
        .type-cuisine { border-left: 3px solid #f87171; }
        .type-menage { border-left: 3px solid #34d399; }
        .type-service { border-left: 3px solid #c5a059; }

        .confirm-zone { 
            display: flex; flex-direction: column; gap: 10px; 
            padding: 15px 0; border-top: 1px solid rgba(197, 160, 89, 0.2); 
        }

        .btn-main {
            background: linear-gradient(135deg, #c5a059 0%, #8a6d3b 100%);
            color: #0f172a; font-weight: 800; padding: 18px; border-radius: 18px;
            text-transform: uppercase; font-size: 13px; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .btn-main:disabled { background: #1e293b; color: #475569; opacity: 0.5; }

        .logo-container { text-align: center; margin-bottom: 10px; }
        .logo-img { height: 60px; width: auto; display: inline-block; }

        #statusLabel {
            background: rgba(0, 0, 0, 0.3); color: #94a3b8;
            border: 1px solid rgba(197, 160, 89, 0.1); border-radius: 12px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="glass-card">
            <div class="admin-reset" onclick="adminResetDevice()">RESET</div>
            
            <div class="logo-container">
                <img src="images/LOGO GREY CORNER.png" alt="Grey Corner" class="logo-img">
            </div>

            <div style="text-align: center; margin-bottom: 15px;">
                <a href="https://grey-corner-app.pages.dev/" style="text-decoration: none;">
                    <button type="button" style="background: rgba(39, 174, 96, 0.2); border: 1px solid #27ae60; color: #2ecc71; padding: 10px 18px; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 10px;">
                        <span>ðŸ“…</span> PLANNING DU <span id="date-du-jour"></span>
                    </button>
                </a>
            </div>

            <div id="tickerContainer" class="info-ticker-container">
                <div id="tickerText" class="ticker-text"></div>
            </div>

            <div id="statusLabel" class="text-center px-3 py-3 text-[10px] font-bold uppercase tracking-widest mb-4 min-h-[40px] flex items-center justify-center">
                Choisissez votre nom
            </div>
            
            <div id="staffGrid" class="staff-grid"></div>

            <div class="confirm-zone">
                <button onclick="validerPresence()" id="submitBtn" class="btn-main w-full" disabled>Valider le pointage</button>
            </div>
            <div id="msg" class="mt-2 text-[11px] font-bold hidden p-3 rounded-xl text-center"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const SHEET_ID = "1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64";
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Messages_Urgent`;

        function checkAutoRefresh() {
            const now = new Date();
            if (now.getHours() === 4 && now.getMinutes() === 0) location.reload();
        }
        setInterval(checkAutoRefresh, 60000);

        async function chargerMessageUrgent() {
            try {
                const response = await fetch(SHEET_URL);
                const text = await response.text();
                const jsonData = JSON.parse(text.substr(47).slice(0, -2));
                const messageActif = jsonData.table.rows.find(row => row.c[3] && row.c[3].v === "Actif");

                if (messageActif) {
                    const texte = messageActif.c[1] ? messageActif.c[1].v : "";
                    const type = messageActif.c[2] ? messageActif.c[2].v : "INFO";
                    const container = document.getElementById('tickerContainer');
                    const tickerText = document.getElementById('tickerText');
                    tickerText.innerHTML = `ðŸŒ™ ${type} : ${texte} &nbsp;&nbsp; âœ¦ &nbsp;&nbsp; ${texte}`;
                    container.style.display = 'flex';
                    if(type.toUpperCase() === "URGENT") {
                        container.style.background = "rgba(153, 27, 27, 0.4)";
                        container.style.borderColor = "#f87171";
                        tickerText.style.color = "#ffffff";
                    } else {
                        container.style.background = "rgba(197, 160, 89, 0.15)";
                        container.style.borderColor = "#c5a059";
                        tickerText.style.color = "#f3e8d2";
                    }
                }
            } catch (e) { console.error(e); }
        }

        const CAFE_LAT = 34.0343959; const CAFE_LON = -5.0155941; const RAYON_AUTORISE = 300; 
        const getMarocDate = () => new Intl.DateTimeFormat('fr-CA', {timeZone: 'Africa/Casablanca', year: 'numeric', month: '2-digit', day: '2-digit'}).format(new Date());
        const getMarocTime = () => new Date().toLocaleTimeString('fr-FR', {timeZone: 'Africa/Casablanca', hour: '2-digit', minute: '2-digit'});

        const dateStr = getMarocDate();
        document.getElementById('date-du-jour').textContent = dateStr.split('-').reverse().slice(0,2).join('/');

        const equipeConfig = [
            {n: "BENKHADA ABDESLAM", t: "admin"}, {n: "ENNHAILI SOUMIA", t: "admin"}, {n: "SALIL HOUDA", t: "admin"},
            {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"}, {n: "FILALI ABDERAFI", t: "bar"}, {n: "KHALOUQ RACHID", t: "bar", ex: true},
            {n: "BELQASSE KHAOULA", t: "cuisine"}, {n: "BOURAHMA ANAS", t: "cuisine"}, {n: "IDRISSI SAAD", t: "cuisine"}, {n: "LEMSSIEH JAWAD", t: "cuisine"}, {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"}, {n: "ZAIR FATIMA", t: "cuisine"},
            {n: "ELGORRAMY ANISSA", t: "menage", ex: true}, {n: "ELGORRAMY SOUAD", t: "menage"}, {n: "ELMCHAOURI SOUAD", t: "menage", ex: true}, {n: "SBAI HAKIMA", t: "menage", ex: true},
            {n: "ALAOUI LAZIZ", t: "service"}, {n: "GUETIBI AMINE", t: "service"}, {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"}, {n: "KAFOUNI ZAKARIAE", t: "service"}, {n: "MOHSINE YOUNESS", t: "service"}
        ];

        const libelles = { "admin": "Caisse et Ã‰conomat", "bar": "Bar", "cuisine": "Cuisine", "menage": "MÃ©nage", "service": "Service" };
        let selectedUser = null; 
        const submitBtn = document.getElementById('submitBtn');
        const statusLabel = document.getElementById('statusLabel');
        const grid = document.getElementById('staffGrid');

        // GÃ©nÃ©ration classÃ©e
        let currentCat = "";
        equipeConfig.forEach(emp => {
            if (emp.t !== currentCat) {
                currentCat = emp.t;
                const title = document.createElement('div');
                title.className = "category-title";
                title.innerHTML = libelles[currentCat];
                grid.appendChild(title);
            }
            const btn = document.createElement('button');
            const userKey = emp.n.trim().replace(/\s+/g, '_').toUpperCase();
            btn.className = `btn-staff type-${emp.t}`;
            btn.innerHTML = emp.n;
            btn.onclick = () => sÃ©lectionnerEmployÃ©(btn, emp);
            grid.appendChild(btn);
            
            database.ref('presences/' + dateStr + '/' + userKey).on('value', snap => {
                if (snap.val() && snap.val().off) {
                    btn.disabled = true; btn.style.opacity = "0.3";
                    btn.innerHTML = `${emp.n}<br><span style="color:#f87171;font-size:7px">REPOS</span>`;
                } else {
                    btn.disabled = false; btn.style.opacity = "1";
                    btn.innerHTML = emp.n;
                }
            });
        });

        async function sÃ©lectionnerEmployÃ©(element, emp) {
            document.querySelectorAll('.btn-staff').forEach(b => b.classList.remove('selected'));
            element.classList.add('selected');
            selectedUser = emp.n.trim().replace(/\s+/g, '_').toUpperCase();
            const snap = await database.ref('presences/' + dateStr + '/' + selectedUser).once('value');
            if (snap.val() && snap.val().on) {
                submitBtn.disabled = true; statusLabel.innerHTML = "DÃ‰JÃ€ POINTÃ‰ âœ“"; statusLabel.style.color = "#2ecc71";
            } else {
                statusLabel.style.color = "#94a3b8";
                if (emp.ex) { statusLabel.innerHTML = "âœ¦ AccÃ¨s Libre âœ¦"; submitBtn.disabled = false; }
                else activerGPS();
            }
        }

        function activerGPS() {
            statusLabel.innerHTML = "ðŸŒ™ Localisation...";
            navigator.geolocation.getCurrentPosition(pos => {
                if (getDistance(pos.coords.latitude, pos.coords.longitude, CAFE_LAT, CAFE_LON) <= RAYON_AUTORISE) {
                    statusLabel.innerHTML = "âœ… Zone ValidÃ©e"; statusLabel.style.color = "#2ecc71"; submitBtn.disabled = false;
                } else { alert("Hors zone !"); resetSelection(); }
            }, () => { alert("Activez le GPS !"); resetSelection(); });
        }

        function validerPresence() {
            database.ref('presences/' + dateStr + '/' + selectedUser).update({
                on: true, hA: getMarocTime(), timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('msg').innerHTML = "Ramadan Kareem ! PointÃ© âœ“";
                document.getElementById('msg').style.display = "block";
                setTimeout(() => location.reload(), 2000);
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const a = Math.sin(((lat2-lat1)*Math.PI/180)/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(((lon2-lon1)*Math.PI/180)/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function resetSelection() {
            selectedUser = null; submitBtn.disabled = true;
            document.querySelectorAll('.btn-staff').forEach(b => b.classList.remove('selected'));
        }

        async function adminResetDevice() {
            const code = prompt("Admin ?");
            if (code === "0000" && selectedUser) {
                await database.ref('presences/' + dateStr + '/' + selectedUser).remove();
                location.reload();
            }
        }

        window.onload = () => chargerMessageUrgent();
    </script>
</body>
</html>
