<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grey Corner • Master</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
<style>
    html,body{height:100%;margin:0;overflow:hidden;background:radial-gradient(circle at top,#111827 0%,#020617 100%);font-family:'Plus Jakarta Sans',sans-serif;}
    .card{width:100%;max-width:420px;height:96vh;background:linear-gradient(180deg,#0b0e14,#030712);border-radius:40px;padding:18px;box-shadow:0 0 60px rgba(212,175,55,.25);border:1px solid rgba(212,175,55,.25);position:relative}
    .gold{color:#d4af37}
    .btn-main{background:linear-gradient(180deg,#f5d776,#b8942e);color:#111;font-weight:900;border-radius:28px;padding:22px;font-size:22px;box-shadow:0 10px 30px rgba(212,175,55,.3)}
    .scroll{overflow-y:auto;scrollbar-width:none;}
    .scroll::-webkit-scrollbar{display:none}
    .ticker{display:none;border-radius:12px;padding:12px;font-weight:700;font-size:13px;margin-bottom:12px;text-align:center}
    .msg-normal{background:rgba(255,255,255,.05);color:#f5d776;border:1px solid rgba(212,175,55,.3)}
    .msg-urgent{background:#7f1d1d;color:#fff;border:1px solid #ef4444;animation:pulse 2s infinite}
    .drawer-header{background:rgba(255,255,255,.04);border:1px solid rgba(212,175,55,.18);border-radius:14px;padding:14px;margin-top:10px;display:flex;justify-content:space-between;cursor:pointer}
    .btn-staff{background:rgba(255,255,255,.05);border:1px solid rgba(212,175,55,.12);height:44px;font-size:10px;font-weight:800;border-radius:12px;color:#f8fafc;display:flex;align-items:center;justify-content:center;text-align:center}
    .admin-row{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.05);font-size:11px}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
</style>
</head>
<body class="flex items-center justify-center p-4">
<div class="card flex flex-col" id="mainCard">
    <div class="text-center mb-4">
        <img src="images/LOGO GREY CORNER.png" onclick="askAdmin()" class="h-14 mx-auto cursor-pointer">
    </div>

    <div id="ticker" class="ticker"></div>

    <div id="app-pointage" class="flex flex-col flex-grow overflow-hidden">
        <div class="bg-white/5 rounded-xl p-2 text-center text-sm mb-3">Présents : <span id="presentCount" class="gold font-black">0</span></div>
        <div id="status" class="text-center text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-2">Choisi ton nom</div>
        <div id="selection" class="scroll flex-grow"></div>
        <div id="action" class="hidden text-center flex-grow flex flex-col justify-center">
            <div id="username" class="text-3xl font-black text-yellow-200 mb-6">--</div>
            <button id="btn" class="btn-main w-full" disabled>Pointer arrivée</button>
            <a href="https://grey-corner-app.pages.dev/" target="_blank" class="mt-6 text-[10px] text-gray-500 underline uppercase tracking-widest">Voir le planning complet</a>
        </div>
    </div>

    <div id="app-admin" class="hidden flex flex-col flex-grow overflow-hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="gold font-black uppercase text-sm italic">Supervision Staff</h2>
            <button onclick="closeAdmin()" class="text-white text-xs bg-red-900/50 px-3 py-1 rounded-full">Quitter</button>
        </div>
        <div id="adminList" class="scroll flex-grow bg-white/5 rounded-2xl p-2"></div>
        <button onclick="localStorage.clear();location.reload();" class="mt-4 p-3 bg-white/10 text-white rounded-xl text-[10px] uppercase font-bold">Reset tous les profils</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={databaseURL:"https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const CAFE_LAT=34.0343959,CAFE_LON=-5.0155941,RAYON_MAX=200;
const URL_PLANNING_DATA="https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Planning";
const URL_MSG_SHEET="https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Messages_Urgent";

const equipe = [
    {n: "BENKHADA ABDESLAM", t: "caisse"}, {n: "ENNHAILI SOUMIA", t: "caisse"}, {n: "SALIL HOUDA", t: "caisse"},
    {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"}, {n: "FILALI ABDERAFI", t: "bar"}, {n: "KHALOUQ RACHID", t: "bar"},
    {n: "BELQASSE KHAOULA", t: "cuisine"}, {n: "BOURAHMA ANAS", t: "cuisine"}, {n: "IDRISSI SAAD", t: "cuisine"}, {n: "LEMSSIEH JAWAD", t: "cuisine"}, {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"}, {n: "ZAIR FATIMA", t: "cuisine"},
    {n: "ELGORRAMY ANISSA", t: "menage"}, {n: "ELGORRAMY SOUAD", t: "menage"}, {n: "ELMCHAOURI SOUAD", t: "menage"}, {n: "SBAI HAKIMA", t: "menage"},
    {n: "ALAOUI LAZIZ", t: "service"}, {n: "GUETIBI AMINE", t: "service"}, {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"}, {n: "KAFOUNI ZAKARIAE", t: "service"}, {n: "MOHSINE YOUNESS", t: "service"}
];

let selected=localStorage.getItem('gc_staff_name');
let plannedStart=null;
const dateStr=new Intl.DateTimeFormat('fr-CA',{timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());
const todayKey=dateStr.split('-')[2]+"/"+dateStr.split('-')[1];

function keyStaff(n){ return String(n||'').trim().replace(/\s+/g, '_').toUpperCase(); }

// --- MODE ADMIN ---
function askAdmin() {
    const code = prompt("Code Administrateur :");
    if(code === "2026") {
        document.getElementById('app-pointage').classList.add('hidden');
        document.getElementById('app-admin').classList.remove('hidden');
        loadAdminData();
    }
}
function closeAdmin(){ location.reload(); }

function loadAdminData() {
    db.ref('presences/'+dateStr).on('value', s => {
        const data = s.val() || {};
        const container = document.getElementById('adminList');
        container.innerHTML = "";
        equipe.sort((a,b)=>a.n.localeCompare(b.n)).forEach(emp => {
            const p = data[keyStaff(emp.n)];
            const div = document.createElement('div');
            div.className = "admin-row";
            div.innerHTML = `
                <span class="text-gray-300">${emp.n}</span>
                <span class="${p?.on?'text-emerald-400 font-bold':'text-gray-600'}">
                    ${p?.hA ? p.hA : '---'}
                </span>
            `;
            container.appendChild(div);
        });
    });
}

// --- LOGIQUE TICKER ---
async function loadTicker() {
    try {
        const r=await fetch(URL_MSG_SHEET);
        const t=await r.text();
        const json=JSON.parse(t.substr(47).slice(0,-2));
        const msg=json.table.rows[0].c[1].v;
        const tick=document.getElementById('ticker');
        if(msg){
            tick.innerText=msg; tick.style.display="block";
            tick.className = msg.toUpperCase().startsWith("URGENT") ? "ticker msg-urgent" : "ticker msg-normal";
        }
    } catch(e){}
}

async function loadPlannedTime(){
    if(!selected) return;
    try {
        const r=await fetch(URL_PLANNING_DATA);
        const t=await r.text();
        const json=JSON.parse(t.substr(47).slice(0,-2));
        let colIdx=-1;
        json.table.rows[0].c.forEach((cell, idx) => { if(cell && (cell.v||"").toString().includes(todayKey)) colIdx=idx; });
        const row = json.table.rows.find(r => r.c[0] && r.c[0].v.trim().toUpperCase() === selected.toUpperCase());
        if(row && row.c[colIdx]) plannedStart = row.c[colIdx].f || row.c[colIdx].v || "";
    } catch(e){}
}

function init() {
    loadTicker();
    db.ref('presences/'+dateStr).on('value', s => {
        const data = s.val() || {};
        let c=0; Object.values(data).forEach(e=>{if(e&&e.on)c++});
        document.getElementById('presentCount').innerText=c;
        if (selected) {
            const myData = data[keyStaff(selected)];
            if (myData && myData.hA) {
                const btn = document.getElementById('btn');
                btn.disabled = true;
                btn.innerText = "POINTÉ À " + myData.hA + " ✅";
                btn.style.background = "linear-gradient(180deg, #10b981, #059669)";
                document.getElementById('status').innerHTML = '<span class="text-emerald-400 font-bold uppercase text-[10px]">Session Validée</span>';
            }
        }
    });

    if (selected) {
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
        document.getElementById('username').innerText = selected;
        loadPlannedTime().finally(() => checkGPS());
    } else {
        genererListeUI();
    }
}

function genererListeUI() {
    const sel = document.getElementById('selection');
    sel.innerHTML = '';
    ["caisse","bar","cuisine","menage","service"].forEach(cat => {
        const h = document.createElement('div'); h.className="drawer-header";
        h.innerHTML=`<span class="text-[10px] font-black gold uppercase">${cat}</span><i class="gold">▼</i>`;
        const cont = document.createElement('div'); cont.className="hidden grid grid-cols-2 gap-2 py-3";
        h.onclick=()=> cont.classList.toggle('hidden');
        equipe.filter(e => e.t === cat).forEach(emp => {
            const b = document.createElement('button'); b.className="btn-staff";
            b.innerText = emp.n;
            b.onclick = () => { if(confirm(emp.n + " ?")) { localStorage.setItem('gc_staff_name', emp.n); location.reload(); }};
            cont.appendChild(b);
        });
        sel.appendChild(h); sel.appendChild(cont);
    });
}

function checkGPS(){
    navigator.geolocation.getCurrentPosition(p=>{
        const d=getDist(p.coords.latitude,p.coords.longitude,CAFE_LAT,CAFE_LON);
        if(d<=RAYON_MAX){
            document.getElementById('status').innerHTML=`<span class="text-green-400 font-bold">DANS LA ZONE</span> ${plannedStart?'<br><span class="text-[9px] gold italic">HORAIRE PRÉVU : '+plannedStart+'</span>':''}`;
            document.getElementById('btn').disabled=false;
        } else {
            document.getElementById('status').innerHTML=`<span class="text-red-400 font-bold">HORS ZONE (${Math.round(d)}m)</span>`;
        }
    }, null, {enableHighAccuracy:true});
}

function getDist(a,b,c,d){
    const R=6371e3; const dLat=(c-a)*Math.PI/180; const dLon=(d-b)*Math.PI/180;
    const q=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q));
}

document.getElementById('btn').onclick=()=>{
    const t=new Date();
    const ah=t.getHours(), am=t.getMinutes();
    const actual=ah.toString().padStart(2,'0')+":"+am.toString().padStart(2,'0');
    let retard = false;
    if(plannedStart){
        const m = plannedStart.match(/(\d{1,2})[h:](\d{2})/);
        if(m){
            const ph=parseInt(m[1]), pm=parseInt(m[2]);
            if((ah*60+am) > (ph*60+pm)) retard = true;
        }
    }
    db.ref('presences/'+dateStr+'/'+keyStaff(selected)).update({
        on:true, hA:actual, hP:plannedStart||"N/A", retard:retard, timestamp:firebase.database.ServerValue.TIMESTAMP
    }).then(()=>location.reload());
};

init();
</script>
</body>
</html>
