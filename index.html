<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Grey Corner ‚Ä¢ Master Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet" />

<style>
  /* =========================================================
     ‚úÖ THEME ENGINE (2 th√®mes) ‚Äî Dark (actuel) + Light Chic (or MAT)
     ========================================================= */
  :root{
    /* default = DARK */
    --bg-a:#02040a;
    --bg-b:#050816;
    --radial: rgba(255,180,60,0.08);

    --card-a: rgba(20,23,35,.75);
    --card-b: rgba(5,7,15,.85);
    --card-stroke: rgba(255,255,255,.08);
    --card-inset: rgba(255,255,255,.04);
    --card-shadow: 0 40px 80px rgba(0,0,0,.8);
    --card-glow: 0 0 40px rgba(255,170,60,.08);

    --text:#e5e7eb;
    --muted: rgba(229,231,235,.65);
    --gold:#ffcc73;

    --surface: rgba(255,255,255,.06);
    --surface2: rgba(255,255,255,.05);
    --stroke: rgba(255,255,255,.10);

    --btnPlan-a:#2F7BFF;
    --btnPlan-b:#1A4ED8;

    /* second button (menu) */
    --btnAlt-bg: rgba(255,255,255,.04);
    --btnAlt-stroke: rgba(255,255,255,.10);
    --btnAlt-text: rgba(229,231,235,.92);

    --btnMain-a:#ffd68a;
    --btnMain-b:#ffb347;
    --btnMain-text:#1a1305;

    --bannerBar: rgba(2,4,10,0.85);

    --toastBg: rgba(0,0,0,.8);
    --toastStroke: rgba(255,255,255,.12);

    --chipBg: rgba(255,255,255,.10);
    --chipStroke: rgba(255,255,255,.10);
    --chipText: rgba(255,255,255,.92);
  }

  html[data-theme="light"]{
    /* ‚úÖ LIGHT CHIC (or MAT) */
    --bg-a:#f7f6f2;
    --bg-b:#eef2ff;
    --radial: rgba(197,160,89,0.14);

    --card-a: rgba(255,255,255,.86);
    --card-b: rgba(255,255,255,.94);
    --card-stroke: rgba(2,6,23,.08);
    --card-inset: rgba(2,6,23,.04);
    --card-shadow: 0 22px 55px rgba(2,6,23,.12);
    --card-glow: 0 0 22px rgba(197,160,89,.16);

    --text:#0f172a;
    --muted: rgba(15,23,42,.60);
    --gold:#b89347;

    --surface: rgba(15,23,42,.06);
    --surface2: rgba(15,23,42,.05);
    --stroke: rgba(15,23,42,.10);

    --btnPlan-a:#0f172a;
    --btnPlan-b:#0b1220;

    --btnAlt-bg: rgba(15,23,42,.04);
    --btnAlt-stroke: rgba(15,23,42,.10);
    --btnAlt-text: rgba(15,23,42,.90);

    --btnMain-a:#0f172a;
    --btnMain-b:#111827;
    --btnMain-text:#ffffff;

    --bannerBar: rgba(255,255,255,0.76);

    --toastBg: rgba(15,23,42,.92);
    --toastStroke: rgba(255,255,255,.14);

    --chipBg: rgba(15,23,42,.05);
    --chipStroke: rgba(15,23,42,.10);
    --chipText: rgba(15,23,42,.85);
  }

  html,body{
    height:100%;
    margin:0;
    overflow-y:auto;
    overflow-x:hidden;
    background:
      radial-gradient(1200px 600px at 50% -10%, var(--radial), transparent 60%),
      linear-gradient(180deg,var(--bg-a),var(--bg-b) 40%,var(--bg-a));
    font-family:'Plus Jakarta Sans',sans-serif;
    color:var(--text);
  }

  .card{
    width:100%;
    max-width:420px;
    min-height:96vh;
    border-radius:42px;
    padding:18px;
    display:flex;
    flex-direction:column;
    background:linear-gradient(145deg,var(--card-a),var(--card-b));
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
    border:1px solid var(--card-stroke);
    box-shadow:
      inset 0 0 0 1px var(--card-inset),
      var(--card-shadow),
      var(--card-glow);
    position:relative;
    margin:auto;
  }

  /* subtle vignette like screenshot */
  .card::after{
    content:"";
    position:absolute;
    inset:0;
    border-radius:42px;
    pointer-events:none;
    background:
      radial-gradient(900px 420px at 50% 25%, rgba(255,255,255,.06), transparent 55%),
      radial-gradient(1200px 700px at 50% 120%, rgba(0,0,0,.35), transparent 55%);
    opacity:.65;
  }
  html[data-theme="light"] .card::after{
    background:
      radial-gradient(900px 420px at 50% 25%, rgba(2,6,23,.06), transparent 55%),
      radial-gradient(1200px 700px at 50% 120%, rgba(2,6,23,.10), transparent 55%);
    opacity:.55;
  }

  .content{ position:relative; z-index:1; display:flex; flex-direction:column; flex:1; }

  .gold{ color:var(--gold); letter-spacing:.08em; }
  .muted{ color:var(--muted); }

  .scroll{ overflow-y:auto; scrollbar-width:none; }
  .scroll::-webkit-scrollbar{ display:none }

  /* Buttons like screenshot (big pill) */
  .btn-planning{
    background: linear-gradient(180deg,var(--btnPlan-a),var(--btnPlan-b)) !important;
    color:#fff !important;
    padding:18px 16px;
    border-radius:28px;
    font-size:18px;
    font-weight:1000;
    text-transform:uppercase;
    width:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    box-shadow:0 18px 36px rgba(0,0,0,.35);
    transition:.2s;
  }
  .btn-planning:active{ transform:scale(.99); }

  .btn-menu{
    background: var(--btnAlt-bg);
    border:1px solid var(--btnAlt-stroke);
    color: var(--btnAlt-text);
    padding:18px 16px;
    border-radius:28px;
    font-size:18px;
    font-weight:1000;
    text-transform:uppercase;
    width:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
    transition:.2s;
    box-shadow:0 14px 26px rgba(0,0,0,.25);
  }
  .btn-menu:active{ transform:scale(.99); }

  .btn-main{
    background: linear-gradient(180deg,var(--btnMain-a),var(--btnMain-b));
    color:var(--btnMain-text);
    font-weight:1000;
    border-radius:26px;
    padding:26px;
    font-size:26px;
    box-shadow: 0 12px 25px rgba(0,0,0,.18);
    transition:.25s;
  }
  .btn-main:disabled{ opacity:.45; }

  .banner-wrap{
    display:none;
    gap:10px;
    align-items:stretch;
    margin:12px 0;
    position:sticky;
    top:0;
    z-index:20;
    background:var(--bannerBar);
    backdrop-filter:blur(8px);
    padding:6px;
    border-radius:18px;
    border:1px solid var(--stroke);
  }
  .banner{
    flex:1;
    border-radius:16px;
    padding:12px;
    font-weight:900;
    font-size:13px;
    text-align:center;
    border:1px solid var(--stroke);
    word-break:break-word;
    overflow-wrap:anywhere;
  }
  .msg-urgent{ background:#3a0d0d; color:#fff; border:1px solid #ff5a5a; }
  .msg-info{ background:rgba(255,200,120,.10); color:var(--gold); border:1px solid rgba(255,200,120,.28); }
  html[data-theme="light"] .msg-info{
    background: rgba(197,160,89,.10);
    border-color: rgba(197,160,89,.22);
  }

  .inpt{
    width:100%;
    background:var(--surface);
    border:1px solid var(--stroke);
    border-radius:16px;
    padding:12px;
    color:var(--text);
    font-weight:800;
    font-size:12px;
    outline:none;
  }
  .inpt:focus{ border-color: rgba(197,160,89,.35); box-shadow: 0 0 0 3px rgba(197,160,89,.12); }
  html[data-theme="light"] .inpt::placeholder{ color: rgba(15,23,42,.45); }

  .btn-login{
    width:100%;
    border-radius:18px;
    padding:12px;
    font-size:12px;
    font-weight:900;
    text-transform:uppercase;
    background:rgba(197,160,89,.16);
    border:1px solid rgba(197,160,89,.26);
    color:var(--gold);
  }

  .drawer-header{
    background:var(--surface2);
    border:1px solid var(--stroke);
    border-radius:16px;
    padding:14px;
    margin-top:10px;
    display:flex;
    justify-content:space-between;
    cursor:pointer;
    user-select:none;
  }
  .staff-btn{
    padding:14px;
    border-radius:14px;
    background:var(--surface2);
    border:1px solid var(--stroke);
    font-size:11px;
    font-weight:800;
    text-align:center;
    color:var(--text);
    transition:.15s;
  }
  .staff-btn:active{ transform:scale(.99); }

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px; z-index:9999;
    background:var(--toastBg);
    border:1px solid var(--toastStroke);
    color:#fff; padding:10px 20px;
    border-radius:14px; font-size:12px; font-weight:900;
    display:none; max-width:min(420px, calc(100vw - 24px));
    text-align:center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    border:1px solid var(--stroke);
    background:var(--surface2);
    font-size:11px; font-weight:900;
  }

  .home-box{
    background:var(--surface2);
    border:1px solid var(--stroke);
    border-radius:18px;
    padding:12px;
    margin:10px 0 12px 0;
  }

  .sep{
    height:1px;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
    margin:12px 0;
  }
  html[data-theme="light"] .sep{
    background:linear-gradient(90deg, transparent, rgba(15,23,42,.14), transparent);
  }

  .hint{ font-size:10px; font-weight:900; color:var(--muted); line-height:1.25; }

  /* ADMIN PANEL */
  .admin-wrap{
    display:none;
    flex-direction:column;
    gap:10px;
    background:var(--surface2);
    border:1px solid var(--stroke);
    border-radius:18px;
    padding:12px;
    margin-top:10px;
  }
  .admin-title{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
  }
  .admin-list{
    max-height:42vh;
    overflow:auto;
    border-radius:14px;
    border:1px solid var(--stroke);
    background:rgba(0,0,0,.12);
  }
  html[data-theme="light"] .admin-list{
    background: rgba(15,23,42,.03);
  }
  .admin-row{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 10px;
    border-bottom:1px solid rgba(255,255,255,.06);
    font-size:11px;
  }
  html[data-theme="light"] .admin-row{
    border-bottom:1px solid rgba(15,23,42,.08);
  }
  .admin-row:last-child{ border-bottom:none; }
  .btn-reset-one{
    background:rgba(239,68,68,.14);
    color:#ffb5b5;
    border:1px solid rgba(239,68,68,.22);
    padding:6px 10px;
    border-radius:12px;
    font-weight:900;
    font-size:11px;
  }
  html[data-theme="light"] .btn-reset-one{ color:#7f1d1d; }
  .btn-reset-all{
    background:#2a0f0f;
    color:#ffb5b5;
    border:1px solid rgba(255,90,90,.35);
    padding:12px;
    border-radius:14px;
    font-weight:900;
    font-size:11px;
    text-transform:uppercase;
  }
  html[data-theme="light"] .btn-reset-all{
    background:#fff;
    color:#7f1d1d;
    border:1px solid rgba(239,68,68,.30);
  }

  .chip-btn{
    font-size:10px;
    font-weight:900;
    padding:8px 10px;
    border-radius:999px;
    background:var(--chipBg);
    border:1px solid var(--chipStroke);
    color:var(--chipText);
    text-transform:uppercase;
    letter-spacing:.08em;
  }

  .top-actions{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:10px;
  }

  .public-stack{
    display:flex;
    flex-direction:column;
    gap:14px;
    margin-top:14px;
  }

  .login-toggle{
    margin-top:14px;
    font-size:10px;
    font-weight:900;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:var(--muted);
    text-align:center;
  }
  .login-toggle button{
    text-decoration:underline;
    text-underline-offset:4px;
  }
</style>
</head>

<body class="flex items-center justify-center p-4">
  <div class="card">
    <div class="content">

      <!-- HEADER -->
      <div class="text-center flex-shrink-0">
        <img id="logo" src="images/LOGO GREY CORNER.png" class="h-14 mx-auto cursor-pointer" alt="Grey Corner" />
        <div class="text-[9px] muted font-black mt-2">Triple-clic logo = Supervision (g√©rant)</div>

        <div class="top-actions">
          <button id="btnTheme2" class="chip-btn">üåô Dark</button>
        </div>
      </div>

      <!-- SESSION BAR (apr√®s login) -->
      <div id="sessionBar" class="hidden mt-3 mb-2 flex items-center justify-between gap-2">
        <div class="pill">
          <span class="muted">Connect√© :</span>
          <span id="roleLabel" class="text-yellow-200">‚Äî</span>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnTheme" class="chip-btn">üåô Dark</button>
          <button id="btnLogout" class="text-[10px] font-black px-3 py-2 rounded-full bg-white/10 border border-white/10">
            D√©connexion
          </button>
        </div>
      </div>

      <!-- PUBLIC HOME (avant login) => comme screenshot -->
      <div id="publicHome" class="public-stack">
        <button onclick="window.open('https://grey-corner-app.pages.dev/', '_blank')" class="btn-planning">
          üóìÔ∏è CONSULTER LE PLANNING
        </button>

       <a 
  href="https://greycorner.pages.dev/" 
  target="_blank" 
  rel="noopener noreferrer"
  class="btn-menu">
  üåô MENU
</a>

<div class="login-toggle">
  <button id="btnShowLogin" type="button">
    Connexion
  </button>
</div>
          <button id="btnShowLogin" type="button">Connexion</button>
        </div>

        <!-- HOME MSG (optionnel) -->
        <div id="homeMsg" class="hidden home-box">
          <div class="text-[10px] font-black gold uppercase mb-1">Note de service</div>
          <div id="homeMsgContent" class="text-[12px] font-bold">Chargement‚Ä¶</div>
        </div>

        <!-- LOGIN (d√©pliable) -->
        <div id="loginWrap" class="hidden bg-white/5 border border-white/10 rounded-[22px] p-4">
          <div class="text-[10px] font-black uppercase tracking-widest muted mb-2">Connexion</div>
          <div class="space-y-2">
            <input id="loginEmail" class="inpt" type="email" placeholder="Email" autocomplete="username" />
            <input id="loginPass" class="inpt" type="password" placeholder="Mot de passe" autocomplete="current-password" />

            <div id="pinBlock" class="hidden">
              <input id="loginPin" class="inpt" type="password" maxlength="4" placeholder="Cr√©er votre PIN (4 chiffres)" inputmode="numeric" />
              <div class="hint mt-1">Le PIN sert uniquement √† r√©initialiser cet appareil.</div>
            </div>

            <button id="btnLogin" class="btn-login">Se connecter</button>
            <div id="loginMsg" class="text-[10px] font-black text-red-300"></div>
          </div>
        </div>
      </div>

      <!-- BANNER (apr√®s login) -->
      <div id="banner-wrap" class="banner-wrap">
        <div id="banner" class="banner"></div>
      </div>

      <div class="sep"></div>

      <!-- APP (apr√®s login) -->
      <div id="app-pointage" class="flex flex-col flex-grow overflow-hidden hidden">
        <div id="selection" class="scroll flex-grow"></div>

        <div id="action" class="hidden flex flex-col flex-grow justify-center">
          <div class="text-center mb-2">
            <div class="text-[10px] muted uppercase font-black tracking-widest">Appareil assign√© √†</div>
            <div id="username" class="text-3xl font-black mt-1" style="color:var(--gold)">--</div>
          </div>

          <div id="pointage-zone" class="text-center">
            <div id="status" class="text-[10px] mb-4 muted uppercase">Localisation GPS‚Ä¶</div>
            <button id="btn" class="btn-main w-full" disabled>APPUYER POUR VALIDER</button>
          </div>

          <button id="btnResetDevice" class="mt-8 text-[10px] uppercase tracking-widest" style="color:var(--muted)">
            R√©initialiser l‚Äôappareil (PIN)
          </button>
        </div>

        <!-- ADMIN -->
        <div id="adminWrap" class="admin-wrap">
          <div class="admin-title">
            <div class="text-[10px] font-black gold uppercase">Supervision (g√©rant)</div>
            <button id="btnCloseAdmin" class="text-[10px] font-black px-3 py-2 rounded-full bg-white/10 border border-white/10">Fermer</button>
          </div>
          <div class="admin-list" id="adminList"></div>
          <button id="btnResetAll" class="btn-reset-all">üîÑ Reset global (tous les mobiles)</button>
        </div>
      </div>

    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // =========================================================
    // ‚úÖ THEME JS (persist localStorage)
    // =========================================================
    function getTheme(){ return localStorage.getItem("gc_theme") || "dark"; }

    function applyTheme(t){
      const theme = (t === "light") ? "light" : "dark";
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("gc_theme", theme);

      const label = (theme === "light") ? "‚òÄÔ∏è Clair chic" : "üåô Dark";
      const b1 = document.getElementById("btnTheme");
      const b2 = document.getElementById("btnTheme2");
      if(b1) b1.textContent = label;
      if(b2) b2.textContent = label;

      const lo = document.getElementById("btnLogout");
      if(lo){
        if(theme === "light"){
          lo.classList.remove("bg-white/10","border-white/10");
          lo.classList.add("bg-black/5","border-black/10");
        }else{
          lo.classList.add("bg-white/10","border-white/10");
          lo.classList.remove("bg-black/5","border-black/10");
        }
      }
      const closeAdmin = document.getElementById("btnCloseAdmin");
      if(closeAdmin){
        if(theme === "light"){
          closeAdmin.classList.remove("bg-white/10","border-white/10");
          closeAdmin.classList.add("bg-black/5","border-black/10");
        }else{
          closeAdmin.classList.add("bg-white/10","border-white/10");
          closeAdmin.classList.remove("bg-black/5","border-black/10");
        }
      }
    }
    function toggleTheme(){ applyTheme(getTheme() === "dark" ? "light" : "dark"); }
    applyTheme(getTheme());

    document.addEventListener("click", (e)=>{
      if(e.target && (e.target.id === "btnTheme" || e.target.id === "btnTheme2")){
        toggleTheme();
      }
    });

    // =========================================================
    // ===== Firebase config =====
    // =========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyC5al_6xWbJC8S0FAvaEnRmx9BvYtGgnAM",
      authDomain: "grey-corner-presence.firebaseapp.com",
      databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "grey-corner-presence",
      storageBucket: "grey-corner-presence.firebasestorage.app",
      messagingSenderId: "730206093359",
      appId: "1:730206093359:web:59e3c145120807f29e46da"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // ===== GPS =====
    const CAFE_LAT=34.0343959, CAFE_LON=-5.0155941, RAYON_MAX=200;

    // ===== Messages (Google Sheet gviz) =====
    const URL_MSG_SHEET="https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Messages_Urgent";

    // ===== Apps Script WebApp =====
    const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbyZFLn4Z8KHsB60caPMkdAFTXHkJcd_aP_oxP5cI_nDG7kZf5MzFm-U7vYPcNEUD4HY1Q/exec";
    const SECRET = "greycorner2026";
    const EMP_NODE_DEFAULT = "pointage";

    // ===========================
    // ‚úÖ √âQUIPE = UNIQUEMENT Firebase
    // Path: settings/equipe
    // ===========================
    let equipe = [];
    let equipeIndex = new Map();
    let equipeListenerAttached = false;

    function normalizeText(x){ return String(x || "").trim().toUpperCase().replace(/\s+/g, " "); }
    function normalizeRole(x){
      const r = String(x || "").trim().toLowerCase();
      const ok = ["caisse","bar","cuisine","menage","service"];
      return ok.includes(r) ? r : "service";
    }
    function normalizeEquipeSnapshot(val){
      if(!val) return [];
      const arr = Array.isArray(val)
        ? val.filter(Boolean)
        : Object.keys(val).sort((a,b)=>Number(a)-Number(b)).map(k=>val[k]).filter(Boolean);

      const out = [];
      const seen = new Set();
      for(const x of arr){
        const nom = normalizeText(x.nom);
        const prenom = normalizeText(x.prenom);
        const poste = normalizeRole(x.poste);
        if(!nom || !prenom) continue;
        const full = `${nom} ${prenom}`;
        if(seen.has(full)) continue;
        seen.add(full);
        out.push({ n: full, t: poste });
      }
      return out;
    }

    function toast(msg){
      const t=document.getElementById("toast");
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(toast._t);
      toast._t=setTimeout(()=>t.style.display="none",2500);
    }

    function keyStaff(n){ return String(n||'').trim().replace(/\s+/g,'_').toUpperCase(); }

    // ‚úÖ date ISO (YYYY-MM-DD) Casablanca
    const dateStr = new Intl.DateTimeFormat('fr-CA',{
      timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'
    }).format(new Date());

    let role = null;
    let selected = localStorage.getItem('gc_staff_name') || null;

    // ===== Local lock + hour saved =====
    function punchDoneKey(staffKey){ return `gc_punch_done__${dateStr}__${staffKey}`; }
    function punchTimeKey(staffKey){ return `gc_punch_time__${dateStr}__${staffKey}`; }
    function isPunchedLocal(staffKey){ return localStorage.getItem(punchDoneKey(staffKey)) === "1"; }
    function getPunchedTimeLocal(staffKey){ return localStorage.getItem(punchTimeKey(staffKey)) || ""; }
    function setPunchedLocal(staffKey, hhmm){
      localStorage.setItem(punchDoneKey(staffKey), "1");
      if(hhmm) localStorage.setItem(punchTimeKey(staffKey), hhmm);
    }

    // ===== Role fetch =====
    async function fetchRole(uid){
      const snap = await db.ref("users/"+uid).once("value");
      return snap.val() || null;
    }

    // ===== Google Sheet message =====
    async function fetchSheetMessage(){
      const r = await fetch(URL_MSG_SHEET, { cache:"no-store" });
      const t = await r.text();
      const json = JSON.parse(t.substr(47).slice(0,-2));
      const rows = json?.table?.rows || [];
      const typeRaw = rows[0]?.c?.[0]?.v || "";
      const msgRaw  = rows[0]?.c?.[1]?.v || "";
      return { type:String(typeRaw||"").trim().toUpperCase(), msg:String(msgRaw||"").trim() };
    }

    async function loadHomeMsg(){
      const box = document.getElementById("homeMsg");
      const content = document.getElementById("homeMsgContent");
      try{
        const {type,msg} = await fetchSheetMessage();
        if(!msg){ box.classList.add("hidden"); return; }
        content.textContent = msg;
        box.classList.remove("hidden");
        box.classList.remove("msg-urgent","msg-info");
        const urgent = (type==="URGENT") || msg.toUpperCase().includes("URGENT");
        box.classList.add(urgent ? "msg-urgent" : "msg-info");
      }catch(e){}
    }

    async function loadBanner(){
      const wrap = document.getElementById("banner-wrap");
      const banner = document.getElementById("banner");
      try{
        const {type,msg} = await fetchSheetMessage();
        if(!msg){ wrap.style.display="none"; return; }
        wrap.style.display="flex";
        banner.textContent = msg;
        banner.className = "banner";
        const urgent = (type==="URGENT") || msg.toUpperCase().includes("URGENT");
        banner.classList.add(urgent ? "msg-urgent" : "msg-info");
      }catch(e){ wrap.style.display="none"; }
    }

    function hasDevicePin(){ return !!localStorage.getItem('gc_device_pin'); }
    function showPinBlockIfNeeded(){
      const pinBlock = document.getElementById('pinBlock');
      if(!pinBlock) return;
      if(!hasDevicePin()) pinBlock.classList.remove('hidden');
      else pinBlock.classList.add('hidden');
    }

    function showLoggedUI(){
      document.getElementById('sessionBar').classList.remove('hidden');
      document.getElementById('roleLabel').textContent = (role||"‚Äî").toUpperCase();

      document.getElementById('publicHome').classList.add('hidden');
      document.getElementById('app-pointage').classList.remove('hidden');

      loadBanner();
      clearInterval(window.__bannerInt);
      window.__bannerInt = setInterval(loadBanner, 30000);
    }

    function showLoginUI(){
      document.getElementById('sessionBar').classList.add('hidden');

      document.getElementById('publicHome').classList.remove('hidden');
      document.getElementById('app-pointage').classList.add('hidden');

      // message home (optionnel)
      loadHomeMsg();
      clearInterval(window.__homeInt);
      window.__homeInt = setInterval(loadHomeMsg, 30000);
    }

    // ===== Login panel toggle =====
    document.getElementById("btnShowLogin").onclick = () => {
      const wrap = document.getElementById("loginWrap");
      wrap.classList.toggle("hidden");
      showPinBlockIfNeeded();
    };

    // ===== Login =====
    document.getElementById("btnLogin").onclick = async () => {
      const email = (document.getElementById("loginEmail").value||"").trim();
      const pass  = (document.getElementById("loginPass").value||"").trim();
      const pin = (document.getElementById("loginPin")?.value||"").trim();

      document.getElementById("loginMsg").textContent = "";
      if(!email || !pass){
        document.getElementById("loginMsg").textContent = "Email et mot de passe requis.";
        return;
      }
      if(!hasDevicePin() && !/^\d{4}$/.test(pin)){
        document.getElementById("loginMsg").textContent = "PIN requis (4 chiffres).";
        return;
      }

      try{
        const res = await auth.signInWithEmailAndPassword(email, pass);
        const r = await fetchRole(res.user.uid);
        if(r !== "gerant" && r !== "equipe"){
          await auth.signOut();
          document.getElementById("loginMsg").textContent = "Compte non autoris√©.";
          return;
        }
        if(!hasDevicePin()) localStorage.setItem('gc_device_pin', pin);
        location.reload();
      }catch(e){
        document.getElementById("loginMsg").textContent = "Identifiants invalides.";
      }
    };

    document.getElementById("btnLogout").onclick = async () => {
      try{ await auth.signOut(); }catch(e){}
      location.reload();
    };

    // ===== Reset device PIN =====
    document.getElementById("btnResetDevice").onclick = () => {
      const currentPin = localStorage.getItem('gc_device_pin');

      if(!currentPin){
        const newPin = prompt("Aucun PIN sur cet appareil.\nCr√©ez un PIN (4 chiffres) :");
        if(newPin === null) return;
        if(!/^\d{4}$/.test(newPin)){ toast("PIN invalide ‚ùå"); return; }
        localStorage.setItem('gc_device_pin', newPin);
        toast("PIN cr√©√© ‚úÖ");
        return;
      }

      const pin = prompt("Entrez votre PIN (4 chiffres) :");
      if(pin === null) return;
      if(pin === currentPin){
        localStorage.clear();
        toast("Appareil r√©initialis√© ‚úÖ");
        setTimeout(()=>location.reload(), 400);
      }else{
        toast("PIN incorrect ‚ùå");
      }
    };

    // ===========================
    // ‚úÖ Staff list (depuis Firebase)
    // ===========================
    function genererListeUI(){
      const sel = document.getElementById('selection');
      sel.innerHTML = `<div class="text-center text-[10px] muted uppercase font-black mb-2">Choisi ton nom (1√®re fois)</div>`;

      if(!equipe.length){
        const msg = document.createElement('div');
        msg.className="text-center text-[11px] font-black mt-4";
        msg.style.color = "var(--muted)";
        msg.textContent="Aucun collaborateur (settings/equipe).";
        sel.appendChild(msg);
        return;
      }

      const cats = ["caisse","bar","cuisine","menage","service"];
      cats.forEach(cat => {
        const staff = equipe.filter(e => e.t === cat);
        if(staff.length === 0) return;

        const h = document.createElement('div');
        h.className="drawer-header";
        h.innerHTML=`<span class="gold text-[10px] font-black uppercase">${cat}</span><span class="gold text-[10px]">‚ñº</span>`;

        const cont = document.createElement('div');
        cont.className="hidden grid grid-cols-2 gap-2 py-3";
        h.onclick = () => cont.classList.toggle('hidden');

        staff
          .slice()
          .sort((a,b)=>a.n.localeCompare(b.n))
          .forEach(emp => {
            const b = document.createElement('button');
            b.className = "staff-btn";
            b.textContent = emp.n;
            b.onclick = () => {
              if(confirm(emp.n + " ?")){
                localStorage.setItem('gc_staff_name', emp.n);
                location.reload();
              }
            };
            cont.appendChild(b);
          });

        sel.appendChild(h);
        sel.appendChild(cont);
      });
    }

    function attachEquipeListener(){
      if(equipeListenerAttached) return;
      equipeListenerAttached = true;

      db.ref("settings/equipe").on("value", (snap) => {
        equipe = normalizeEquipeSnapshot(snap.val());

        equipeIndex = new Map();
        equipe.forEach(e => equipeIndex.set(keyStaff(e.n), e));

        if(selected){
          const k = keyStaff(selected);
          if(!equipeIndex.has(k)){
            localStorage.removeItem('gc_staff_name');
            selected = null;
          }
        }

        if(selected){
          document.getElementById('selection').classList.add('hidden');
          document.getElementById('action').classList.remove('hidden');
          document.getElementById('username').textContent = selected;

          const staffKey = keyStaff(selected);
          if(isPunchedLocal(staffKey)){
            renderPointedUI(getPunchedTimeLocal(staffKey));
          }
          checkGPS();
        }else{
          document.getElementById('selection').classList.remove('hidden');
          document.getElementById('action').classList.add('hidden');
          genererListeUI();
        }

        if(document.getElementById('adminWrap').style.display === "flex"){
          openAdmin(true);
        }
      });
    }

    // ===== GPS =====
    function getDist(a,b,c,d){
      const R=6371e3;
      const dLat=(c-a)*Math.PI/180;
      const dLon=(d-b)*Math.PI/180;
      const q=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q));
    }

    function setBtnDisabledByPunchAndGps(canPunch){
      const btn = document.getElementById('btn');
      if(!btn) return;
      if(!selected){ btn.disabled = true; return; }
      const staffKey = keyStaff(selected);
      if(isPunchedLocal(staffKey)) { btn.disabled = true; return; }
      btn.disabled = !canPunch;
    }

    function checkGPS(){
      const status = document.getElementById('status');

      if(!navigator.geolocation){
        status.innerHTML = `<span style="color:#ef4444;font-weight:900;text-transform:uppercase">GPS indisponible</span>`;
        setBtnDisabledByPunchAndGps(false);
        return;
      }

      navigator.geolocation.getCurrentPosition(p => {
        const d = getDist(p.coords.latitude, p.coords.longitude, CAFE_LAT, CAFE_LON);
        if(d <= RAYON_MAX){
          status.innerHTML = `<span style="color:#10b981;font-weight:900;text-transform:uppercase">Zone Grey Corner OK</span>`;
          setBtnDisabledByPunchAndGps(true);
        }else{
          status.innerHTML = `<span style="color:#ef4444;font-weight:900;text-transform:uppercase">Hors zone (${Math.round(d)}m)</span>`;
          setBtnDisabledByPunchAndGps(false);
        }
      }, err => {
        status.innerHTML = `<span style="color:#ef4444;font-weight:900;text-transform:uppercase">GPS refus√© / erreur</span>`;
        setBtnDisabledByPunchAndGps(false);
      }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
    }

    // ===== Render pointed UI =====
    function renderPointedUI(hhmm){
      const time = hhmm || "";
      document.getElementById('pointage-zone').innerHTML = `
        <div style="background:var(--surface2);border:1px solid var(--stroke)" class="p-4 rounded-3xl">
          <div style="color:#10b981" class="font-black text-xl">POINT√â ‚úÖ</div>
          <div class="text-2xl font-black mt-1">${time ? time : "‚Äî"}</div>
          <div class="text-[10px] font-black mt-2" style="color:var(--muted)">${dateStr}</div>
        </div>`;
      const btn = document.getElementById('btn');
      if(btn) btn.disabled = true;
    }

    // ===== Export vers Apps Script (exports_daily) =====
    function buildGasUrl(paramsObj){
      const sp = new URLSearchParams(paramsObj);
      return GAS_EXEC_URL + "?" + sp.toString();
    }

    async function sendPunchToSheet({date, empNode, empKey, hA, timestamp}){
      const url = buildGasUrl({
        action: "punch",
        secret: SECRET,
        date: date,
        empNode: empNode,
        empKey: empKey,
        hA: hA,
        status: "punch",
        timestamp: String(timestamp)
      });

      const img = new Image();
      img.src = url;

      try{
        const r = await fetch(url, { method:"GET", cache:"no-store" });
        const ct = (r.headers.get("content-type") || "");
        if(ct.includes("application/json")){
          const j = await r.json();
          return !!j?.success;
        }
        return r.ok;
      }catch(e){
        return true;
      }
    }

    // ===== Punch action =====
    document.getElementById('btn').onclick = async () => {
      if(!selected) return;

      const btn = document.getElementById('btn');
      btn.disabled = true;

      const empKey = keyStaff(selected);

      if(isPunchedLocal(empKey)){
        toast("D√©j√† point√© aujourd‚Äôhui ‚úÖ");
        renderPointedUI(getPunchedTimeLocal(empKey));
        return;
      }

      const hA = new Intl.DateTimeFormat('fr-FR',{
        timeZone:'Africa/Casablanca',hour:'2-digit',minute:'2-digit',hour12:false
      }).format(new Date());

      const ts = Date.now();

      // 1) ‚úÖ Export vers Sheet
      const okSheet = await sendPunchToSheet({
        date: dateStr,
        empNode: selected || EMP_NODE_DEFAULT,
        empKey: empKey,
        hA: hA,
        timestamp: ts
      });

      if(!okSheet){
        toast("Export Sheet √©chou√© ‚ùå");
        btn.disabled = false;
        return;
      }

      // 2) Optionnel: √©crire aussi dans Firebase punches (non bloquant)
      const payload = { empKey, hA, retard:false, retardMin:0, timestamp: ts };
      try{ await db.ref('punches/'+dateStr+'/'+empKey).set(payload); }
      catch(e){ console.log("Firebase punch write failed (non bloquant):", e); }

      // 3) ‚úÖ verrou local + UI
      setPunchedLocal(empKey, hA);
      toast("Pointage enregistr√© ‚úÖ (exports_daily)");
      renderPointedUI(hA);
    };

    // ===== Reset listeners (broadcast) =====
    function attachResetListener(){
      const bc = db.ref('broadcast');

      if(selected){
        const staffKey = keyStaff(selected);
        bc.child('resets/'+staffKey).on('value', s => {
          const v = s.val();
          if(!v) return;

          const ackKey = `gc_ack_reset_one__${staffKey}`;
          const last = Number(sessionStorage.getItem(ackKey) || 0);
          if(Number(v) <= last) return;

          sessionStorage.setItem(ackKey, String(v));
          toast("Reset re√ßu ‚úÖ");
          localStorage.clear();
          setTimeout(()=>location.reload(), 250);
        });
      }

      bc.child('resetPunchesAt').on('value', s => {
        const v = s.val();
        if(!v) return;

        const last = Number(sessionStorage.getItem('gc_ack_resetPunchesAt') || 0);
        if(Number(v) <= last) return;

        sessionStorage.setItem('gc_ack_resetPunchesAt', String(v));
        toast("Reset global re√ßu ‚úÖ");
        localStorage.clear();
        setTimeout(()=>location.reload(), 250);
      });

      bc.child('resetPinsAt').on('value', s => {
        const v = s.val();
        if(!v) return;

        const last = Number(sessionStorage.getItem('gc_ack_resetPinsAt') || 0);
        if(Number(v) <= last) return;

        sessionStorage.setItem('gc_ack_resetPinsAt', String(v));
        toast("Reset PIN re√ßu ‚úÖ");
        localStorage.removeItem('gc_device_pin');
        localStorage.removeItem('gc_staff_name');
        setTimeout(()=>location.reload(), 250);
      });
    }

    // ===== Admin =====
    function openAdmin(silent=false){
      if(role !== "gerant") return;

      document.getElementById('adminWrap').style.display = "flex";
      document.getElementById('selection').classList.add('hidden');
      document.getElementById('action').classList.add('hidden');

      const list = document.getElementById('adminList');
      list.innerHTML = "";

      equipe.slice().sort((a,b)=>a.n.localeCompare(b.n)).forEach(emp => {
        const row = document.createElement('div');
        row.className = "admin-row";
        row.innerHTML = `
          <div class="font-black">${emp.n}</div>
          <button class="btn-reset-one">Reset</button>
        `;
        row.querySelector('button').onclick = () => {
          if(confirm("R√©initialiser le mobile de " + emp.n + " ?")){
            db.ref(\`broadcast/resets/\${keyStaff(emp.n)}\`).set(Date.now());
            toast("Signal reset envoy√© ‚úÖ");
          }
        };
        list.appendChild(row);
      });

      if(!silent) toast("Supervision activ√©e üõ†Ô∏è");
    }

    document.getElementById('btnCloseAdmin').onclick = () => {
      document.getElementById('adminWrap').style.display = "none";
      if(selected){
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
      }else{
        document.getElementById('selection').classList.remove('hidden');
        document.getElementById('action').classList.add('hidden');
      }
    };

    document.getElementById('btnResetAll').onclick = () => {
      if(role !== "gerant") return;
      if(confirm("R√©initialiser TOUS les mobiles ?")){
        db.ref('broadcast/resetPunchesAt').set(Date.now());
        toast("Reset global envoy√© ‚úÖ");
      }
    };

    // Triple clic logo => admin (g√©rant)
    let logoClicks=0, logoTimer;
    document.getElementById("logo").onclick = () => {
      logoClicks++;
      clearTimeout(logoTimer);
      if(logoClicks === 3){
        logoClicks = 0;
        if(role === "gerant") openAdmin(false);
        else toast("Supervision: r√©serv√© au g√©rant");
      }
      logoTimer = setTimeout(()=>logoClicks=0, 650);
    };

    // ===== Boot =====
    auth.onAuthStateChanged(async (user) => {
      if(!user){
        role = null;
        showLoginUI();
        showPinBlockIfNeeded();
        return;
      }

      role = await fetchRole(user.uid);
      if(role !== "gerant" && role !== "equipe"){
        await auth.signOut();
        role = null;
        showLoginUI();
        showPinBlockIfNeeded();
        return;
      }

      showLoggedUI();
      showPinBlockIfNeeded();

      attachEquipeListener();
      attachResetListener();

      document.getElementById('adminWrap').style.display = "none";
      document.getElementById('selection').classList.remove('hidden');
      document.getElementById('action').classList.add('hidden');
    });
  </script>
</body>
</html>