<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grey Corner • Pointage</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
<style>
    html,body{height:100%;margin:0;overflow:hidden;background:radial-gradient(circle at top,#111827 0%,#020617 100%);font-family:'Plus Jakarta Sans',sans-serif;touch-action:pan-y}
    .card{width:100%;max-width:420px;height:96vh;background:linear-gradient(180deg,#0b0e14,#030712);border-radius:40px;padding:18px;box-shadow:0 0 60px rgba(212,175,55,.25), inset 0 0 40px rgba(255,215,120,.08);border:1px solid rgba(212,175,55,.25);position:relative}
    .gold{color:#d4af37}
    .btn-main{background:linear-gradient(180deg,#f5d776,#b8942e);color:#111;font-weight:900;border-radius:28px;padding:26px;font-size:26px;box-shadow:0 10px 40px rgba(212,175,55,.4)}
    .btn-main:disabled{opacity:.25}
    .scroll{overflow-y:auto;-webkit-overflow-scrolling:touch}
    
    .ticker{display:none;border-radius:12px;padding:12px;font-weight:700;font-size:13px;margin-bottom:12px;text-align:center}
    .msg-normal{background:rgba(255,255,255,.05);color:#f5d776;border:1px solid rgba(212,175,55,.3)}
    .msg-urgent{background:#7f1d1d;color:#fff;border:1px solid #ef4444;animation:pulse 2s infinite}
    
    .drawer-header{background:rgba(255,255,255,.04);border:1px solid rgba(212,175,55,.18);border-radius:14px;padding:14px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .drawer-header span{font-size:10px;font-weight:900;color:#d4af37;text-transform:uppercase;letter-spacing:1px}
    .drawer-content{display:none;grid-template-columns:repeat(2, 1fr);gap:8px;padding:10px 0}
    .drawer-content.active{display:grid}
    .btn-staff{background:rgba(255,255,255,.05);border:1px solid rgba(212,175,55,.12);height:46px;font-size:10px;font-weight:800;border-radius:12px;text-transform:uppercase;color:#f8fafc;display:flex;align-items:center;justify-content:center;text-align:center;padding:8px}
    .big-name{font-size:34px;font-weight:900;color:#f5d776;text-align:center;margin:20px 0}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
</style>
</head>
<body class="flex items-center justify-center p-4">
<div class="card flex flex-col">
    <div class="text-center mb-6">
        <img src="images/LOGO GREY CORNER.png" id="logoAdmin" class="h-16 mx-auto cursor-pointer">
    </div>

    <div id="ticker" class="ticker"></div>

    <div class="bg-white/5 rounded-xl p-2 text-center text-sm mb-3">Présents : <span id="presentCount" class="gold font-black">0</span></div>
    <div id="status" class="text-center text-sm text-gray-300 mb-3 uppercase font-bold tracking-widest text-[10px]">Choisi ton nom</div>
    
    <div id="selection" class="scroll flex-grow"></div>

    <div id="action" class="hidden text-center flex-grow flex flex-col justify-center">
        <div id="username" class="big-name">--</div>
        <button id="btn" class="btn-main w-full" disabled>Pointer arrivée</button>
        <p class="mt-4 text-[9px] text-gray-500 uppercase tracking-widest">Zone Grey Corner Fès</p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={databaseURL:"https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const CAFE_LAT=34.0343959,CAFE_LON=-5.0155941,RAYON_MAX=200;
const URL_PLANNING="https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Planning";
const URL_MSG_SHEET="https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Messages_Urgent";

const equipe = [
    {n: "BENKHADA ABDESLAM", t: "caisse"}, {n: "ENNHAILI SOUMIA", t: "caisse"}, {n: "SALIL HOUDA", t: "caisse"},
    {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"}, {n: "FILALI ABDERAFI", t: "bar"}, {n: "KHALOUQ RACHID", t: "bar"},
    {n: "BELQASSE KHAOULA", t: "cuisine"}, {n: "BOURAHMA ANAS", t: "cuisine"}, {n: "IDRISSI SAAD", t: "cuisine"}, {n: "LEMSSIEH JAWAD", t: "cuisine"}, {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"}, {n: "ZAIR FATIMA", t: "cuisine"},
    {n: "ELGORRAMY ANISSA", t: "menage"}, {n: "ELGORRAMY SOUAD", t: "menage"}, {n: "ELMCHAOURI SOUAD", t: "menage"}, {n: "SBAI HAKIMA", t: "menage"},
    {n: "ALAOUI LAZIZ", t: "service"}, {n: "GUETIBI AMINE", t: "service"}, {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"}, {n: "KAFOUNI ZAKARIAE", t: "service"}, {n: "MOHSINE YOUNESS", t: "service"}
];

let selected=localStorage.getItem('gc_staff_name');
let plannedStart=null;
const dateStr=new Intl.DateTimeFormat('fr-CA',{timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());
const todayKey=dateStr.split('-')[2]+"/"+dateStr.split('-')[1];

function keyStaff(n){ return String(n||'').trim().replace(/\s+/g, '_').toUpperCase(); }

// 3 TAPES SUR LOGO ADMIN
let logoTaps = 0;
document.getElementById('logoAdmin').onclick = () => {
    logoTaps++;
    if(logoTaps >= 3) {
        if(confirm("Accéder au mode Admin ?")) { localStorage.clear(); location.reload(); }
        logoTaps = 0;
    }
    setTimeout(() => { logoTaps = 0; }, 2000);
};

async function loadTickerMessage() {
    try {
        const r=await fetch(URL_MSG_SHEET);
        const t=await r.text();
        const json=JSON.parse(t.substr(47).slice(0,-2));
        const msg=json.table.rows[0].c[1].v;
        const tick=document.getElementById('ticker');
        if(msg){
            tick.innerText=msg; tick.style.display="block";
            tick.className = msg.toUpperCase().startsWith("URGENT") ? "ticker msg-urgent" : "ticker msg-normal";
        }
    } catch(e){}
}

async function loadPlannedTime(){
    if(!selected) return;
    try {
        const r=await fetch(URL_PLANNING);
        const t=await r.text();
        const json=JSON.parse(t.substr(47).slice(0,-2));
        let colIdx=-1;
        json.table.rows[0].c.forEach((cell, idx) => { if(cell && (cell.v||"").toString().includes(todayKey)) colIdx=idx; });
        const row = json.table.rows.find(r => r.c[0] && r.c[0].v.trim().toUpperCase() === selected.toUpperCase());
        if(row && row.c[colIdx]) plannedStart = row.c[colIdx].f || row.c[colIdx].v || "";
    } catch(e){}
}

function init() {
    loadTickerMessage();
    db.ref('presences/'+dateStr).on('value', s => {
        const data = s.val() || {};
        let c=0; Object.values(data).forEach(e=>{if(e&&e.on)c++});
        document.getElementById('presentCount').innerText=c;
        if (selected) {
            const myData = data[keyStaff(selected)];
            if (myData && myData.hA) {
                const btn = document.getElementById('btn');
                btn.disabled = true;
                btn.innerText = "POINTÉ À " + myData.hA + " ✅";
                btn.style.background = "linear-gradient(180deg, #10b981, #059669)";
                document.getElementById('status').innerHTML = '<span class="text-emerald-400 font-bold uppercase text-[10px]">Session Validée</span>';
            }
        }
    });

    if (selected) {
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
        document.getElementById('username').innerText = selected;
        loadPlannedTime().finally(() => checkGPS());
    } else {
        genererListeUI();
    }
}

function genererListeUI() {
    const sel = document.getElementById('selection');
    sel.innerHTML = '';
    ["caisse","bar","cuisine","menage","service"].forEach(cat => {
        const h = document.createElement('div'); h.className="drawer-header";
        h.innerHTML=`<span>${cat}</span><i class="gold">▼</i>`;
        const cont = document.createElement('div'); cont.className="drawer-content";
        h.onclick=()=> cont.classList.toggle('active');
        equipe.filter(e => e.t === cat).forEach(emp => {
            const b = document.createElement('button'); b.className="btn-staff";
            b.innerText = emp.n;
            b.onclick = () => { if(confirm(emp.n + " ?")) { localStorage.setItem('gc_staff_name', emp.n); location.reload(); }};
            cont.appendChild(b);
        });
        sel.appendChild(h); sel.appendChild(cont);
    });
}

function checkGPS(){
    navigator.geolocation.getCurrentPosition(p=>{
        const d=getDist(p.coords.latitude,p.coords.longitude,CAFE_LAT,CAFE_LON);
        if(d<=RAYON_MAX){
            document.getElementById('status').innerHTML=`<span class="text-green-400 font-bold">DANS LA ZONE</span> ${plannedStart?'<br><span class="text-[9px] gold">PRÉVU : '+plannedStart+'</span>':''}`;
            document.getElementById('btn').disabled=false;
        } else {
            document.getElementById('status').innerHTML=`<span class="text-red-400 font-bold">HORS ZONE (${Math.round(d)}m)</span>`;
        }
    }, null, {enableHighAccuracy:true});
}

function getDist(a,b,c,d){
    const R=6371e3; const dLat=(c-a)*Math.PI/180; const dLon=(d-b)*Math.PI/180;
    const q=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q));
}

document.getElementById('btn').onclick=()=>{
    const t=new Date();
    const ah=t.getHours(), am=t.getMinutes();
    const actual=ah.toString().padStart(2,'0')+":"+am.toString().padStart(2,'0');
    
    let retard = false;
    if(plannedStart){
        const m = plannedStart.match(/(\d{1,2})[h:](\d{2})/);
        if(m){
            const ph=parseInt(m[1]), pm=parseInt(m[2]);
            if((ah*60+am) > (ph*60+pm)) retard = true;
        }
    }

    db.ref('presences/'+dateStr+'/'+keyStaff(selected)).update({
        on:true, hA:actual, hP:plannedStart||"N/A", retard:retard, timestamp:firebase.database.ServerValue.TIMESTAMP
    }).then(()=>location.reload());
};

init();
</script>
</body>
</html>
