<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Grey Corner ‚Ä¢ Master Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet" />

<style>
  html,body{
    height:100%; margin:0; overflow-y:auto; overflow-x:hidden;
    background:
      radial-gradient(1200px 600px at 50% -10%, rgba(255,180,60,0.08), transparent 60%),
      linear-gradient(180deg,#02040a,#050816 40%,#02040a);
    font-family:'Plus Jakarta Sans',sans-serif; color:#e5e7eb;
  }
  .card{
    width:100%; max-width:420px; min-height:96vh; border-radius:42px; padding:18px;
    display:flex; flex-direction:column;
    background:linear-gradient(145deg,rgba(20,23,35,.75),rgba(5,7,15,.85));
    backdrop-filter:blur(18px); -webkit-backdrop-filter:blur(18px);
    border:1px solid rgba(255,255,255,.08);
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.04),
      0 40px 80px rgba(0,0,0,.8),
      0 0 40px rgba(255,170,60,.08);
    position:relative; margin:auto;
  }
  .gold{ color:#ffcc73; letter-spacing:.08em; }
  .muted{ color:rgba(229,231,235,.65); }
  .scroll{ overflow-y:auto; scrollbar-width:none; }
  .scroll::-webkit-scrollbar{ display:none }

  .btn-planning{
    background: linear-gradient(180deg,#2F7BFF,#1A4ED8) !important;
    color:#fff !important; padding:16px 14px; border-radius:22px;
    font-size:12px; font-weight:900; text-transform:uppercase;
    width:100%; display:flex; align-items:center; justify-content:center; gap:10px;
    box-shadow:0 14px 30px rgba(0,0,0,.45); transition:.25s;
  }
  .btn-ramadan{
    background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.10);
    color:rgba(229,231,235,.92); padding:12px 14px; border-radius:18px;
    font-size:11px; font-weight:900; text-transform:uppercase;
    width:100%; display:flex; align-items:center; justify-content:center; gap:10px;
    transition:.2s;
  }
  .btn-main{
    background: linear-gradient(180deg,#ffd68a,#ffb347);
    color:#1a1305; font-weight:900; border-radius:26px;
    padding:26px; font-size:26px;
    box-shadow: 0 12px 25px rgba(255,170,60,.35); transition:.25s;
  }
  .btn-main:disabled{ opacity:.45; }

  .banner-wrap{
    display:none; gap:10px; align-items:stretch; margin:12px 0;
    position:sticky; top:0; z-index:20;
    background:rgba(2,4,10,0.85); backdrop-filter:blur(8px);
    padding:6px; border-radius:18px;
  }
  .banner{
    flex:1; border-radius:16px; padding:12px;
    font-weight:900; font-size:13px; text-align:center;
    border:1px solid rgba(255,255,255,.1);
    word-break:break-word; overflow-wrap:anywhere;
  }
  .msg-urgent{ background:#3a0d0d; color:#fff; border:1px solid #ff5a5a; }
  .msg-info{ background:rgba(255,200,120,.10); color:#ffd68a; border:1px solid rgba(255,200,120,.28); }

  .inpt{
    width:100%; background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.1);
    border-radius:16px; padding:12px;
    color:#fff; font-weight:800; font-size:12px; outline:none;
  }
  .inpt:focus{ border-color: rgba(255,204,115,.35); box-shadow: 0 0 0 3px rgba(255,204,115,.12); }
  .btn-login{
    width:100%; border-radius:18px; padding:12px;
    font-size:12px; font-weight:900; text-transform:uppercase;
    background:rgba(255,204,115,.18);
    border:1px solid rgba(255,204,115,.28);
    color:#ffd68a;
  }

  .drawer-header{
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.06);
    border-radius:16px; padding:14px; margin-top:10px;
    display:flex; justify-content:space-between; cursor:pointer;
    user-select:none;
  }
  .staff-btn{
    padding:14px; border-radius:14px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.06);
    font-size:11px; font-weight:800;
    text-align:center; color:white;
    transition:.15s;
  }
  .staff-btn:active{ transform:scale(.99); }

  .toast{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px; z-index:9999;
    background:rgba(0,0,0,.8);
    border:1px solid rgba(255,255,255,.12);
    color:#fff; padding:10px 20px;
    border-radius:14px; font-size:12px; font-weight:900;
    display:none; max-width:min(420px, calc(100vw - 24px));
    text-align:center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);
    font-size:11px; font-weight:900;
  }

  .home-box{
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px; padding:12px;
    margin:10px 0 12px 0;
  }

  .sep{
    height:1px;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);
    margin:12px 0;
  }

  .hint{ font-size:10px; font-weight:900; color:rgba(229,231,235,.70); line-height:1.25; }

  /* ADMIN PANEL */
  .admin-wrap{
    display:none;
    flex-direction:column;
    gap:10px;
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    padding:12px;
    margin-top:10px;
  }
  .admin-title{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
  }
  .admin-list{
    max-height:42vh;
    overflow:auto;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.08);
    background:rgba(0,0,0,.18);
  }
  .admin-row{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 10px;
    border-bottom:1px solid rgba(255,255,255,.06);
    font-size:11px;
  }
  .admin-row:last-child{ border-bottom:none; }
  .btn-reset-one{
    background:rgba(239,68,68,.18);
    color:#ffb5b5;
    border:1px solid rgba(239,68,68,.25);
    padding:6px 10px;
    border-radius:12px;
    font-weight:900;
    font-size:11px;
  }
  .btn-reset-all{
    background:#2a0f0f;
    color:#ffb5b5;
    border:1px solid rgba(255,90,90,.35);
    padding:12px;
    border-radius:14px;
    font-weight:900;
    font-size:11px;
    text-transform:uppercase;
  }
</style>
</head>

<body class="flex items-center justify-center p-4">
  <div class="card">

    <div class="text-center mb-4 flex-shrink-0">
      <img id="logo" src="images/LOGO GREY CORNER.png" class="h-14 mx-auto cursor-pointer" alt="Grey Corner" />
      <div class="text-[9px] text-white/30 font-black mt-1">Triple-clic logo = Supervision (g√©rant)</div>
    </div>

    <!-- SESSION BAR -->
    <div id="sessionBar" class="hidden mb-3 flex items-center justify-between">
      <div class="pill">
        <span class="muted">Connect√© :</span>
        <span id="roleLabel" class="text-yellow-200">‚Äî</span>
      </div>
      <button id="btnLogout" class="text-[10px] font-black px-3 py-2 rounded-full bg-white/10 border border-white/10">
        D√©connexion
      </button>
    </div>

    <!-- HOME MSG (avant login) -->
    <div id="homeMsg" class="hidden home-box">
      <div class="text-[10px] font-black gold uppercase mb-1">Note de service</div>
      <div id="homeMsgContent" class="text-[12px] font-bold">Chargement‚Ä¶</div>
    </div>

    <!-- LOGIN -->
    <div id="loginWrap" class="hidden bg-white/5 border border-white/10 rounded-[22px] p-4">
      <div class="text-[10px] font-black uppercase tracking-widest muted mb-2">Connexion</div>
      <div class="space-y-2">
        <input id="loginEmail" class="inpt" type="email" placeholder="Email" autocomplete="username" />
        <input id="loginPass" class="inpt" type="password" placeholder="Mot de passe" autocomplete="current-password" />

        <div id="pinBlock" class="hidden">
          <input id="loginPin" class="inpt" type="password" maxlength="4" placeholder="Cr√©er votre PIN (4 chiffres)" inputmode="numeric" />
          <div class="hint mt-1">Le PIN sert uniquement √† r√©initialiser cet appareil.</div>
        </div>

        <button id="btnLogin" class="btn-login">Se connecter</button>
        <div id="loginMsg" class="text-[10px] font-black text-red-300"></div>
      </div>
    </div>

    <!-- LINKS -->
    <button onclick="window.open('https://grey-corner-app.pages.dev/', '_blank')" class="btn-planning mb-2">üóìÔ∏è CONSULTER LE PLANNING</button>
    <button onclick="window.open('https://ramadan-greycorner.pages.dev/', '_blank')" class="btn-ramadan mb-3">üåô MENU RAMADAN</button>

    <!-- BANNER (apr√®s login) -->
    <div id="banner-wrap" class="banner-wrap">
      <div id="banner" class="banner"></div>
    </div>

    <div class="sep"></div>

    <!-- APP -->
    <div id="app-pointage" class="flex flex-col flex-grow overflow-hidden hidden">

      <!-- selection -->
      <div id="selection" class="scroll flex-grow"></div>

      <!-- action -->
      <div id="action" class="hidden flex flex-col flex-grow justify-center">
        <div class="text-center mb-2">
          <div class="text-[10px] muted uppercase font-black tracking-widest">Appareil assign√© √†</div>
          <div id="username" class="text-3xl font-black text-yellow-200 mt-1">--</div>
        </div>

        <div id="pointage-zone" class="text-center">
          <div id="status" class="text-[10px] mb-4 muted uppercase">Localisation GPS‚Ä¶</div>
          <button id="btn" class="btn-main w-full" disabled>Valider mon Arriv√©e</button>
        </div>

        <button id="btnResetDevice" class="mt-8 text-[10px] text-gray-300/60 uppercase tracking-widest">
          R√©initialiser l‚Äôappareil (PIN)
        </button>
      </div>

      <!-- ADMIN -->
      <div id="adminWrap" class="admin-wrap">
        <div class="admin-title">
          <div class="text-[10px] font-black gold uppercase">Supervision (g√©rant)</div>
          <button id="btnCloseAdmin" class="text-[10px] font-black px-3 py-2 rounded-full bg-white/10 border border-white/10">Fermer</button>
        </div>
        <div class="admin-list" id="adminList"></div>
        <button id="btnResetAll" class="btn-reset-all">üîÑ Reset global (tous les mobiles)</button>
      </div>

    </div>

  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyC5al_6xWbJC8S0FAvaEnRmx9BvYtGgnAM",
      authDomain: "grey-corner-presence.firebaseapp.com",
      databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "grey-corner-presence",
      storageBucket: "grey-corner-presence.firebasestorage.app",
      messagingSenderId: "730206093359",
      appId: "1:730206093359:web:59e3c145120807f29e46da"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const CAFE_LAT=34.0343959, CAFE_LON=-5.0155941, RAYON_MAX=200;

    const URL_MSG_SHEET="https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Messages_Urgent";

    const equipe = [
      {n:"BENKHADA ABDESLAM",t:"caisse"},{n:"ENNHAILI SOUMIA",t:"caisse"},{n:"SALIL HOUDA",t:"caisse"},
      {n:"CHKAIRI YOUSSEF",t:"bar"},{n:"ELKOBBI MOSTAFA",t:"bar"},{n:"FILALI ABDERAFI",t:"bar"},{n:"KHALOUQ RACHID",t:"bar"},
      {n:"BOUCHNAK NAOUAL",t:"cuisine"},{n:"BELQASSE KHAOULA",t:"cuisine"},{n:"BOURAHMA ANAS",t:"cuisine"},
      {n:"IDRISSI SAAD",t:"cuisine"},{n:"LEMSSIEH JAWAD",t:"cuisine"},{n:"MAJDOUB JIHANE",t:"cuisine"},
      {n:"MOUJAHID IMANE",t:"cuisine"},{n:"ZAIR FATIMA",t:"cuisine"},{n:"ELGORRAMY ANISSA",t:"menage"},
      {n:"ELGORRAMY SOUAD",t:"menage"},{n:"ELMCHAOURI SOUAD",t:"menage"},{n:"SBAI HAKIMA",t:"menage"},
      {n:"ALAOUI LAZIZ",t:"service"},{n:"GUETIBI AMINE",t:"service"},{n:"HATTAF MOHAMED",t:"service"},
      {n:"HIDARA YOUSSEF",t:"service"},{n:"KAFOUNI ZAKARIAE",t:"service"},{n:"MOHSINE YOUNESS",t:"service"}
    ];

    function toast(msg){
      const t=document.getElementById("toast");
      t.textContent=msg;
      t.style.display="block";
      clearTimeout(toast._t);
      toast._t=setTimeout(()=>t.style.display="none",2500);
    }

    function keyStaff(n){ return String(n||'').trim().replace(/\s+/g,'_').toUpperCase(); }

    const dateStr = new Intl.DateTimeFormat('fr-CA',{
      timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'
    }).format(new Date());

    let role = null;
    let selected = localStorage.getItem('gc_staff_name') || null;

    // ===== Local lock + hour saved =====
    function punchDoneKey(staffKey){ return `gc_punch_done__${dateStr}__${staffKey}`; }
    function punchTimeKey(staffKey){ return `gc_punch_time__${dateStr}__${staffKey}`; }
    function isPunchedLocal(staffKey){ return localStorage.getItem(punchDoneKey(staffKey)) === "1"; }
    function getPunchedTimeLocal(staffKey){ return localStorage.getItem(punchTimeKey(staffKey)) || ""; }
    function setPunchedLocal(staffKey, hhmm){
      localStorage.setItem(punchDoneKey(staffKey), "1");
      if(hhmm) localStorage.setItem(punchTimeKey(staffKey), hhmm);
    }

    // ===== Role fetch =====
    async function fetchRole(uid){
      const snap = await db.ref("users/"+uid).once("value");
      return snap.val() || null;
    }

    // ===== Google Sheet message =====
    async function fetchSheetMessage(){
      const r = await fetch(URL_MSG_SHEET, { cache:"no-store" });
      const t = await r.text();
      const json = JSON.parse(t.substr(47).slice(0,-2));
      const rows = json?.table?.rows || [];
      const typeRaw = rows[0]?.c?.[0]?.v || "";
      const msgRaw  = rows[0]?.c?.[1]?.v || "";
      return { type:String(typeRaw||"").trim().toUpperCase(), msg:String(msgRaw||"").trim() };
    }

    async function loadHomeMsg(){
      const box = document.getElementById("homeMsg");
      const content = document.getElementById("homeMsgContent");
      try{
        const {type,msg} = await fetchSheetMessage();
        if(!msg){ box.classList.add("hidden"); return; }
        content.textContent = msg;
        box.classList.remove("hidden");
        box.classList.remove("msg-urgent","msg-info");
        const urgent = (type==="URGENT") || msg.toUpperCase().includes("URGENT");
        box.classList.add(urgent ? "msg-urgent" : "msg-info");
      }catch(e){}
    }

    async function loadBanner(){
      const wrap = document.getElementById("banner-wrap");
      const banner = document.getElementById("banner");
      try{
        const {type,msg} = await fetchSheetMessage();
        if(!msg){ wrap.style.display="none"; return; }
        wrap.style.display="flex";
        banner.textContent = msg;
        banner.className = "banner";
        const urgent = (type==="URGENT") || msg.toUpperCase().includes("URGENT");
        banner.classList.add(urgent ? "msg-urgent" : "msg-info");
      }catch(e){ wrap.style.display="none"; }
    }

    function hasDevicePin(){ return !!localStorage.getItem('gc_device_pin'); }
    function showPinBlockIfNeeded(){
      const pinBlock = document.getElementById('pinBlock');
      if(!pinBlock) return;
      if(!hasDevicePin()) pinBlock.classList.remove('hidden');
      else pinBlock.classList.add('hidden');
    }

    function showLoggedUI(){
      document.getElementById('sessionBar').classList.remove('hidden');
      document.getElementById('roleLabel').textContent = (role||"‚Äî").toUpperCase();
      document.getElementById('app-pointage').classList.remove('hidden');
      document.getElementById('loginWrap').classList.add('hidden');
      document.getElementById('homeMsg').classList.add('hidden');

      loadBanner();
      clearInterval(window.__bannerInt);
      window.__bannerInt = setInterval(loadBanner, 30000);
    }

    function showLoginUI(){
      document.getElementById('sessionBar').classList.add('hidden');
      document.getElementById('app-pointage').classList.add('hidden');
      document.getElementById('loginWrap').classList.remove('hidden');
      document.getElementById('homeMsg').classList.remove('hidden');

      loadHomeMsg();
      clearInterval(window.__homeInt);
      window.__homeInt = setInterval(loadHomeMsg, 30000);
    }

    // ===== Login =====
    document.getElementById("btnLogin").onclick = async () => {
      const email = (document.getElementById("loginEmail").value||"").trim();
      const pass  = (document.getElementById("loginPass").value||"").trim();
      const pin = (document.getElementById("loginPin")?.value||"").trim();

      document.getElementById("loginMsg").textContent = "";
      if(!email || !pass){
        document.getElementById("loginMsg").textContent = "Email et mot de passe requis.";
        return;
      }
      if(!hasDevicePin() && !/^\d{4}$/.test(pin)){
        document.getElementById("loginMsg").textContent = "PIN requis (4 chiffres).";
        return;
      }

      try{
        const res = await auth.signInWithEmailAndPassword(email, pass);
        const r = await fetchRole(res.user.uid);
        if(r !== "gerant" && r !== "equipe"){
          await auth.signOut();
          document.getElementById("loginMsg").textContent = "Compte non autoris√©.";
          return;
        }
        if(!hasDevicePin()) localStorage.setItem('gc_device_pin', pin);
        location.reload();
      }catch(e){
        document.getElementById("loginMsg").textContent = "Identifiants invalides.";
      }
    };

    document.getElementById("btnLogout").onclick = async () => {
      try{ await auth.signOut(); }catch(e){}
      location.reload();
    };

    // ===== Reset device PIN (toujours actif) =====
    document.getElementById("btnResetDevice").onclick = () => {
      const currentPin = localStorage.getItem('gc_device_pin');

      if(!currentPin){
        const newPin = prompt("Aucun PIN sur cet appareil.\nCr√©ez un PIN (4 chiffres) :");
        if(newPin === null) return;
        if(!/^\d{4}$/.test(newPin)){ toast("PIN invalide ‚ùå"); return; }
        localStorage.setItem('gc_device_pin', newPin);
        toast("PIN cr√©√© ‚úÖ");
        return;
      }

      const pin = prompt("Entrez votre PIN (4 chiffres) :");
      if(pin === null) return;
      if(pin === currentPin){
        localStorage.clear();
        toast("Appareil r√©initialis√© ‚úÖ");
        setTimeout(()=>location.reload(), 400);
      }else{
        toast("PIN incorrect ‚ùå");
      }
    };

    // ===== Staff list =====
    function genererListeUI(){
      const sel = document.getElementById('selection');
      sel.innerHTML = `<div class="text-center text-[10px] muted uppercase font-black mb-2">Choisi ton nom (1√®re fois)</div>`;
      const cats = ["caisse","bar","cuisine","menage","service"];
      cats.forEach(cat => {
        const staff = equipe.filter(e => e.t === cat);
        if(staff.length === 0) return;

        const h = document.createElement('div');
        h.className="drawer-header";
        h.innerHTML=`<span class="gold text-[10px] font-black uppercase">${cat}</span><span class="gold text-[10px]">‚ñº</span>`;

        const cont = document.createElement('div');
        cont.className="hidden grid grid-cols-2 gap-2 py-3";
        h.onclick = () => cont.classList.toggle('hidden');

        staff.forEach(emp => {
          const b = document.createElement('button');
          b.className = "staff-btn";
          b.textContent = emp.n;
          b.onclick = () => {
            if(confirm(emp.n + " ?")){
              localStorage.setItem('gc_staff_name', emp.n);
              location.reload();
            }
          };
          cont.appendChild(b);
        });

        sel.appendChild(h);
        sel.appendChild(cont);
      });
    }

    // ===== GPS =====
    function getDist(a,b,c,d){
      const R=6371e3;
      const dLat=(c-a)*Math.PI/180;
      const dLon=(d-b)*Math.PI/180;
      const q=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q));
    }

    function setBtnDisabledByPunchAndGps(canPunch){
      const btn = document.getElementById('btn');
      if(!btn) return;
      if(!selected){ btn.disabled = true; return; }
      const staffKey = keyStaff(selected);
      if(isPunchedLocal(staffKey)) { btn.disabled = true; return; }
      btn.disabled = !canPunch;
    }

    function checkGPS(){
      const status = document.getElementById('status');

      if(!navigator.geolocation){
        status.innerHTML = `<span class="text-red-300 font-black uppercase">GPS indisponible</span>`;
        setBtnDisabledByPunchAndGps(false);
        return;
      }

      navigator.geolocation.getCurrentPosition(p => {
        const d = getDist(p.coords.latitude, p.coords.longitude, CAFE_LAT, CAFE_LON);
        if(d <= RAYON_MAX){
          status.innerHTML = `<span class="text-emerald-300 font-black uppercase">Zone Grey Corner OK</span>`;
          setBtnDisabledByPunchAndGps(true);
        }else{
          status.innerHTML = `<span class="text-red-300 font-black uppercase">Hors zone (${Math.round(d)}m)</span>`;
          setBtnDisabledByPunchAndGps(false);
        }
      }, err => {
        status.innerHTML = `<span class="text-red-300 font-black uppercase">GPS refus√© / erreur</span>`;
        setBtnDisabledByPunchAndGps(false);
      }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
    }

    // ===== Render pointed UI (heure locale) =====
    function renderPointedUI(hhmm){
      const time = hhmm || "";
      document.getElementById('pointage-zone').innerHTML = `
        <div class="bg-white/5 p-4 rounded-3xl border border-white/10">
          <div class="text-emerald-400 font-black text-xl">POINT√â ‚úÖ</div>
          <div class="text-2xl font-black mt-1">${time ? time : "‚Äî"}</div>
          <div class="text-[10px] font-black text-white/40 mt-2">${dateStr}</div>
        </div>`;
      const btn = document.getElementById('btn');
      if(btn) btn.disabled = true;
    }

    // ===== Punch action =====
    document.getElementById('btn').onclick = async () => {
      if(!selected) return;

      const staffKey = keyStaff(selected);

      if(isPunchedLocal(staffKey)){
        toast("D√©j√† point√© aujourd‚Äôhui ‚úÖ");
        renderPointedUI(getPunchedTimeLocal(staffKey));
        return;
      }

      const hA = new Intl.DateTimeFormat('fr-FR',{
        timeZone:'Africa/Casablanca',hour:'2-digit',minute:'2-digit',hour12:false
      }).format(new Date());

      const payload = {
        empKey: staffKey,
        hA: hA,
        retard: false,
        retardMin: 0,
        timestamp: Date.now()
      };

      try{
        await db.ref('punches/'+dateStr+'/'+staffKey).set(payload);
        setPunchedLocal(staffKey, hA);
        toast("Pointage enregistr√© ‚úÖ");
        renderPointedUI(hA);
      }catch(e){
        // Si c‚Äôest refus√©: le plus fr√©quent = 2√®me tentative => on verrouille localement
        if(e?.code === "PERMISSION_DENIED"){
          setPunchedLocal(staffKey, hA);
          toast("D√©j√† point√© aujourd‚Äôhui ‚úÖ");
          renderPointedUI(getPunchedTimeLocal(staffKey) || hA);
          return;
        }
        toast("Erreur enregistrement ‚ùå");
        console.log("PUNCH ERROR:", e);
        document.getElementById('btn').disabled = false;
      }
    };

    // ===== Reset listeners =====
    function attachResetListener(){
      if(selected){
        db.ref(`system_control/resets/${keyStaff(selected)}`).on('value', s => {
          if(s.val()){
            db.ref(`system_control/resets/${keyStaff(selected)}`).remove();
            localStorage.clear();
            location.reload();
          }
        });
      }
      db.ref('system_control/global_reset').on('value', s => {
        if(s.val()){
          db.ref('system_control/global_reset').remove();
          localStorage.clear();
          location.reload();
        }
      });
    }

    // ===== Admin =====
    function openAdmin(){
      if(role !== "gerant") return;

      document.getElementById('adminWrap').style.display = "flex";
      document.getElementById('selection').classList.add('hidden');
      document.getElementById('action').classList.add('hidden');

      const list = document.getElementById('adminList');
      list.innerHTML = "";

      equipe.slice().sort((a,b)=>a.n.localeCompare(b.n)).forEach(emp => {
        const row = document.createElement('div');
        row.className = "admin-row";
        row.innerHTML = `
          <div class="font-black text-white/90">${emp.n}</div>
          <button class="btn-reset-one">Reset</button>
        `;
        row.querySelector('button').onclick = () => {
          if(confirm("R√©initialiser le mobile de " + emp.n + " ?")){
            db.ref(`system_control/resets/${keyStaff(emp.n)}`).set(Date.now());
            toast("Signal reset envoy√© ‚úÖ");
          }
        };
        list.appendChild(row);
      });
    }

    document.getElementById('btnCloseAdmin').onclick = () => {
      document.getElementById('adminWrap').style.display = "none";
      // retour normal
      if(selected){
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
      }else{
        document.getElementById('selection').classList.remove('hidden');
        document.getElementById('action').classList.add('hidden');
      }
    };

    document.getElementById('btnResetAll').onclick = () => {
      if(role !== "gerant") return;
      if(confirm("R√©initialiser TOUS les mobiles ?")){
        db.ref('system_control/global_reset').set(Date.now());
        toast("Reset global envoy√© ‚úÖ");
      }
    };

    // Triple clic logo => admin (g√©rant)
    let logoClicks=0, logoTimer;
    document.getElementById("logo").onclick = () => {
      logoClicks++;
      clearTimeout(logoTimer);
      if(logoClicks === 3){
        logoClicks = 0;
        if(role === "gerant"){
          openAdmin();
          toast("Supervision activ√©e üõ†Ô∏è");
        }else{
          toast("Supervision: r√©serv√© au g√©rant");
        }
      }
      logoTimer = setTimeout(()=>logoClicks=0, 650);
    };

    // ===== Boot =====
    auth.onAuthStateChanged(async (user) => {
      if(!user){
        role = null;
        showLoginUI();
        showPinBlockIfNeeded();
        return;
      }

      role = await fetchRole(user.uid);
      if(role !== "gerant" && role !== "equipe"){
        await auth.signOut();
        role = null;
        showLoginUI();
        showPinBlockIfNeeded();
        return;
      }

      showLoggedUI();
      showPinBlockIfNeeded();
      attachResetListener();

      // √©cran normal
      document.getElementById('adminWrap').style.display = "none";
      document.getElementById('selection').classList.remove('hidden');
      document.getElementById('action').classList.add('hidden');

      if(selected){
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
        document.getElementById('username').textContent = selected;

        const staffKey = keyStaff(selected);
        if(isPunchedLocal(staffKey)){
          renderPointedUI(getPunchedTimeLocal(staffKey));
        }

        checkGPS();
      }else{
        genererListeUI();
      }
    });
  </script>
</body>
</html>