<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grey Corner ‚Ä¢ Syst√®me</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); font-family: 'Plus Jakarta Sans', sans-serif; }
        body::before { content: ""; position: absolute; inset: 0; background-image: url('https://www.transparenttextures.com/patterns/arabesque.png'); opacity: 0.1; pointer-events: none; }
        
        .glass-card { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(197, 160, 89, 0.3); width: 100%; max-width: 400px; height: 95vh; border-radius: 2.5rem; padding: 1.2rem; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 40px rgba(197, 160, 89, 0.1); }
        
        /* TICKER CONFIGUR√â √Ä 60PX */
        .info-ticker-container { background: rgba(197, 160, 89, 0.1); border: 1px solid #c5a059; border-radius: 12px; margin-bottom: 12px; height: 60px; overflow: hidden; white-space: nowrap; display: none; align-items: center; z-index: 10; }
        .ticker-text { display: inline-block; padding-left: 100%; animation: ticker 25s linear infinite; color: #f3e8d2; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* STYLE TIROIRS */
        .drawer-header { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(197, 160, 89, 0.2); border-radius: 12px; padding: 14px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; }
        .drawer-header:active { transform: scale(0.98); background: rgba(197, 160, 89, 0.05); }
        .drawer-header span { font-size: 10px; font-weight: 800; color: #c5a059; text-transform: uppercase; letter-spacing: 1px; }
        .drawer-content { display: none; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 10px 0; }
        .drawer-content.active { display: grid; }

        .btn-staff { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(197, 160, 89, 0.1); height: 45px; font-size: 10px; font-weight: 700; border-radius: 10px; text-transform: uppercase; color: #f3e8d2; display: flex; align-items: center; justify-content: center; text-align: center; width: 100%; }
        .btn-staff:disabled { opacity: 0.2; color: #64748b; cursor: not-allowed; }

        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c5a059; border-radius: 10px; }
        #adminPanel { background: #0f172a; z-index: 100; border-radius: 2.5rem; }
        
        .status-sync { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass-card">
        <div class="text-center mb-2">
            <img src="images/LOGO GREY CORNER.png" alt="Logo" id="logoAdmin" class="h-12 mx-auto mb-2 cursor-pointer active:scale-90 transition-transform">
            <a href="https://grey-corner-app.pages.dev/">
                <button type="button" style="background: rgba(39, 174, 96, 0.2); border: 1px solid #27ae60; color: #2ecc71; padding: 6px 14px; border-radius: 10px; font-size: 10px; font-weight: 700; display: inline-flex; align-items: center; gap: 8px;">
                    üìÖ PLANNING DU <span id="date-btn"></span>
                </button>
            </a>
        </div>

        <div id="tickerContainer" class="info-ticker-container">
            <div id="tickerText" class="ticker-text"></div>
        </div>

        <div id="liveCounter" class="bg-white/5 border border-white/10 rounded-2xl p-3 mb-3 flex items-center justify-center gap-3">
            <div class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#c5a059] opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-[#c5a059]"></span>
            </div>
            <div class="text-[10px] font-bold uppercase tracking-wider text-slate-300">
                <span id="presentCount" class="text-[#c5a059] text-sm">0</span> membres de la famille en poste
            </div>
        </div>

        <div id="statusLabel" class="text-center px-3 py-2 text-[10px] font-bold uppercase mb-4 bg-black/40 border border-white/5 rounded-xl min-h-[50px] flex flex-col items-center justify-center text-slate-400">
            <span class="status-sync">Synchronisation...</span>
        </div>

        <div id="selectionZone" class="overflow-y-auto flex-grow custom-scroll hidden"></div>

        <div id="actionZone" class="hidden text-center flex-grow flex flex-col justify-center">
            <button id="submitBtn" onclick="validerPresence()" disabled class="w-full py-8 rounded-2xl bg-gradient-to-r from-[#c5a059] to-[#8a6d3b] text-slate-900 font-extrabold text-xl shadow-lg active:scale-95 disabled:opacity-30">
                POINTER PR√âSENCE
            </button>
            <button onclick="resetUserMemory()" class="mt-8 text-[10px] text-slate-500 underline uppercase tracking-widest">Changer de nom</button>
        </div>

        <div id="adminPanel" class="hidden absolute inset-0 p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-[#c5a059] font-extrabold">LISTE DE CONTR√îLE</h2>
                <button onclick="closeAdmin()" class="text-white text-[10px] bg-white/10 px-3 py-1 rounded-full uppercase">Fermer</button>
            </div>
            <div id="presenceList" class="flex-grow overflow-y-auto custom-scroll text-white text-[11px] space-y-4"></div>
            <button onclick="if(confirm('Reset cet appareil ?')) { localStorage.clear(); location.reload(); }" class="mt-4 p-3 border border-red-900/50 text-red-500 text-[9px] font-bold rounded-xl uppercase">R√©initialiser Appareil</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const equipeConfig = [
            {n: "BENKHADA ABDESLAM", t: "admin"}, {n: "ENNHAILI SOUMIA", t: "admin"}, {n: "SALIL HOUDA", t: "admin"},
            {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"}, {n: "FILALI ABDERAFI", t: "bar"}, {n: "KHALOUQ RACHID", t: "bar"},
            {n: "BELQASSE KHAOULA", t: "cuisine"}, {n: "BOURAHMA ANAS", t: "cuisine"}, {n: "IDRISSI SAAD", t: "cuisine"}, {n: "LEMSSIEH JAWAD", t: "cuisine"}, {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"}, {n: "ZAIR FATIMA", t: "cuisine"},
            {n: "ELGORRAMY ANISSA", t: "menage"}, {n: "ELGORRAMY SOUAD", t: "menage"}, {n: "ELMCHAOURI SOUAD", t: "menage"}, {n: "SBAI HAKIMA", t: "menage"},
            {n: "ALAOUI LAZIZ", t: "service"}, {n: "GUETIBI AMINE", t: "service"}, {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"}, {n: "KAFOUNI ZAKARIAE", t: "service"}, {n: "MOHSINE YOUNESS", t: "service"}
        ];

        let staffRepos = [];
        let selectedUser = localStorage.getItem('gc_staff_name');
        const dateStr = new Intl.DateTimeFormat('fr-CA', {timeZone: 'Africa/Casablanca', year: 'numeric', month: '2-digit', day: '2-digit'}).format(new Date());
        document.getElementById('date-btn').innerText = dateStr.split('-')[2] + "/" + dateStr.split('-')[1];

        // --- FETCH PLANNING GOOGLE SHEETS ---
        async function fetchRepos() {
            const URL_PLANNING = `https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Planning`;
            try {
                const r = await fetch(URL_PLANNING);
                const txt = await r.text();
                const json = JSON.parse(txt.substr(47).slice(0, -2));
                const rows = json.table.rows;
                let colIdx = -1;
                const todayFormatted = dateStr.split('-')[2] + "/" + dateStr.split('-')[1];
                rows[0].c.forEach((cell, idx) => { if(cell && cell.v && cell.v.toString().includes(todayFormatted)) colIdx = idx; });
                if (colIdx !== -1) {
                    rows.forEach(row => {
                        if (row.c[0] && row.c[colIdx] && (row.c[colIdx].v === "REPOS" || row.c[colIdx].v === "R")) {
                            staffRepos.push(row.c[0].v.trim().toUpperCase());
                        }
                    });
                }
            } catch (e) { console.error("Erreur planning", e); }
            init();
        }

        // --- GPS PR√âCISION ---
        function lancerGPS() {
            document.getElementById('statusLabel').innerHTML = "üìç LOCALISATION...";
            navigator.geolocation.getCurrentPosition((pos) => {
                const dist = getDistance(pos.coords.latitude, pos.coords.longitude, 34.0343959, -5.0155941);
                if (dist <= 300) {
                    document.getElementById('statusLabel').innerHTML = "Bonjour " + selectedUser + "<br><span class='text-green-400 font-extrabold'>‚úÖ AU RESTAURANT</span>";
                    verifierSiDejaFait();
                } else {
                    document.getElementById('statusLabel').innerHTML = "‚ùå HORS ZONE (" + Math.round(dist) + "m)";
                }
            }, (err) => {
                document.getElementById('statusLabel').innerHTML = "‚ùå GPS REQUIS<br><span class='text-[8px]'>Activez la position</span>";
            }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- FIREBASE LOGIC ---
        function brancherCompteurLive() {
            database.ref('presences/' + dateStr).on('value', (snap) => {
                const data = snap.val() || {};
                let count = 0;
                Object.values(data).forEach(e => { if(e.on) count++; });
                document.getElementById('presentCount').innerText = count;
            });
        }

        function verifierSiDejaFait() {
            const key = selectedUser.trim().replace(/\s+/g, '_').toUpperCase();
            database.ref('presences/' + dateStr + '/' + key).once('value', snap => {
                const data = snap.val();
                if (data && data.on) {
                    document.getElementById('statusLabel').innerHTML = "‚úì POINTAGE D√âJ√Ä ENREGISTR√â";
                    document.getElementById('submitBtn').disabled = true;
                } else {
                    document.getElementById('submitBtn').disabled = false;
                }
            });
        }

        function validerPresence() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            const key = selectedUser.trim().replace(/\s+/g, '_').toUpperCase();
            const heure = new Intl.DateTimeFormat('fr-FR', {timeZone: 'Africa/Casablanca', hour:'2-digit', minute:'2-digit'}).format(new Date());
            database.ref('presences/' + dateStr + '/' + key).update({ 
                on: true, hA: heure, timestamp: firebase.database.ServerValue.TIMESTAMP 
            }).then(() => { 
                document.getElementById('statusLabel').innerHTML = "‚ú® POINTAGE R√âUSSI !";
                setTimeout(() => location.reload(), 2000); 
            });
        }

        // --- UI GENERATION ---
        function init() {
            const selection = document.getElementById('selectionZone');
            const action = document.getElementById('actionZone');
            chargerTicker();
            brancherCompteurLive();

            if (selectedUser) {
                selection.classList.add('hidden');
                action.classList.remove('hidden');
                lancerGPS();
            } else {
                selection.classList.remove('hidden');
                action.classList.add('hidden');
                document.getElementById('statusLabel').innerText = "S√âLECTIONNEZ VOTRE NOM";
                
                selection.innerHTML = "";
                const cats = ["admin", "bar", "cuisine", "menage", "service"];
                
                cats.forEach(c => {
                    const header = document.createElement('div');
                    header.className = "drawer-header";
                    header.innerHTML = `<span>${c}</span> <i class="arrow">‚ñº</i>`;
                    
                    const content = document.createElement('div');
                    content.className = "drawer-content";

                    header.onclick = () => {
                        const isAct = content.classList.contains('active');
                        document.querySelectorAll('.drawer-content').forEach(el => el.classList.remove('active'));
                        document.querySelectorAll('.arrow').forEach(el => el.innerText = '‚ñº');
                        if(!isAct) {
                            content.classList.add('active');
                            header.querySelector('.arrow').innerText = '‚ñ≤';
                        }
                    };

                    equipeConfig.filter(e => e.t === c).forEach(emp => {
                        const isRepos = staffRepos.includes(emp.n.toUpperCase());
                        const b = document.createElement('button');
                        b.className = "btn-staff";
                        b.innerText = isRepos ? emp.n + " (REPOS)" : emp.n;
                        b.disabled = isRepos;
                        b.onclick = () => { 
                            if(confirm("Confirmer : " + emp.n + " ?")) { 
                                localStorage.setItem('gc_staff_name', emp.n); 
                                location.reload(); 
                            } 
                        };
                        content.appendChild(b);
                    });
                    selection.appendChild(header);
                    selection.appendChild(content);
                });
            }
        }

        async function chargerTicker() {
            const URL_TICKER = `https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Messages_Urgent`;
            try {
                const r = await fetch(URL_TICKER);
                const txt = await r.text();
                const json = JSON.parse(txt.substr(47).slice(0, -2));
                const messageActif = json.table.rows.find(row => row.c[3] && row.c[3].v === "Actif");
                if (messageActif) {
                    document.getElementById('tickerText').innerHTML = `üåô INFO : ${messageActif.c[1].v} &nbsp;&nbsp; ‚ú¶ &nbsp;&nbsp; ${messageActif.c[1].v}`;
                    document.getElementById('tickerContainer').style.display = 'flex';
                }
            } catch (e) {}
        }

        // --- ADMIN PANEL SECRETS ---
        let logoClicks = 0;
        document.getElementById('logoAdmin').onclick = () => {
            logoClicks++;
            if (logoClicks === 3) {
                let code = prompt("Code Admin :");
                if (code === "2026") openAdmin();
                logoClicks = 0;
            }
            setTimeout(() => logoClicks = 0, 2000);
        };

        function openAdmin() {
            document.getElementById('adminPanel').classList.remove('hidden');
            database.ref('presences/' + dateStr).on('value', snap => {
                const list = document.getElementById('presenceList');
                list.innerHTML = "";
                const data = snap.val() || {};
                ["admin", "bar", "cuisine", "menage", "service"].forEach(cat => {
                    list.innerHTML += `<div class="text-[#c5a059] font-bold border-b border-white/5 mt-4 mb-2 uppercase text-[9px] tracking-widest">${cat}</div>`;
                    equipeConfig.filter(m => m.t === cat).forEach(m => {
                        const key = m.n.replace(/\s+/g, '_').toUpperCase();
                        const isOk = data[key] && data[key].on;
                        const isRepos = staffRepos.includes(m.n.toUpperCase());
                        let statusTxt = isOk ? data[key].hA : (isRepos ? '<span class="text-orange-400">REPOS</span>' : '---');
                        list.innerHTML += `<div class="flex justify-between items-center py-1 opacity-${(isOk || isRepos)?'100':'40'}"><span>${m.n}</span><span>${statusTxt}</span></div>`;
                    });
                });
            });
        }
        function closeAdmin() { document.getElementById('adminPanel').classList.add('hidden'); }
        function resetUserMemory() { if(confirm("Changer de nom ?")) { localStorage.clear(); location.reload(); } }

        window.onload = fetchRepos;
    </script>
</body>
</html>
