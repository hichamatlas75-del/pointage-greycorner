<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pointage ‚Ä¢ Grey Corner F√®s</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fdfaf6; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(197, 160, 89, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        .btn-grey { background: #c5a059; transition: all 0.3s ease; }
        .btn-grey:disabled { background: #d1d5db; cursor: not-allowed; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #geoBtn, #submitBtn { display: none; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div class="glass-card p-10 rounded-[2.5rem] w-full max-w-md text-center">
        <div class="bg-amber-50 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-amber-100">
            <span class="text-3xl">üåø</span>
        </div>

        <h1 class="text-2xl font-bold text-slate-800 tracking-tight mb-1">Grey Corner F√®s</h1>
        
        <div id="geoStatus" class="inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-slate-100 text-slate-400 mb-8">
            S√©lectionnez votre nom
        </div>

        <div class="space-y-6">
            <div class="text-left">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-3 mb-2 block tracking-wider">√âquipier</label>
                <select id="staffSelect" onchange="chargerInfosPointage(this.value)" class="w-full p-4 rounded-2xl border-2 border-slate-50 bg-white text-slate-700 font-semibold focus:border-amber-500 outline-none transition-all shadow-sm">
                    <option value="">-- S√©lectionner --</option>
                </select>
            </div>

            <div id="actionArea">
                <button onclick="verifierPosition()" id="geoBtn" class="w-full bg-slate-800 text-white font-bold py-4 rounded-2xl mb-2 text-sm uppercase tracking-widest">
                    üìç V√©rifier ma position
                </button>
                <button onclick="validerPresence()" id="submitBtn" class="w-full btn-grey text-white font-bold py-5 rounded-2xl shadow-lg shadow-amber-100 uppercase tracking-widest text-sm">
                    Valider mon arriv√©e
                </button>
            </div>
        </div>

        <div id="msg" class="mt-8 text-sm font-medium hidden leading-relaxed"></div>
    </div>

    <audio id="zenSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const CAFE_LAT = 34.0343959; const CAFE_LON = -5.0155941;
        const RAYON_AUTORISE = 300; 

        const exceptionsGPS = ["ELGORRAMY_ANISSA", "ELMCHAOURI_SOUAD", "SBAI_HAKIMA", "KHALOUQ_RACHID"];
        const equipe = ["ALAOUI LAZIZ", "BELQASSE KHAOULA", "BENKHADA ABDESLAM", "BOURAHMA ANAS", "CHKAIRI YOUSSEF", "ELKOBBI MOSTAFA", "ELGORRAMY ANISSA", "ELGORRAMY SOUAD", "ELMCHAOURI SOUAD", "ENNHAIlI SOUMIA", "FILALI ABDERAFI", "GUETIBI AMINE", "HATTAF MOHAMED", "HIDARA YOUSSEF", "IDRISSI SAAD", "KAFOUNI ZAKARIAE", "KHALOUQ RACHID", "LEMSSIEH JAWAD", "MAJDOUB JIHANE", "MOUJAHID IMANE", "MOHSINE YOUNESS", "SALIL HOUDA", "SBAI HAKIMA", "ZAIR FATIMA"];

        let heurePrevueCachee = null;
        const select = document.getElementById('staffSelect');
        const submitBtn = document.getElementById('submitBtn');
        const geoBtn = document.getElementById('geoBtn');
        const geoStatus = document.getElementById('geoStatus');

        equipe.sort().forEach(name => {
            let opt = document.createElement('option');
            opt.value = name.replace(/\s+/g, '_').toUpperCase();
            opt.innerHTML = name;
            select.appendChild(opt);
        });

        async function chargerInfosPointage(val) {
            if (!val) { geoBtn.style.display = "none"; submitBtn.style.display = "none"; return; }

            // R√©cup√©ration de l'heure pr√©vue par le caissier
            const dateStr = new Date().toISOString().split('T')[0];
            const snap = await database.ref('presences/' + dateStr + '/' + val + '/hP').once('value');
            heurePrevueCachee = snap.val();

            if (exceptionsGPS.includes(val)) {
                geoStatus.innerHTML = "‚ú® Acc√®s Libre üåø";
                geoStatus.className = "inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-amber-100 text-amber-700 mb-8";
                geoBtn.style.display = "none";
                submitBtn.style.display = "block";
                submitBtn.disabled = false;
                submitBtn.style.opacity = "1";
            } else {
                geoStatus.innerHTML = "Localisation requise";
                geoStatus.className = "inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-slate-100 text-slate-400 mb-8";
                geoBtn.style.display = "block";
                submitBtn.style.display = "block";
                submitBtn.disabled = true;
                submitBtn.style.opacity = "0.5";
            }
        }

        function verifierPosition() {
            geoBtn.innerHTML = "V√©rification...";
            geoBtn.classList.add('pulse');
            navigator.geolocation.getCurrentPosition((pos) => {
                const d = getDistance(pos.coords.latitude, pos.coords.longitude, CAFE_LAT, CAFE_LON);
                geoBtn.classList.remove('pulse');
                if (d <= RAYON_AUTORISE) {
                    geoStatus.innerHTML = "‚úÖ Zone Grey Corner";
                    geoStatus.className = "inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-green-100 text-green-700 mb-8";
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = "1";
                    geoBtn.style.display = "none";
                } else { alert("üìç Trop loin."); geoBtn.innerHTML = "üìç R√©essayer"; }
            }, (err) => alert("‚ö†Ô∏è Activez le GPS."), { enableHighAccuracy: true });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180; const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180; const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function validerPresence() {
            const user = select.value;
            submitBtn.disabled = true;
            submitBtn.innerHTML = "Certification...";

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            let estEnRetard = false;
            if (heurePrevueCachee) {
                const [h, m] = heurePrevueCachee.split(':').map(Number);
                const minutesNow = now.getHours() * 60 + now.getMinutes();
                const minutesCible = h * 60 + m;
                if (minutesNow > (minutesCible + 5)) estEnRetard = true;
            }

            database.ref('presences/' + dateStr + '/' + user).update({
                on: true, hA: timeStr, retard: estEnRetard, timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('zenSound').play();
                const msg = document.getElementById('msg');
                msg.innerHTML = estEnRetard ? `‚è≥ Arriv√©e enregistr√©e (${timeStr}). <br> Note : Retard.` : `‚ú® Merci ! <br> Arriv√©e certifi√©e √† ${timeStr}.`;
                msg.className = "mt-8 p-4 rounded-2xl font-bold block " + (estEnRetard ? "bg-orange-50 text-orange-700" : "bg-green-50 text-green-700");
                msg.style.display = "block";
                setTimeout(() => location.reload(), 3500);
            });
        }
    </script>
</body>
</html>
