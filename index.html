<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pointage Certifi√© ‚Ä¢ Grey Corner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fdfaf6; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(197, 160, 89, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        .btn-grey { background: #c5a059; transition: all 0.3s ease; }
        .btn-grey:disabled { background: #d1d5db; cursor: not-allowed; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div class="glass-card p-10 rounded-[2.5rem] w-full max-w-md text-center">
        <div class="bg-amber-50 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-amber-100">
            <span class="text-3xl">üåø</span>
        </div>

        <h1 class="text-2xl font-bold text-slate-800 tracking-tight mb-1">Grey Corner F√®s</h1>
        
        <div id="geoStatus" class="inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-slate-100 text-slate-400 mb-8">
            Initialisation GPS...
        </div>

        <div class="space-y-6">
            <div class="text-left">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-3 mb-2 block tracking-wider">Identit√© de l'√©quipier</label>
                <select id="staffSelect" class="w-full p-4 rounded-2xl border-2 border-slate-50 bg-white text-slate-700 font-semibold focus:border-amber-500 outline-none transition-all shadow-sm">
                    <option value="">-- Choisir --</option>
                </select>
            </div>
            <button onclick="validerPresence()" id="submitBtn" disabled class="w-full btn-grey text-white font-bold py-5 rounded-2xl shadow-lg shadow-amber-100 uppercase tracking-widest text-sm">
                V√©rification du lieu...
            </button>
        </div>

        <div id="msg" class="mt-8 text-sm font-medium hidden leading-relaxed"></div>

        <footer class="mt-12 pt-6 border-t border-slate-50">
            <p class="text-[9px] text-slate-400 uppercase font-bold tracking-[0.3em]">Ouverture 06:30 ‚Ä¢ Famille Grey Corner</p>
        </footer>
    </div>

    <audio id="zenSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const CAFE_LAT = 34.0343959; 
        const CAFE_LON = -5.0155941;
        const RAYON_AUTORISE = 150; 

        // üÜî G√âN√âRER UN ID UNIQUE POUR CE T√âL√âPHONE
        const deviceId = btoa(navigator.userAgent + screen.width + navigator.hardwareConcurrency).substring(0, 20);

        const equipe = ["SALIL HOUDA", "BENKHADA ABDESLAM", "ENNHAIlI SOUMIA", "EL KOBBI MOSTAFA", "CHKAIRI YOUSSEF", "KHALOUQ RACHID", "FILALI ABDERAFI", "SBAI HAKIMA", "ELGORRAMY SOUAD", "ELGORRAMY ANISSA", "ELMCHAOURI SOUAD", "ZAIR FATIMA", "BELQASSE KHAOULA", "MAJDOUB JIHANE", "LEMSSIEH JAWAD", "BOURAHMA ANAS", "MOUJAHID IMANE", "IDRISSI SAAD", "GUETIBI AMINE", "EL MOEDEN HASSAN", "HIDARA YOUSSEF", "ALAOUI LAZIZ", "HATTAF MOHAMED", "MOHSINE YOUNESS"];

        const select = document.getElementById('staffSelect');
        const btn = document.getElementById('submitBtn');
        const geoStatus = document.getElementById('geoStatus');

        equipe.sort().forEach(name => {
            let opt = document.createElement('option');
            opt.value = name.replace(/\s+/g, '_');
            opt.innerHTML = name;
            select.appendChild(opt);
        });

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180; const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180; const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function verifierPosition() {
            navigator.geolocation.getCurrentPosition((pos) => {
                const d = getDistance(pos.coords.latitude, pos.coords.longitude, CAFE_LAT, CAFE_LON);
                if (d <= RAYON_AUTORISE) {
                    geoStatus.innerHTML = "‚úÖ Bienvenue au Grey Corner";
                    geoStatus.className = "inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-green-100 text-green-700 mb-8";
                    btn.disabled = false;
                    btn.innerHTML = "Valider mon arriv√©e";
                } else {
                    geoStatus.innerHTML = "üìç Hors du Caf√©";
                    btn.innerHTML = "Approchez-vous du caf√©";
                }
            }, null, { enableHighAccuracy: true });
        }

        async function validerPresence() {
            const user = select.value;
            if(!user) return alert("S√©lectionnez votre nom");

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            btn.disabled = true;

            // üîí S√âCURIT√â : V√âRIFIER SI LE T√âL√âPHONE A D√âJ√Ä POINT√â QUELQU'UN
            const dailyDevicesRef = database.ref('security/' + dateStr);
            const devSnap = await dailyDevicesRef.once('value');
            const devicesUsedToday = devSnap.val() || {};

            // Si cet identifiant de t√©l√©phone existe d√©j√† pour une autre personne
            for (let name in devicesUsedToday) {
                if (devicesUsedToday[name] === deviceId && name !== user) {
                    alert("‚ùå Un seul pointage par t√©l√©phone autoris√©. Merci d'utiliser votre propre appareil.");
                    btn.disabled = false;
                    btn.innerHTML = "Acc√®s refus√©";
                    return;
                }
            }

            const snap = await database.ref('presences/' + dateStr + '/' + user).once('value');
            if (snap.exists() && snap.val().hA) {
                alert("Vous avez d√©j√† point√© !");
                return;
            }

            // Enregistrement
            database.ref('presences/' + dateStr + '/' + user).update({
                on: true, hA: timeStr, device: deviceId
            }).then(() => {
                dailyDevicesRef.update({ [user]: deviceId }); // Marquer ce t√©l√©phone comme utilis√© par cet employ√©
                document.getElementById('zenSound').play();
                msg.innerHTML = `‚ú® Merci ! <br> Arriv√©e certifi√©e √† <span class="text-amber-600">${timeStr}</span>.`;
                msg.className = "mt-8 p-4 bg-green-50 text-green-700 rounded-2xl font-bold block border border-green-100";
                msg.style.display = "block";
                setTimeout(() => location.reload(), 4000);
            });
        }
        window.onload = verifierPosition;
    </script>
</body>
</html>
