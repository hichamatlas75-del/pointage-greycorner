<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grey Corner ‚Ä¢ Pointage Certifi√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        /* Th√®me sombre et pro */
        html, body { 
            height: 100%; margin: 0; overflow: hidden; 
            background: #1e293b; /* Bleu Ardoise Fonc√© */
            font-family: 'Plus Jakarta Sans', sans-serif; 
        }
        
        .main-container { 
            height: 100vh; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; padding: 1rem; 
        }

        /* Carte avec effet de verre */
        .glass-card { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); 
            width: 100%; max-width: 380px; height: 92vh; 
            border-radius: 2rem; padding: 1.5rem;
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .admin-reset {
            position: absolute; top: 20px; right: 20px;
            padding: 6px 10px; border-radius: 8px;
            background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2);
            color: #f87171; font-size: 9px; font-weight: 800;
            cursor: pointer; z-index: 100; text-transform: uppercase;
        }

        .staff-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            overflow-y: auto; flex-grow: 1; padding: 5px; margin-bottom: 10px;
        }

        /* Titres de cat√©gories plus √©l√©gants */
        .category-title {
            grid-column: span 2;
            font-size: 11px; font-weight: 700; color: #94a3b8;
            text-transform: uppercase; letter-spacing: 0.15em;
            padding: 15px 0 5px 0;
            margin-top: 5px;
        }

        /* Style des pastilles (boutons) */
        .btn-staff { 
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 55px; font-size: 10px; font-weight: 700; 
            border-radius: 14px; text-transform: uppercase; 
            display: flex; align-items: center; justify-content: center; 
            text-align: center; color: #e2e8f0;
            transition: all 0.2s ease;
        }

        .btn-staff.selected { 
            border-color: #c5a059; 
            background: rgba(197, 160, 89, 0.2); 
            color: #fcd34d;
            box-shadow: 0 0 15px rgba(197, 160, 89, 0.3);
        }

        /* Subtiles touches de couleur sur le c√¥t√© gauche des boutons */
        .type-admin { border-left: 4px solid #f472b6; }
        .type-bar { border-left: 4px solid #818cf8; }
        .type-cuisine { border-left: 4px solid #f87171; }
        .type-menage { border-left: 4px solid #34d399; }
        .type-service { border-left: 4px solid #60a5fa; }

        .confirm-zone { 
            display: flex; flex-direction: column; gap: 10px; 
            padding: 15px 0; border-top: 1px solid rgba(255, 255, 255, 0.1); 
        }

        .btn-main {
            background: #c5a059;
            color: #1e293b; font-weight: 800; padding: 18px; border-radius: 16px;
            text-transform: uppercase; font-size: 13px;
            transition: transform 0.1s active;
        }

        .btn-main:disabled { background: #334155; color: #64748b; }

        .logo-img { 
            height: 50px; width: auto; object-fit: contain; 
            margin: 0 auto 15px auto; filter: brightness(0) invert(1); /* Rend le logo blanc si n√©cessaire */
        }

        .staff-grid::-webkit-scrollbar { width: 0px; }
        
        #statusLabel {
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="glass-card">
            <div class="admin-reset" onclick="adminResetDevice()">RESET</div>
            <img src="images/LOGO GREY CORNER.png" alt="Logo" class="logo-img">
            
            <div id="statusLabel" class="text-center px-3 py-3 rounded-xl text-[10px] font-bold uppercase tracking-widest mb-4 min-h-[40px] flex items-center justify-center border border-white/5">
                S√©lectionnez votre nom
            </div>
            
            <div id="staffGrid" class="staff-grid"></div>

            <div class="confirm-zone">
                <button onclick="validerPresence()" id="submitBtn" class="btn-main w-full" disabled>Confirmer le pointage</button>
            </div>
            <div id="msg" class="mt-2 text-[11px] font-bold hidden p-3 rounded-xl text-center"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const CAFE_LAT = 34.0343959; const CAFE_LON = -5.0155941; const RAYON_AUTORISE = 300; 

        // Logique JS conserv√©e telle quelle pour ne pas casser tes fonctionnalit√©s
        function getPersistentToken(userName) {
            let key = "gc_token_" + userName;
            let token = localStorage.getItem(key);
            if (!token) {
                token = 'GC-' + Math.random().toString(36).substr(2, 9).toUpperCase() + '-' + Date.now();
                localStorage.setItem(key, token);
            }
            return token;
        }

        const equipeConfig = [
            {n: "ALAOUI LAZIZ", t: "service"}, {n: "BELQASSE KHAOULA", t: "cuisine"},
            {n: "BENKHADA ABDESLAM", t: "admin"}, {n: "BOURAHMA ANAS", t: "cuisine"},
            {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"},
            {n: "ELGORRAMY ANISSA", t: "menage", ex: true}, {n: "ELGORRAMY SOUAD", t: "menage"},
            {n: "ELMCHAOURI SOUAD", t: "menage", ex: true}, {n: "ENNHAILI SOUMIA", t: "admin"},
            {n: "FILALI ABDERAFI", t: "bar"}, {n: "GUETIBI AMINE", t: "service"},
            {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"},
            {n: "IDRISSI SAAD", t: "cuisine"}, {n: "KAFOUNI ZAKARIAE", t: "service"},
            {n: "KHALOUQ RACHID", t: "bar", ex: true}, {n: "LEMSSIEH JAWAD", t: "cuisine"},
            {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"},
            {n: "MOHSINE YOUNESS", t: "service"}, {n: "SALIL HOUDA", t: "admin"},
            {n: "SBAI HAKIMA", t: "menage", ex: true}, {n: "ZAIR FATIMA", t: "cuisine"}
        ];

        window.onload = function() {
            const lastUser = localStorage.getItem('gc_last_user');
            if (lastUser) {
                const buttons = document.querySelectorAll('.btn-staff');
                buttons.forEach(btn => {
                    if (btn.innerHTML === lastUser.replace(/_/g, ' ')) {
                        btn.click();
                    }
                });
            }
        };

        const libellesFonctions = { "admin": "Caisse et √âconomat", "bar": "Bar", "cuisine": "Cuisine", "menage": "M√©nage", "service": "Service" };
        const ordreFonctions = { "admin": 1, "bar": 2, "cuisine": 3, "menage": 4, "service": 5 };

        let selectedUser = null; 
        const grid = document.getElementById('staffGrid');
        const submitBtn = document.getElementById('submitBtn');
        const statusLabel = document.getElementById('statusLabel');

        let currentCat = "";
        equipeConfig.sort((a, b) => ordreFonctions[a.t] - ordreFonctions[b.t] || a.n.localeCompare(b.n)).forEach(emp => {
            if (emp.t !== currentCat) {
                currentCat = emp.t;
                const title = document.createElement('div');
                title.className = "category-title";
                title.innerHTML = libellesFonctions[currentCat] || currentCat;
                grid.appendChild(title);
            }
            const btn = document.createElement('button');
            btn.className = `btn-staff type-${emp.t}`;
            btn.innerHTML = emp.n;
            btn.onclick = () => s√©lectionnerEmploy√©(btn, emp);
            grid.appendChild(btn);
        });

        async function s√©lectionnerEmploy√©(element, emp) {
            document.querySelectorAll('.btn-staff').forEach(b => b.classList.remove('selected'));
            element.classList.add('selected');
            selectedUser = emp.n.trim().replace(/\s+/g, '_').toUpperCase();
            localStorage.setItem('gc_last_user', selectedUser);
            
            const dateStr = new Date().toISOString().split('T')[0];
            const snap = await database.ref('presences/' + dateStr + '/' + selectedUser).once('value');
            
            if (snap.val() && snap.val().on === true) {
                submitBtn.disabled = true; 
                statusLabel.innerHTML = "D√âJ√Ä POINT√â AUJOURD'HUI";
                statusLabel.style.color = "#34d399";
                return; 
            }

            if (emp.ex) {
                statusLabel.innerHTML = "‚ú® Acc√®s Libre üåø";
                statusLabel.style.color = "#fbbf24";
                submitBtn.disabled = false;
            } else {
                activerGPSAutomatique();
            }
        }

        function activerGPSAutomatique() {
            statusLabel.innerHTML = "üîç V√©rification GPS...";
            navigator.geolocation.getCurrentPosition((pos) => {
                if (getDistance(pos.coords.latitude, pos.coords.longitude, CAFE_LAT, CAFE_LON) <= RAYON_AUTORISE) {
                    statusLabel.innerHTML = "‚úÖ Zone Grey Corner Valid√©e";
                    statusLabel.style.color = "#34d399";
                    submitBtn.disabled = false;
                } else { alert("Vous n'√™tes pas au caf√©."); resetSelection(); }
            }, (err) => { alert("Activez votre GPS."); resetSelection(); }, { enableHighAccuracy: true });
        }

        function adminResetDevice() {
            if (!selectedUser) return alert("S√©lectionnez d'abord un nom.");
            if (confirm("R√©initialiser le pointage ?")) {
                const dateStr = new Date().toISOString().split('T')[0];
                database.ref('users/' + selectedUser).remove();
                localStorage.removeItem("gc_token_" + selectedUser);
                database.ref('presences/' + dateStr + '/' + selectedUser).remove().then(() => {
                    location.reload();
                });
            }
        }

        async function validerPresence() {
            if (!selectedUser) return;
            submitBtn.disabled = true;
            const currentToken = getPersistentToken(selectedUser);
            const userRef = database.ref('users/' + selectedUser);
            const userSnap = await userRef.once('value');
            const storedToken = userSnap.val() ? userSnap.val().token : null;

            if (storedToken && storedToken !== currentToken) {
                alert("‚ö†Ô∏è Appareil non autoris√©.");
                submitBtn.disabled = false; return;
            }

            if (!storedToken) await userRef.set({ token: currentToken });

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            database.ref('presences/' + dateStr + '/' + selectedUser).update({
                on: true, 
                hA: now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('msg').innerHTML = "Pointage valid√© !";
                document.getElementById('msg').className = "mt-2 p-3 font-bold block bg-green-500/20 text-green-400";
                document.getElementById('msg').style.display = "block";
                setTimeout(() => location.reload(), 2000);
            });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180; const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180; const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function resetSelection() {
            selectedUser = null;
            document.querySelectorAll('.btn-staff').forEach(b => b.classList.remove('selected'));
            statusLabel.innerHTML = "S√©lectionnez votre nom";
            statusLabel.style.color = "#94a3b8";
            submitBtn.disabled = true;
        }
    </script>
</body>
</html>
