<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grey Corner • Master Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
<style>
    html,body{height:100%;margin:0;overflow:hidden;background:radial-gradient(circle at top,#111827 0%,#020617 100%);font-family:'Plus Jakarta Sans',sans-serif;}
    .card{width:100%;max-width:420px;height:96vh;background:linear-gradient(180deg,#0b0e14,#030712);border-radius:40px;padding:18px;box-shadow:0 0 60px rgba(212,175,55,.25);border:1px solid rgba(212,175,55,.25);position:relative;display:flex;flex-direction:column;}
    .gold{color:#d4af37}
    .btn-main{background:linear-gradient(180deg,#f5d776,#b8942e);color:#111;font-weight:900;border-radius:28px;padding:25px;font-size:24px;box-shadow:0 10px 30px rgba(212,175,55,0.3)}
    .status-box{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:30px;padding:25px;text-align:center;}
    .ticker{display:none;border-radius:12px;padding:12px;font-weight:700;font-size:13px;margin-bottom:12px;text-align:center}
    .msg-urgent{background:#7f1d1d;color:#fff;border:1px solid #ef4444;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
</style>
</head>
<body class="flex items-center justify-center p-4">
<div class="card">
    <div class="text-center mb-4 flex-shrink-0">
        <img src="images/LOGO GREY CORNER.png" onclick="askAdmin()" class="h-14 mx-auto cursor-pointer">
    </div>

    <div id="ticker" class="ticker"></div>

    <div id="app-pointage" class="flex flex-col flex-grow overflow-hidden">
        <div id="selection" class="overflow-y-auto">
             <div class="text-center text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-4">Identification Staff</div>
             </div>

        <div id="action" class="hidden flex flex-col flex-grow justify-center">
            <div id="username" class="text-3xl font-black text-yellow-200 text-center mb-8">--</div>
            
            <div id="pointage-zone" class="status-box">
                <div id="gps-status" class="text-[10px] mb-4 text-gray-500 uppercase tracking-widest italic">Localisation en cours...</div>
                <button id="btn" class="btn-main w-full" disabled>Valider Présence</button>
            </div>

            <button onclick="localStorage.clear();location.reload();" class="mt-12 text-[9px] text-gray-600 uppercase tracking-widest">Changer d'utilisateur</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={databaseURL:"https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const CAFE_LAT=34.0343959, CAFE_LON=-5.0155941, RAYON_MAX=200;
let selected=localStorage.getItem('gc_staff_name');
const dateStr=new Intl.DateTimeFormat('fr-CA',{timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());

function keyStaff(n){ return String(n||'').trim().replace(/\s+/g, '_').toUpperCase(); }

// Logique de calcul HA - HP
function computeRetard(hA, hP) {
    if(!hP) return null;
    const [haH, haM] = hA.split(':').map(Number);
    const [hph, hpm] = hP.split(':').map(Number);
    const diff = (haH * 60 + haM) - (hph * 60 + hpm);
    return diff > 0; // Retard si la différence est positive
}

function init() {
    if (selected) {
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
        document.getElementById('username').innerText = selected;
        checkGPS();
        
        // Surveillance temps réel (Ecoute si Admin entre le HP manuel)
        db.ref('presences/'+dateStr+'/'+keyStaff(selected)).on('value', s => {
            const val = s.val();
            if(val && val.hA) {
                let html = `<p class="text-emerald-400 font-black text-2xl mb-1">POINTÉ ✅</p>
                            <p class="text-white/60 text-[10px] uppercase mb-4">Arrivée : ${val.hA}</p>`;
                
                if(val.hP) {
                    const retard = computeRetard(val.hA, val.hP);
                    html += retard 
                        ? `<p class="text-red-500 font-bold text-sm bg-red-500/10 py-2 rounded-xl">⚠️ RETARD CONSTATÉ</p>`
                        : `<p class="text-emerald-500 font-bold text-sm bg-emerald-500/10 py-2 rounded-xl">DANS LES TEMPS ✓</p>`;
                    
                    // On met à jour le statut retard dans Firebase automatiquement
                    if(val.retard !== retard) {
                        db.ref('presences/'+dateStr+'/'+keyStaff(selected)).update({retard: retard});
                    }
                } else {
                    html += `<p class="text-gray-500 italic text-[9px] border-t border-white/5 pt-4">En attente de validation du planning par la direction...</p>`;
                }
                document.getElementById('pointage-zone').innerHTML = html;
            }
        });
    } else {
        genererListeUI();
    }
}

document.getElementById('btn').onclick=()=>{
    const t=new Date();
    const hA = t.getHours().toString().padStart(2,'0')+":"+t.getMinutes().toString().padStart(2,'0');
    
    // Premier enregistrement de HA
    db.ref('presences/'+dateStr+'/'+keyStaff(selected)).update({
        on:true, 
        hA:hA, 
        timestamp:firebase.database.ServerValue.TIMESTAMP
    });
};

// ... (GPS et UI identiques pour la stabilité)
function checkGPS(){ navigator.geolocation.getCurrentPosition(p=>{ const d=getDist(p.coords.latitude,p.coords.longitude,CAFE_LAT,CAFE_LON); if(d<=RAYON_MAX){ document.getElementById('gps-status').innerHTML=`<span class="text-green-400 font-bold">ZONE VALIDÉE ✓</span>`; document.getElementById('btn').disabled=false; } else { document.getElementById('gps-status').innerHTML=`<span class="text-red-400 font-bold">HORS ZONE (${Math.round(d)}m)</span>`; } }, null, {enableHighAccuracy:true}); }
function getDist(a,b,c,d){ const R=6371e3; const dLat=(c-a)*Math.PI/180; const dLon=(d-b)*Math.PI/180; const q=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q)); }
function genererListeUI() { const sel = document.getElementById('selection'); const equipe = [{n: "BENKHADA ABDESLAM", t: "caisse"}, {n: "ENNHAILI SOUMIA", t: "caisse"}, {n: "SALIL HOUDA", t: "caisse"}, {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"}, {n: "FILALI ABDERAFI", t: "bar"}, {n: "KHALOUQ RACHID", t: "bar"}, {n: "BELQASSE KHAOULA", t: "cuisine"}, {n: "BOURAHMA ANAS", t: "cuisine"}, {n: "IDRISSI SAAD", t: "cuisine"}, {n: "LEMSSIEH JAWAD", t: "cuisine"}, {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"}, {n: "ZAIR FATIMA", t: "cuisine"}, {n: "ELGORRAMY ANISSA", t: "menage"}, {n: "ELGORRAMY SOUAD", t: "menage"}, {n: "ELMCHAOURI SOUAD", t: "menage"}, {n: "SBAI HAKIMA", t: "menage"}, {n: "ALAOUI LAZIZ", t: "service"}, {n: "GUETIBI AMINE", t: "service"}, {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"}, {n: "KAFOUNI ZAKARIAE", t: "service"}, {n: "MOHSINE YOUNESS", t: "service"}]; equipe.forEach(emp => { const b = document.createElement('button'); b.className="w-full p-4 mb-2 bg-white/5 border border-white/10 rounded-2xl text-left text-xs text-white"; b.innerText = emp.n; b.onclick = () => { if(confirm(emp.n + " ?")) { localStorage.setItem('gc_staff_name', emp.n); location.reload(); }}; sel.appendChild(b); }); }

init();
</script>
</body>
</html>
