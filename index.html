<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Grey Corner ‚Ä¢ Master Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet" />

<style>
  html,body{
    height:100%;
    margin:0;
    overflow-y:auto;
    overflow-x:hidden;
    background:
      radial-gradient(1200px 600px at 50% -10%, rgba(255,180,60,0.08), transparent 60%),
      linear-gradient(180deg,#02040a,#050816 40%,#02040a);
    font-family:'Plus Jakarta Sans',sans-serif;
    color:#e5e7eb;
  }
  .card{
    width:100%;
    max-width:420px;
    min-height:96vh;
    border-radius:42px;
    padding:18px;
    display:flex;
    flex-direction:column;
    background:linear-gradient(145deg,rgba(20,23,35,.75),rgba(5,7,15,.85));
    backdrop-filter:blur(18px);
    -webkit-backdrop-filter:blur(18px);
    border:1px solid rgba(255,255,255,.08);
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,.04),
      0 40px 80px rgba(0,0,0,.8),
      0 0 40px rgba(255,170,60,.08);
    position:relative;
  }

  .gold{ color:#ffcc73; letter-spacing:.08em; }
  .muted{ color:rgba(229,231,235,.65); }

  .scroll{ overflow-y:auto; scrollbar-width:none; }
  .scroll::-webkit-scrollbar{ display:none }

  .btn-planning{
    background: linear-gradient(180deg,#2F7BFF,#1A4ED8) !important;
    border:1px solid rgba(255,255,255,.15) !important;
    color:#ffffff !important;
    padding:16px 14px;
    border-radius:22px;
    font-size:12px;
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.06em;
    width:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    box-shadow:0 14px 30px rgba(0,0,0,.45), inset 0 -3px 0 rgba(0,0,0,.25);
    transition:.25s;
  }
  .btn-planning:hover{ background: linear-gradient(180deg,#4C90FF,#2F7BFF) !important; }
  .btn-planning:active{ transform:scale(.98); }

  .btn-ramadan{
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    color:rgba(229,231,235,.92);
    padding:12px 14px;
    border-radius:18px;
    font-size:11px;
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.06em;
    width:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    box-shadow:0 10px 22px rgba(0,0,0,.35);
    transition:.2s;
  }
  .btn-ramadan:hover{ background: rgba(255,255,255,.08); border-color: rgba(255,204,115,.22); }
  .btn-ramadan:active{ transform:scale(.99); }

  .btn-main{
    background: linear-gradient(180deg,#ffd68a,#ffb347);
    color:#1a1305;
    font-weight:900;
    border-radius:26px;
    padding:26px;
    font-size:26px;
    box-shadow: 0 12px 25px rgba(255,170,60,.35), inset 0 -3px 0 rgba(0,0,0,.25);
    transition:.25s;
  }
  .btn-main:disabled{ opacity:.45; filter:saturate(.7); }
  .btn-main:active{ transform:scale(.97); }

  /* ‚úÖ BANDEAU (utilis√© apr√®s login) */
  .banner-wrap{
    display:none;
    gap:10px;
    align-items:stretch;
    margin:12px 0 12px 0;
    position:sticky;
    top:0;
    z-index:20;
    background:linear-gradient(180deg,rgba(2,4,10,.95),rgba(2,4,10,.70));
    backdrop-filter:blur(8px);
    -webkit-backdrop-filter:blur(8px);
    padding-top:6px;
    padding-bottom:6px;
    border-radius:18px;
  }
  .banner{
    flex:1;
    border-radius:16px;
    padding:12px 14px;
    font-weight:900;
    font-size:13px;
    line-height:1.25;
    text-align:center;
    border:1px solid rgba(255,255,255,.10);
    transition: all .22s ease;
    word-break:break-word;
    overflow-wrap:anywhere;
  }
  .btn-refresh{
    width:44px;
    min-width:44px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.05);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    transition:.2s;
    user-select:none;
  }
  .btn-refresh:hover{ background:rgba(255,255,255,.08); border-color:rgba(255,204,115,.28); }
  .btn-refresh:active{ transform:scale(.98); }
  .spin{ animation:spin .8s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  .msg-info{
    background:rgba(255,200,120,.10);
    color:#ffd68a;
    border:1px solid rgba(255,200,120,.28);
  }
  .msg-urgent{
    background:#3a0d0d;
    color:#fff;
    border:1px solid #ff5a5a;
  }
  .flash-gold{ animation:flashGold 1.2s infinite; }
  @keyframes flashGold{
    0%,100%{ box-shadow:0 0 0 rgba(255,204,115,0); filter:saturate(1); opacity:1; }
    50%{ box-shadow:0 0 18px rgba(255,204,115,.35), 0 0 40px rgba(255,179,71,.18); filter:saturate(1.25); opacity:.88; }
  }
  .flash-brick{ animation:flashBrick .9s infinite; }
  @keyframes flashBrick{
    0%,100%{ box-shadow:0 0 0 rgba(255,90,90,0); opacity:1; }
    50%{ box-shadow:0 0 18px rgba(255,90,90,.35), 0 0 42px rgba(160,30,30,.25); opacity:.78; }
  }

  /* ‚úÖ Message accueil (sous login) */
  .home-msg{
    display:none;
    margin:10px 0 12px 0;
    padding:12px 12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.05);
  }
  .home-msg .title{
    font-size:10px;
    font-weight:900;
    letter-spacing:.10em;
    text-transform:uppercase;
    color:rgba(229,231,235,.65);
    margin-bottom:6px;
  }
  .home-msg .content{
    font-size:12px;
    font-weight:900;
    line-height:1.25;
    word-break:break-word;
    overflow-wrap:anywhere;
  }
  .home-info{
    background:rgba(255,200,120,.10);
    color:#ffd68a;
    border:1px solid rgba(255,200,120,.28);
  }
  .home-urgent{
    background:#3a0d0d;
    color:#fff;
    border:1px solid #ff5a5a;
  }

  .drawer-header{
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.06);
    border-radius:16px;
    padding:14px;
    margin-top:10px;
    display:flex;
    justify-content:space-between;
    cursor:pointer;
    transition:.2s;
    user-select:none;
  }
  .drawer-header:hover{ background:rgba(255,255,255,.07); }

  .staff-btn{
    padding:14px;
    border-radius:14px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.06);
    font-size:11px;
    font-weight:800;
    transition:.15s;
    text-align:center;
  }
  .staff-btn:hover{
    background:rgba(255,180,60,.12);
    border:1px solid rgba(255,180,60,.35);
    transform:translateY(-1px);
  }

  .btn-reset-indiv{
    background:rgba(239,68,68,.18);
    color:#ff9b9b;
    padding:6px 10px;
    border-radius:10px;
    font-size:12px;
    font-weight:900;
    border:1px solid rgba(239,68,68,.25);
  }
  .btn-reset-all{
    background:#2a0f0f;
    color:#ff9090;
    border:1px solid #6b1f1f;
    padding:12px;
    border-radius:15px;
    font-size:11px;
    font-weight:900;
    text-transform:uppercase;
    width:100%;
    margin-top:10px;
  }

  .punch-counter{
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    padding:10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin:0 0 10px 0;
  }
  .punch-counter .label{
    font-size:10px;
    font-weight:900;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:rgba(229,231,235,.70);
    white-space:nowrap;
  }
  .punch-counter .val{
    font-size:12px;
    font-weight:900;
    color:#ffd68a;
  }

  /* LOGIN */
  .login-card{
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    border-radius:22px;
    padding:14px;
    margin:0 0 0 0;
  }
  .inpt{
    width:100%;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    padding:12px 12px;
    color:#fff;
    font-weight:800;
    font-size:12px;
    outline:none;
  }
  .inpt:focus{ border-color: rgba(255,204,115,.35); box-shadow: 0 0 0 3px rgba(255,204,115,.12); }
  .btn-login{
    width:100%;
    border-radius:18px;
    padding:12px 14px;
    font-size:12px;
    font-weight:900;
    letter-spacing:.08em;
    text-transform:uppercase;
    background:rgba(255,204,115,.18);
    border:1px solid rgba(255,204,115,.28);
    color:#ffd68a;
  }
  .btn-login:active{ transform:scale(.99); }

  /* Toast */
  .toast{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:18px;
    z-index:9999;
    background:rgba(0,0,0,.70);
    border:1px solid rgba(255,255,255,.12);
    color:#fff;
    padding:10px 12px;
    border-radius:14px;
    font-size:12px;
    font-weight:900;
    display:none;
    max-width:min(420px, calc(100vw - 24px));
    text-align:center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
</style>
</head>

<body class="flex items-center justify-center p-4">
  <div class="card">
    <div class="text-center mb-4 flex-shrink-0">
      <img id="logo" src="images/LOGO GREY CORNER.png" class="h-14 mx-auto cursor-pointer" alt="Grey Corner" />
    </div>

    <!-- ‚úÖ LOGIN -->
    <div id="loginWrap" class="login-card">
      <div class="text-[10px] font-black uppercase tracking-widest muted mb-2">Connexion</div>
      <div class="space-y-2">
        <input id="loginEmail" class="inpt" type="email" placeholder="Email" autocomplete="username" />
        <input id="loginPass" class="inpt" type="password" placeholder="Mot de passe" autocomplete="current-password" />
        <button id="btnLogin" class="btn-login">Se connecter</button>
        <div id="loginMsg" class="text-[10px] font-black text-red-300"></div>
      </div>
    </div>

    <!-- ‚úÖ MSG SHEET EN PAGE D'ACCUEIL (SOUS LOGIN, AVANT CONNEXION) -->
    <div id="homeMsg" class="home-msg">
      <div class="title">Message du jour</div>
      <div id="homeMsgContent" class="content">Chargement‚Ä¶</div>
    </div>

    <!-- ‚úÖ Barre session -->
    <div id="sessionBar" class="hidden mb-3 flex items-center justify-between gap-2">
      <div class="text-[10px] font-black uppercase tracking-widest muted">
        Connect√© : <span id="roleLabel" class="text-yellow-200">‚Äî</span>
      </div>
      <button id="btnLogout" class="text-[10px] font-black px-3 py-2 rounded-full border border-white/10 bg-white/5">
        D√©connexion
      </button>
    </div>

    <!-- ‚úÖ Planning -->
    <button onclick="window.open('https://grey-corner-app.pages.dev/', '_blank')" class="btn-planning mb-2">
      <span style="font-size:16px; line-height:1">üóìÔ∏è</span>
      <span>CONSULTER LE PLANNING</span>
    </button>

    <!-- ‚úÖ Menu Ramadan -->
    <button onclick="window.open('https://ramadan-greycorner.pages.dev/', '_blank')" class="btn-ramadan mb-3">
      <span style="font-size:16px; line-height:1">üåô</span>
      <span>MENU RAMADAN</span>
    </button>

    <!-- ‚úÖ Compteur -->
    <div id="punch-counter" class="punch-counter hidden">
      <div class="label">D√©j√† point√©s</div>
      <div class="val"><span id="punch-count">0</span> / <span id="punch-total">0</span></div>
    </div>

    <!-- ‚úÖ Bandeau (apr√®s login) -->
    <div id="banner-wrap" class="banner-wrap">
      <div id="banner" class="banner"></div>
      <div id="btn-refresh" class="btn-refresh" title="Actualiser le message">
        <span id="refresh-ico" style="font-size:18px; line-height:1">‚ü≥</span>
      </div>
    </div>

    <!-- APP POINTAGE -->
    <div id="app-pointage" class="flex flex-col flex-grow overflow-hidden hidden">
      <div id="selection" class="scroll flex-grow">
        <div class="text-center text-[10px] muted uppercase font-black tracking-widest mb-2">Choisi ton nom</div>
      </div>

      <div id="action" class="hidden flex flex-col flex-grow justify-center">
        <div id="retard-panel" class="text-center mb-2 hidden">
          <div class="inline-flex px-3 py-2 rounded-2xl border border-white/10 bg-white/5">
            <div id="day-retard-text" class="text-[10px] font-black text-white/80">‚è±Ô∏è Retard jour : --</div>
          </div>
        </div>

        <div id="username" class="text-3xl font-black text-yellow-200 text-center mb-6">--</div>

        <div id="pointage-zone">
          <div id="status" class="text-center text-[10px] mb-4 muted uppercase tracking-widest">Localisation GPS...</div>
          <button id="btn" class="btn-main w-full" disabled>Valider mon Arriv√©e</button>
        </div>

        <button onclick="localStorage.clear();location.reload();" class="mt-12 text-[9px] text-gray-400/40 uppercase tracking-widest">
          Retour au menu
        </button>
      </div>
    </div>

    <!-- APP ADMIN (GERANT) -->
    <div id="app-admin" class="hidden flex flex-col flex-grow overflow-hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="gold font-black uppercase text-sm italic">Supervision (G√©rant)</h2>
        <button onclick="location.reload()" class="text-white text-xs bg-red-900/40 px-3 py-1 rounded-full text-[10px] font-black border border-white/10">
          Fermer
        </button>
      </div>

      <div id="adminList" class="scroll flex-grow bg-white/5 rounded-2xl p-2 border border-white/10"></div>
      <button id="btnResetAll" class="btn-reset-all">üîÑ Reset Global (Tous les mobiles)</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ‚úÖ M√™me config que "Pr√©sences"
    const firebaseConfig = {
      apiKey: "AIzaSyC5al_6xWbJC8S0FAvaEnRmx9BvYtGgnAM",
      authDomain: "grey-corner-presence.firebaseapp.com",
      databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "grey-corner-presence",
      storageBucket: "grey-corner-presence.firebasestorage.app",
      messagingSenderId: "730206093359",
      appId: "1:730206093359:web:59e3c145120807f29e46da",
      measurementId: "G-4HCKPGNED7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const CAFE_LAT=34.0343959, CAFE_LON=-5.0155941, RAYON_MAX=200;

    // Ligne 1: A=TYPE (INFO/URGENT), B=MESSAGE
    const URL_MSG_SHEET="https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Messages_Urgent";

    // ‚úÖ √âquipe (liste compl√®te RH)
    const equipe = [
      {n:"BENKHADA ABDESLAM",t:"caisse"},{n:"ENNHAILI SOUMIA",t:"caisse"},{n:"SALIL HOUDA",t:"caisse"},
      {n:"CHKAIRI YOUSSEF",t:"bar"},{n:"ELKOBBI MOSTAFA",t:"bar"},{n:"FILALI ABDERAFI",t:"bar"},{n:"KHALOUQ RACHID",t:"bar"},
      {n:"BOUCHNAK NAOUAL",t:"cuisine"},
      {n:"BELQASSE KHAOULA",t:"cuisine"},{n:"BOURAHMA ANAS",t:"cuisine"},{n:"IDRISSI SAAD",t:"cuisine"},
      {n:"LEMSSIEH JAWAD",t:"cuisine"},{n:"MAJDOUB JIHANE",t:"cuisine"},{n:"MOUJAHID IMANE",t:"cuisine"},{n:"ZAIR FATIMA",t:"cuisine"},
      {n:"ELGORRAMY ANISSA",t:"menage"},{n:"ELGORRAMY SOUAD",t:"menage"},{n:"ELMCHAOURI SOUAD",t:"menage"},{n:"SBAI HAKIMA",t:"menage"},
      {n:"ALAOUI LAZIZ",t:"service"},{n:"GUETIBI AMINE",t:"service"},{n:"HATTAF MOHAMED",t:"service"},{n:"HIDARA YOUSSEF",t:"service"},{n:"KAFOUNI ZAKARIAE",t:"service"},{n:"MOHSINE YOUNESS",t:"service"}
    ];

    // ‚úÖ EXCLUS DU POINTAGE (pas de t√©l√©phone -> pointage manuel sur feuille pr√©sence)
    const NO_PHONE_KEYS = new Set(["ELMCHAOURI_SOUAD", "SBAI_HAKIMA"]);

    function keyStaff(n){ return String(n||'').trim().replace(/\s+/g,'_').toUpperCase(); }
    const equipePointage = equipe.filter(e => !NO_PHONE_KEYS.has(keyStaff(e.n)));

    // ‚úÖ selected
    let selected = localStorage.getItem('gc_staff_name');
    if(selected && NO_PHONE_KEYS.has(keyStaff(selected))){
      localStorage.removeItem('gc_staff_name');
      selected = null;
    }

    let role = null; // "gerant" | "equipe"
    let isPunching = false;

    const dateStr = new Intl.DateTimeFormat('fr-CA',{
      timeZone:'Africa/Casablanca',
      year:'numeric',month:'2-digit',day:'2-digit'
    }).format(new Date());

    function toast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> t.style.display="none", 2200);
    }

    // ========= TIME =========
    function nowCasablancaHHMM(){
      const parts = new Intl.DateTimeFormat('fr-FR',{
        timeZone:'Africa/Casablanca',
        hour:'2-digit', minute:'2-digit', hour12:false
      }).formatToParts(new Date());
      const h = parts.find(p=>p.type==='hour')?.value ?? '00';
      const m = parts.find(p=>p.type==='minute')?.value ?? '00';
      return `${h}:${m}`;
    }

    function hhmmToMin(hhmm){
      if(!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return null;
      const [h,m] = hhmm.split(':').map(Number);
      return h*60 + m;
    }

    function computeRetard(hA, hP){
      const a = hhmmToMin(hA);
      const p = hhmmToMin(hP);
      if(a === null || p === null) return null;
      const diff = a - p;
      return { late: diff > 0, minutesLate: Math.max(0, diff) };
    }

    // ========= RETARD PANEL =========
    function showRetardPanel(){ document.getElementById('retard-panel').classList.remove('hidden'); }
    function setDayRetard(min){
      const v = Number(min || 0);
      const el = document.getElementById('day-retard-text');
      if(v > 0){
        el.innerHTML = `‚è±Ô∏è Retard jour : <span class="text-red-300">+${v} min</span>`;
      }else{
        el.innerHTML = `‚è±Ô∏è Retard jour : <span class="text-emerald-300">0 min</span>`;
      }
      showRetardPanel();
    }

    // ========= AUTH =========
    async function fetchRole(uid){
      const snap = await db.ref("users/"+uid).once("value");
      return snap.val() || null;
    }

    function showLoggedUI(){
      document.getElementById("loginWrap").classList.add("hidden");
      document.getElementById("homeMsg").style.display = "none";
      document.getElementById("sessionBar").classList.remove("hidden");
      document.getElementById("roleLabel").textContent = role || "‚Äî";
      document.getElementById("app-pointage").classList.remove("hidden");
    }

    function showLoginUI(){
      document.getElementById("loginWrap").classList.remove("hidden");
      document.getElementById("homeMsg").style.display = "block";
      document.getElementById("sessionBar").classList.add("hidden");
      document.getElementById("app-pointage").classList.add("hidden");
      document.getElementById("app-admin").classList.add("hidden");
    }

    document.getElementById("btnLogin").onclick = async () => {
      const email = (document.getElementById("loginEmail").value || "").trim();
      const pass  = (document.getElementById("loginPass").value || "").trim();
      document.getElementById("loginMsg").textContent = "";
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        document.getElementById("loginMsg").textContent = "Identifiants invalides.";
      }
    };

    document.getElementById("btnLogout").onclick = async () => {
      try{ await auth.signOut(); }catch(e){}
      localStorage.clear();
      location.reload();
    };

    auth.onAuthStateChanged(async (user) => {
      if(!user){
        role = null;
        showLoginUI();
        return;
      }

      role = await fetchRole(user.uid);
      if(role !== "gerant" && role !== "equipe"){
        await auth.signOut();
        role = null;
        showLoginUI();
        return;
      }

      showLoggedUI();
      attachResetListeners();
      initAfterLogin();
    });

    // ========= RESET LISTENERS =========
    function attachResetListeners(){
      if(!selected) return;

      db.ref(`system_control/resets/${keyStaff(selected)}`).on('value', s => {
        if(s.val()){
          db.ref(`system_control/resets/${keyStaff(selected)}`).remove();
          localStorage.clear();
          location.reload();
        }
      });

      db.ref('system_control/global_reset').on('value', s => {
        if(s.val()){
          db.ref('system_control/global_reset').remove();
          localStorage.clear();
          location.reload();
        }
      });
    }

    // ========= ADMIN (GERANT) =========
    function triggerReset(target){
      if(role !== "gerant") return;

      const msg = target === 'all' ? "R√©initialiser TOUS les mobiles ?" : `R√©initialiser le mobile de ${target} ?`;
      if(confirm(msg)){
        const path = target === 'all'
          ? 'system_control/global_reset'
          : `system_control/resets/${keyStaff(target)}`;
        db.ref(path).set(Date.now());
      }
    }

    document.getElementById("btnResetAll").onclick = () => triggerReset("all");

    function openAdmin(){
      if(role !== "gerant") return;

      document.getElementById('app-pointage').classList.add('hidden');
      document.getElementById('app-admin').classList.remove('hidden');

      // ‚úÖ ADMIN lit la table punches (pas presences)
      db.ref('punches/'+dateStr).on('value', s => {
        const data = s.val() || {};
        const container = document.getElementById('adminList');
        container.innerHTML = "";

        equipePointage.slice().sort((a,b)=>a.n.localeCompare(b.n)).forEach(emp => {
          const k = keyStaff(emp.n);
          const p = data[k];
          const div = document.createElement('div');
          div.className = "flex justify-between items-center p-3 border-b border-white/5 text-[11px]";
          div.innerHTML = `
            <span class="text-white font-extrabold">${emp.n}</span>
            <div class="flex items-center gap-2">
              <span class="${p && p.hA ? 'text-emerald-300 font-black' : 'text-gray-500'}">${p && p.hA ? p.hA : '---'}</span>
              <button class="btn-reset-indiv" onclick="triggerReset('${emp.n}')">üîÑ</button>
            </div>
          `;
          container.appendChild(div);
        });
      });
    }

    document.getElementById("logo").onclick = () => {
      if(role === "gerant") openAdmin();
    };

    // ========= MSG SHEET (ACCUEIL + BANDEAU) =========
    let bannerBusy = false;

    async function fetchSheetMessage(){
      const r = await fetch(URL_MSG_SHEET, { cache:"no-store" });
      const t = await r.text();
      const json = JSON.parse(t.substr(47).slice(0,-2));
      const rows = json?.table?.rows || [];

      const typeRaw = rows[0]?.c?.[0]?.v || "";
      const msgRaw  = rows[0]?.c?.[1]?.v || "";

      const type = String(typeRaw || "").trim().toUpperCase();
      const msg  = String(msgRaw  || "").trim();

      return { type, msg };
    }

    async function loadHomeMsg(force=false){
      if(bannerBusy && !force) return;
      bannerBusy = true;

      const box = document.getElementById("homeMsg");
      const content = document.getElementById("homeMsgContent");

      try{
        const { type, msg } = await fetchSheetMessage();

        if(msg){
          box.style.display = "block";
          content.textContent = msg;

          box.classList.remove("home-info","home-urgent");
          const isUrgent = (type === "URGENT") || msg.toUpperCase().includes("URGENT");
          box.classList.add(isUrgent ? "home-urgent" : "home-info");
        }else{
          box.style.display = "none";
        }
      }catch(e){
        // non bloquant
      }finally{
        bannerBusy = false;
      }
    }

    async function loadBanner(force=false){
      if(bannerBusy && !force) return;
      bannerBusy = true;

      const wrap = document.getElementById('banner-wrap');
      const banner = document.getElementById('banner');
      const ico = document.getElementById('refresh-ico');

      try{
        ico.classList.add('spin');

        const { type, msg } = await fetchSheetMessage();

        if(msg){
          banner.textContent = msg;
          wrap.style.display = "flex";

          banner.className = "banner";
          const isUrgent = (type === "URGENT") || msg.toUpperCase().includes("URGENT");
          if(isUrgent){
            banner.classList.add("msg-urgent","flash-brick");
          }else{
            banner.classList.add("msg-info","flash-gold");
          }
        }else{
          wrap.style.display = "none";
        }
      }catch(e){
        // non bloquant
      }finally{
        ico.classList.remove('spin');
        bannerBusy = false;
      }
    }

    document.getElementById('btn-refresh').onclick = () => loadBanner(true);

    // ========= LISTE UI =========
    function genererListeUI(){
      const sel = document.getElementById('selection');
      sel.innerHTML = `<div class="text-center text-[10px] muted uppercase font-black tracking-widest mb-2">Choisi ton nom</div>`;

      ["caisse","bar","cuisine","menage","service"].forEach(cat => {
        const h = document.createElement('div');
        h.className = "drawer-header";
        h.innerHTML = `
          <span class="text-[10px] font-black gold uppercase">${cat}</span>
          <i class="gold text-[10px]">‚ñº</i>
        `;

        const cont = document.createElement('div');
        cont.className = "hidden grid grid-cols-2 gap-2 py-3";
        h.onclick = ()=> cont.classList.toggle('hidden');

        equipePointage.filter(e => e.t === cat).forEach(emp => {
          const b = document.createElement('button');
          b.className = "staff-btn text-white";
          b.innerText = emp.n;
          b.onclick = () => {
            if(confirm(emp.n + " ?")){
              localStorage.setItem('gc_staff_name', emp.n);
              location.reload();
            }
          };
          cont.appendChild(b);
        });

        // si aucun employ√© dans la cat√©gorie, ne pas afficher
        if(cont.childElementCount === 0) return;

        sel.appendChild(h);
        sel.appendChild(cont);
      });
    }

    // ========= GPS =========
    function checkGPS(){
      const status = document.getElementById('status');

      if(!navigator.geolocation){
        status.innerHTML = `<span class="text-red-300 font-black uppercase">GPS indisponible</span>`;
        return;
      }

      navigator.geolocation.getCurrentPosition(
        p => {
          const d = getDist(p.coords.latitude, p.coords.longitude, CAFE_LAT, CAFE_LON);
          if(d <= RAYON_MAX){
            status.innerHTML = `<span class="text-emerald-300 font-black uppercase">Zone Grey Corner OK</span>`;
            document.getElementById('btn').disabled = false;
          }else{
            status.innerHTML = `<span class="text-red-300 font-black uppercase">Hors Zone (${Math.round(d)}m)</span>`;
          }
        },
        err => {
          status.innerHTML = `
            <span class="text-red-300 font-black uppercase">GPS refus√© / erreur (${err.code})</span>
            <div class="mt-2">
              <button class="text-[9px] text-gray-300 underline" onclick="checkGPS()">R√©essayer</button>
            </div>
          `;
        },
        { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
      );
    }

    function getDist(a,b,c,d){
      const R=6371e3;
      const dLat=(c-a)*Math.PI/180;
      const dLon=(d-b)*Math.PI/180;
      const q=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q));
    }

    // ========= COUNTER (punches) =========
    function setupPunchCounter(){
      const wrap = document.getElementById('punch-counter');
      const countEl = document.getElementById('punch-count');
      const totalEl = document.getElementById('punch-total');

      totalEl.textContent = String(equipePointage.length);

      if(selected){
        wrap.classList.add('hidden');
        return;
      }else{
        wrap.classList.remove('hidden');
      }

      db.ref('punches/'+dateStr).on('value', s => {
        const data = s.val() || {};
        let c = 0;
        equipePointage.forEach(emp => {
          const p = data[keyStaff(emp.n)];
          if(p && p.hA) c++;
        });
        countEl.textContent = String(c);
      });
    }

    // ========= RETARD LISTENER (punches) =========
    function setupTodayRetardListener(staffName){
      const staffKey = keyStaff(staffName);
      db.ref('punches/'+dateStr+'/'+staffKey).on('value', s => {
        const v = s.val() || {};
        if(!v.hA){ setDayRetard(0); return; }
        setDayRetard(v.retardMin || 0);
      });
    }

    // ========= INIT (after login) =========
    function initAfterLogin(){
      loadBanner(true);
      setInterval(loadBanner, 30000);

      setupPunchCounter();

      if(selected){
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
        document.getElementById('username').innerText = selected;

        setupTodayRetardListener(selected);
        checkGPS();

        // ‚úÖ √©coute punches
        db.ref('punches/'+dateStr+'/'+keyStaff(selected)).on('value', s => {
          const val = s.val();
          if(val && val.hA){
            let html = `
              <div class="bg-white/5 p-6 rounded-3xl border border-white/10 text-center">
                <p class="text-emerald-300 font-black text-2xl mb-2">POINT√â ‚úÖ</p>
                <p class="text-3xl font-black text-white mb-3">${val.hA}</p>
            `;
            const min = Number(val.retardMin || 0);
            if(min > 0) html += `<p class="text-red-300 font-black text-sm">‚ö†Ô∏è RETARD : +${min} min</p>`;
            else html += `<p class="text-emerald-300 font-black text-sm">DANS LES TEMPS ‚úì</p>`;
            document.getElementById('pointage-zone').innerHTML = html + `</div>`;
          }
        });

        // ‚úÖ disable si d√©j√† point√©
        db.ref('punches/'+dateStr+'/'+keyStaff(selected)).once('value').then(s=>{
          const v = s.val() || {};
          if(v.hA) document.getElementById("btn").disabled = true;
        });

      }else{
        genererListeUI();
      }
    }

    // ========= PUNCH ACTION (writes to punches) =========
    document.getElementById('btn').onclick = () => {
      if(isPunching) return;
      if(!selected) return;

      const staffKey = keyStaff(selected);

      // s√©curit√© UI (Souad/Hakima bloqu√©es)
      if(NO_PHONE_KEYS.has(staffKey)){
        toast("Pointage non autoris√© pour ce profil.");
        return;
      }

      isPunching = true;

      const btn = document.getElementById('btn');
      btn.disabled = true;

      const hA = nowCasablancaHHMM();
      const ref = db.ref('punches/' + dateStr + '/' + staffKey);

      ref.transaction(current => {
        current = current || {};

        // 1 seul pointage si role=equipe
        if(current.hA && role !== "gerant"){
          return; // abort
        }

        const hP = current.hP || null; // optionnel si tu le mets plus tard
        const r = hP ? computeRetard(hA, hP) : null;

        // ‚úÖ empKey obligatoire (doit matcher les rules)
        return {
          ...current,
          empKey: staffKey,
          hA: hA,
          retard: r ? r.late : false,
          retardMin: r ? r.minutesLate : 0,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
      }, (error, committed) => {
        isPunching = false;

        if(error){
          document.getElementById('status').innerHTML =
            `<span class="text-red-300 font-black uppercase">Erreur enregistrement</span>`;
          btn.disabled = false;
          return;
        }

        if(!committed){
          document.getElementById('status').innerHTML =
            `<span class="text-emerald-300 font-black uppercase">D√©j√† point√© ‚úÖ</span>`;
          btn.disabled = true;
          toast("D√©j√† point√© ‚úÖ");
          return;
        }

        toast("Pointage enregistr√© ‚úÖ");
        btn.disabled = true;
      });
    };

    // ‚úÖ Charger le message accueil d√®s l‚Äôouverture (avant login)
    loadHomeMsg(true);
    setInterval(loadHomeMsg, 30000);
  </script>
</body>
</html>