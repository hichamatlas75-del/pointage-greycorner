<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pointage Officiel ‚Ä¢ Grey Corner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: linear-gradient(135deg, #fdfaf6 0%, #f7f1e6 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.98); border: 2px solid #c5a059; box-shadow: 0 25px 50px -12px rgba(197, 160, 89, 0.2); }
        .btn-main { background: linear-gradient(to right, #c5a059, #d4af37); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(197, 160, 89, 0.3); }
        .btn-main:disabled { background: #e5e7eb; transform: none; box-shadow: none; }
        
        /* Couleurs des d√©partements pour la liste */
        .col-service { color: #2563eb; }
        .col-cuisine { color: #dc2626; }
        .col-menage { color: #059669; }
        .col-bar { color: #7c3aed; }
        .col-admin { color: #db2777; }
        
        .logo-container { width: 120px; height: 120px; margin: 0 auto 1.5rem auto; }
        .logo-img { width: 100%; height: 100%; object-fit: contain; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="glass-card p-8 md:p-12 rounded-[3rem] w-full max-w-md text-center">
        <div class="logo-container">
            <img src="images/LOGO GREY CORNER.png" alt="Logo Grey Corner" class="logo-img">
        </div>

        <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight mb-2 uppercase italic">Grey Corner</h1>
        <p class="text-[10px] font-bold text-amber-600 uppercase tracking-[0.4em] mb-8">Discipline & Bienveillance</p>
        
        <div id="statusLabel" class="inline-block px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-slate-100 text-slate-500 mb-8 border border-slate-200">
            S√©lectionnez votre nom
        </div>

        <div class="space-y-8">
            <div class="text-left">
                <label class="text-[11px] font-black text-slate-400 uppercase ml-4 mb-2 block tracking-widest text-center w-full">√âquipe F√®s</label>
                <select id="staffSelect" onchange="chargerInfosPointage(this.value)" class="w-full p-5 rounded-2xl border-2 border-slate-100 bg-white text-slate-800 font-bold focus:border-amber-500 outline-none transition-all shadow-xl text-lg appearance-none cursor-pointer text-center">
                    <option value="">-- Cliquer ici --</option>
                </select>
            </div>

            <div id="actionArea" class="space-y-4">
                <button onclick="verifierPosition()" id="geoBtn" class="w-full bg-slate-800 text-white font-black py-5 rounded-2xl text-xs uppercase tracking-widest shadow-lg active:scale-95 transition-all hidden">
                    üìç V√©rifier ma position
                </button>
                <button onclick="validerPresence()" id="submitBtn" class="w-full btn-main text-white font-black py-6 rounded-2xl shadow-xl uppercase tracking-[0.2em] text-sm active:scale-95 hidden">
                    Confirmer l'arriv√©e
                </button>
            </div>
        </div>

        <div id="msg" class="mt-8 text-sm font-bold hidden"></div>

        <footer class="mt-10 pt-6 border-t border-slate-100">
            <p class="text-[9px] font-bold text-slate-300 uppercase tracking-widest">Ouverture 06:30 ‚Ä¢ Excellence continue</p>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const CAFE_LAT = 34.0343959; const CAFE_LON = -5.0155941;
        const RAYON_AUTORISE = 300; 

        const equipeConfig = [
            {n: "ALAOUI LAZIZ", t: "service"}, {n: "BELQASSE KHAOULA", t: "cuisine"},
            {n: "BENKHADA ABDESLAM", t: "admin"}, {n: "BOURAHMA ANAS", t: "cuisine"},
            {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"},
            {n: "ELGORRAMY ANISSA", t: "menage", ex: true}, {n: "ELGORRAMY SOUAD", t: "menage"},
            {n: "ELMCHAOURI SOUAD", t: "menage", ex: true}, {n: "ENNHAIlI SOUMIA", t: "admin"},
            {n: "FILALI ABDERAFI", t: "bar"}, {n: "GUETIBI AMINE", t: "service"},
            {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"},
            {n: "IDRISSI SAAD", t: "cuisine"}, {n: "KAFOUNI ZAKARIAE", t: "service"},
            {n: "KHALOUQ RACHID", t: "bar", ex: true}, {n: "LEMSSIEH JAWAD", t: "cuisine"},
            {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"},
            {n: "MOHSINE YOUNESS", t: "service"}, {n: "SALIL HOUDA", t: "admin"},
            {n: "SBAI HAKIMA", t: "menage", ex: true}, {n: "ZAIR FATIMA", t: "cuisine"}
        ];

        let hpCache = null;
        const select = document.getElementById('staffSelect');
        const submitBtn = document.getElementById('submitBtn');
        const geoBtn = document.getElementById('geoBtn');
        const statusLabel = document.getElementById('statusLabel');

        equipeConfig.sort((a,b) => a.n.localeCompare(b.n)).forEach(emp => {
            let opt = document.createElement('option');
            opt.value = emp.n.replace(/\s+/g, '_').toUpperCase();
            opt.innerHTML = emp.n;
            opt.className = "col-" + emp.t;
            select.appendChild(opt);
        });

        async function chargerInfosPointage(val) {
            if (!val) { geoBtn.style.display = "none"; submitBtn.style.display = "none"; return; }
            const emp = equipeConfig.find(e => e.n.replace(/\s+/g, '_').toUpperCase() === val);
            const dateStr = new Date().toISOString().split('T')[0];
            const snap = await database.ref('presences/' + dateStr + '/' + val + '/hP').once('value');
            hpCache = snap.val();

            if (emp.ex) {
                statusLabel.innerHTML = "‚ú® Acc√®s Libre üåø";
                statusLabel.className = "inline-block px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-amber-50 text-amber-600 mb-8 border border-amber-100";
                geoBtn.style.display = "none";
                submitBtn.style.display = "block";
                submitBtn.disabled = false;
            } else {
                statusLabel.innerHTML = "üìç Localisation requise";
                statusLabel.className = "inline-block px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-blue-50 text-blue-500 mb-8 border border-blue-100";
                geoBtn.style.display = "block";
                submitBtn.style.display = "block";
                submitBtn.disabled = true;
            }
        }

        function verifierPosition() {
            geoBtn.innerHTML = "V√©rification...";
            navigator.geolocation.getCurrentPosition((pos) => {
                const d = getDistance(pos.coords.latitude, pos.coords.longitude, CAFE_LAT, CAFE_LON);
                if (d <= RAYON_AUTORISE) {
                    statusLabel.innerHTML = "‚úÖ Zone valid√©e";
                    statusLabel.className = "inline-block px-5 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-green-50 text-green-600 mb-8 border border-green-100";
                    submitBtn.disabled = false;
                    geoBtn.style.display = "none";
                } else { alert("Vous n'√™tes pas au caf√©."); geoBtn.innerHTML = "R√©essayer"; }
            }, null, { enableHighAccuracy: true });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180; const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180; const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function validerPresence() {
            const user = select.value;
            submitBtn.disabled = true;
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            let retard = false;
            if (hpCache) {
                const [h, m] = hpCache.split(':').map(Number);
                if ((now.getHours() * 60 + now.getMinutes()) > (h * 60 + m + 5)) retard = true;
            }

            database.ref('presences/' + dateStr + '/' + user).update({
                on: true, hA: timeStr, retard: retard, timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                const msg = document.getElementById('msg');
                msg.innerHTML = retard ? `‚è≥ Enregistr√© avec retard (${timeStr})` : `‚ú® Merci ! Pointage r√©ussi √† ${timeStr}`;
                msg.className = "mt-8 p-5 rounded-3xl font-bold block " + (retard ? "bg-orange-50 text-orange-700" : "bg-green-50 text-green-700");
                msg.style.display = "block";
                setTimeout(() => location.reload(), 3000);
            });
        }
    </script>
</body>
</html>
