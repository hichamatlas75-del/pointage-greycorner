<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grey Corner ‚Ä¢ Pointage</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
<style>
    html,body{height:100%;margin:0;overflow:hidden;background:radial-gradient(circle at top,#111827 0%,#020617 100%);font-family:'Plus Jakarta Sans',sans-serif;}
    .card{width:100%;max-width:420px;height:96vh;background:linear-gradient(180deg,#0b0e14,#030712);border-radius:40px;padding:18px;box-shadow:0 0 60px rgba(212,175,55,.25);border:1px solid rgba(212,175,55,.25);position:relative;display:flex;flex-direction:column;}
    .gold{color:#d4af37}
    .btn-main{background:linear-gradient(180deg,#f5d776,#b8942e);color:#111;font-weight:900;border-radius:28px;padding:25px;font-size:24px;box-shadow:0 10px 30px rgba(212,175,55,0.3)}
    .scroll{overflow-y:auto;scrollbar-width:none;}
    .scroll::-webkit-scrollbar{display:none}
    
    /* STYLE BANNIERE MSG */
    .ticker-container {
        display: none;
        overflow: hidden;
        white-space: nowrap;
        border-radius: 12px;
        padding: 10px;
        margin-bottom: 12px;
        font-weight: 800;
        font-size: 13px;
        position: relative;
    }
    .ticker-text {
        display: inline-block;
        padding-left: 100%;
        animation: scroll-left 15s linear infinite;
    }
    @keyframes scroll-left {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
    }
    .msg-normal{background:rgba(212,175,55,0.1);color:#f5d776;border:1px solid rgba(212,175,55,0.3)}
    .msg-urgent{background:#7f1d1d;color:#fff;border:1px solid #ef4444;animation:pulse 2s infinite}
    
    .drawer-header{background:rgba(255,255,255,0.04);border:1px solid rgba(212,175,55,0.18);border-radius:14px;padding:14px;margin-top:10px;display:flex;justify-content:space-between;cursor:pointer}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
</style>
</head>
<body class="flex items-center justify-center p-4">
<div class="card">
    <div class="text-center mb-4 flex-shrink-0">
        <img src="images/LOGO GREY CORNER.png" onclick="askAdmin()" class="h-14 mx-auto cursor-pointer">
    </div>

    <button onclick="window.open('https://grey-corner-app.pages.dev/', '_blank')" class="bg-white/5 border border-white/10 text-gray-400 py-3 rounded-xl text-[10px] font-bold uppercase mb-4">
        üìÖ Consulter le Planning
    </button>

    <div id="ticker-container" class="ticker-container">
        <div id="ticker-text" class="ticker-text"></div>
    </div>

    <div id="app-pointage" class="flex flex-col flex-grow overflow-hidden">
        <div id="selection" class="scroll flex-grow">
             <div class="text-center text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-2">Choisi ton nom</div>
        </div>

        <div id="action" class="hidden flex flex-col flex-grow justify-center">
            <div id="username" class="text-3xl font-black text-yellow-200 text-center mb-8">--</div>
            
            <div id="pointage-zone">
                <div id="status" class="text-center text-[10px] mb-4 text-gray-400 uppercase tracking-widest">Localisation GPS...</div>
                <button id="btn" class="btn-main w-full" disabled>Valider mon Arriv√©e</button>
            </div>

            <button onclick="localStorage.clear();location.reload();" class="mt-12 text-[9px] text-gray-600 uppercase tracking-widest">Retour au menu</button>
        </div>
    </div>

    <div id="app-admin" class="hidden flex flex-col flex-grow overflow-hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="gold font-black uppercase text-sm italic">Supervision</h2>
            <button onclick="location.reload()" class="text-white text-xs bg-red-900/50 px-3 py-1 rounded-full text-[10px]">Fermer</button>
        </div>
        <div id="adminList" class="scroll flex-grow bg-white/5 rounded-2xl p-2"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={databaseURL:"https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const CAFE_LAT=34.0343959, CAFE_LON=-5.0155941, RAYON_MAX=200;
const URL_MSG_SHEET="https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Messages_Urgent";

const equipe = [
    {n: "BENKHADA ABDESLAM", t: "caisse"}, {n: "ENNHAILI SOUMIA", t: "caisse"}, {n: "SALIL HOUDA", t: "caisse"},
    {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"}, {n: "FILALI ABDERAFI", t: "bar"}, {n: "KHALOUQ RACHID", t: "bar"},
    {n: "BELQASSE KHAOULA", t: "cuisine"}, {n: "BOURAHMA ANAS", t: "cuisine"}, {n: "IDRISSI SAAD", t: "cuisine"}, {n: "LEMSSIEH JAWAD", t: "cuisine"}, {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"}, {n: "ZAIR FATIMA", t: "cuisine"},
    {n: "ELGORRAMY ANISSA", t: "menage"}, {n: "ELGORRAMY SOUAD", t: "menage"}, {n: "ELMCHAOURI SOUAD", t: "menage"}, {n: "SBAI HAKIMA", t: "menage"},
    {n: "ALAOUI LAZIZ", t: "service"}, {n: "GUETIBI AMINE", t: "service"}, {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"}, {n: "KAFOUNI ZAKARIAE", t: "service"}, {n: "MOHSINE YOUNESS", t: "service"}
];

let selected=localStorage.getItem('gc_staff_name');
const dateStr=new Intl.DateTimeFormat('fr-CA',{timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());

function keyStaff(n){ return String(n||'').trim().replace(/\s+/g, '_').toUpperCase(); }

function checkRetard(hA, hP) {
    if(!hP) return null;
    const [haH, haM] = hA.split(':').map(Number);
    const [hph, hpm] = hP.split(':').map(Number);
    return (haH * 60 + haM) > (hph * 60 + hpm);
}

// CHARGEMENT DU MESSAGE DEPUIS GOOGLE SHEETS
async function loadTicker() {
    try {
        const r = await fetch(URL_MSG_SHEET);
        const t = await r.text();
        const json = JSON.parse(t.substr(47).slice(0,-2));
        const msg = json.table.rows[0].c[1].v; // R√©cup√®re la cellule B1
        const container = document.getElementById('ticker-container');
        const textElem = document.getElementById('ticker-text');
        
        if(msg && msg.trim() !== "") {
            textElem.innerText = msg;
            container.style.display = "block";
            // Si le message contient "URGENT", on change le style
            if(msg.toUpperCase().includes("URGENT")) {
                container.className = "ticker-container msg-urgent";
            } else {
                container.className = "ticker-container msg-normal";
            }
        }
    } catch(e) { console.log("Erreur Ticker:", e); }
}

function askAdmin() {
    if(prompt("Code Admin :") === "2026") {
        document.getElementById('app-pointage').classList.add('hidden');
        document.getElementById('app-admin').classList.remove('hidden');
        db.ref('presences/'+dateStr).on('value', s => {
            const data = s.val() || {};
            const container = document.getElementById('adminList');
            container.innerHTML = "";
            equipe.sort((a,b)=>a.n.localeCompare(b.n)).forEach(emp => {
                const p = data[keyStaff(emp.n)];
                const div = document.createElement('div');
                div.className = "flex justify-between p-3 border-b border-white/5 text-[11px]";
                const retardInfo = p?.retard ? '<span class="text-red-500 ml-2">‚ö†Ô∏è Retard</span>' : '';
                div.innerHTML = `<span class="text-white">${emp.n}</span><span class="${p?'text-emerald-400 font-bold':'text-gray-600'}">${p ? p.hA + retardInfo : '---'}</span>`;
                container.appendChild(div);
            });
        });
    }
}

function init() {
    loadTicker(); // On lance la banni√®re au d√©marrage
    if (selected) {
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
        document.getElementById('username').innerText = selected;
        checkGPS();
        
        db.ref('presences/'+dateStr+'/'+keyStaff(selected)).on('value', s => {
            const val = s.val();
            if(val && val.hA) {
                let statusHTML = `<div class="bg-white/5 p-6 rounded-3xl border border-white/10 text-center">
                    <p class="text-emerald-400 font-black text-2xl mb-1">POINT√â ‚úÖ</p>
                    <p class="text-white/60 text-[10px] uppercase mb-4">Arriv√©e : ${val.hA}</p>`;
                
                if(val.hP) {
                    const isRetard = checkRetard(val.hA, val.hP);
                    statusHTML += isRetard 
                        ? `<p class="text-red-500 font-bold text-sm">‚ö†Ô∏è RETARD CONSTAT√â</p>`
                        : `<p class="text-emerald-500 font-bold text-sm">DANS LES TEMPS ‚úì</p>`;
                    if(val.retard !== isRetard) db.ref('presences/'+dateStr+'/'+keyStaff(selected)).update({retard: isRetard});
                } else {
                    statusHTML += `<p class="text-gray-500 italic text-[9px]">Calcul retard en attente du planning...</p>`;
                }
                statusHTML += `</div>`;
                document.getElementById('pointage-zone').innerHTML = statusHTML;
            }
        });
    } else {
        genererListeUI();
    }
}

function genererListeUI() {
    const sel = document.getElementById('selection');
    ["caisse","bar","cuisine","menage","service"].forEach(cat => {
        const h = document.createElement('div'); h.className="drawer-header";
        h.innerHTML=`<span class="text-[10px] font-black gold uppercase">${cat}</span><i class="gold text-[10px]">‚ñº</i>`;
        const cont = document.createElement('div'); cont.className="hidden grid grid-cols-2 gap-2 py-3";
        h.onclick=()=> cont.classList.toggle('hidden');
        equipe.filter(e => e.t === cat).forEach(emp => {
            const b = document.createElement('button'); b.className="p-3 bg-white/5 border border-white/10 rounded-xl text-[10px] text-white";
            b.innerText = emp.n;
            b.onclick = () => { if(confirm(emp.n + " ?")) { localStorage.setItem('gc_staff_name', emp.n); location.reload(); }};
            cont.appendChild(b);
        });
        sel.appendChild(h); sel.appendChild(cont);
    });
}

function checkGPS(){
    navigator.geolocation.getCurrentPosition(p=>{
        const d=getDist(p.coords.latitude,p.coords.longitude,CAFE_LAT,CAFE_LON);
        if(d<=RAYON_MAX){
            document.getElementById('status').innerHTML=`<span class="text-green-400 font-bold uppercase">Zone Grey Corner OK</span>`;
            document.getElementById('btn').disabled=false;
        } else {
            document.getElementById('status').innerHTML=`<span class="text-red-400 font-bold uppercase">Hors Zone (${Math.round(d)}m)</span>`;
        }
    }, null, {enableHighAccuracy:true});
}

function getDist(a,b,c,d){
    const R=6371e3; const dLat=(c-a)*Math.PI/180; const dLon=(d-b)*Math.PI/180;
    const q=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q));
}

document.getElementById('btn').onclick=()=>{
    const t=new Date();
    const hA = t.getHours().toString().padStart(2,'0')+":"+t.getMinutes().toString().padStart(2,'0');
    db.ref('presences/'+dateStr+'/'+keyStaff(selected)).once('value', s => {
        const hP = s.val()?.hP || null;
        const isRetard = hP ? checkRetard(hA, hP) : false;
        db.ref('presences/'+dateStr+'/'+keyStaff(selected)).update({
            on:true, hA:hA, retard:isRetard, timestamp:firebase.database.ServerValue.TIMESTAMP
        });
    });
};

init();
</script>
</body>
</html>
