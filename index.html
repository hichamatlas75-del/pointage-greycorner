<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Grey Corner ‚Ä¢ Master Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet" />

<style>
  html,body{
    height:100%; margin:0; overflow:hidden;
    background: radial-gradient(1200px 600px at 50% -10%, rgba(255,180,60,0.08), transparent 60%),
                linear-gradient(180deg,#02040a,#050816 40%,#02040a);
    font-family:'Plus Jakarta Sans',sans-serif; color:#e5e7eb;
  }
  .card{
    width:100%; max-width:420px; min-height:96vh; border-radius:42px; padding:20px;
    display:flex; flex-direction:column; background:linear-gradient(145deg,rgba(20,23,35,.75),rgba(5,7,15,.85));
    backdrop-filter:blur(18px); -webkit-backdrop-filter:blur(18px); border:1px solid rgba(255,255,255,.08);
    box-shadow: 0 40px 80px rgba(0,0,0,.8); position:relative; margin:auto;
  }
  .gold{ color:#ffcc73; }
  .btn-blue{ background: linear-gradient(180deg,#2F7BFF,#1A4ED8); color:#fff; padding:16px; border-radius:22px; font-weight:900; width:100%; text-transform:uppercase; font-size:12px; }
  .btn-dark{ background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); color:#fff; padding:16px; border-radius:22px; font-weight:900; width:100%; text-transform:uppercase; font-size:12px; }
  .btn-main{ background: linear-gradient(180deg,#ffd68a,#ffb347); color:#1a1305; font-weight:900; border-radius:26px; padding:22px; width:100%; font-size:20px; }
  .inpt{ width:100%; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:18px; padding:14px; color:#fff; font-size:13px; outline:none; }
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#000; color:#fff; padding:10px 20px; border-radius:12px; font-size:12px; display:none; z-index:100; }
</style>
</head>

<body class="flex items-center justify-center p-4">
  <div class="card">
    <div class="text-center mb-6">
      <img id="logo" src="images/LOGO GREY CORNER.png" class="h-14 mx-auto cursor-pointer" onclick="handleLogoClick()" />
    </div>

    <div id="view-login" class="space-y-4">
      <div class="text-center mb-2">
        <h2 class="text-sm font-black uppercase tracking-widest gold">Connexion G√©rant</h2>
      </div>
      <input id="loginEmail" class="inpt" type="email" placeholder="Email" />
      <input id="loginPass" class="inpt" type="password" placeholder="Mot de passe" />
      <button onclick="login()" class="btn-blue">Se Connecter</button>
      <div id="loginError" class="text-red-400 text-[10px] text-center font-bold"></div>
    </div>

    <div id="view-setup" class="hidden flex flex-col flex-grow">
      <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-2xl p-4 mb-6">
        <div class="text-[10px] font-black gold uppercase mb-1">Note de service</div>
        <div id="sheetMsg" class="text-xs font-bold leading-relaxed">Chargement du message...</div>
      </div>

      <div class="bg-white/5 border border-white/10 rounded-3xl p-5 space-y-4">
        <div class="text-center">
          <h2 class="text-[11px] font-black uppercase tracking-widest gold">Premi√®re Utilisation</h2>
          <p class="text-[10px] muted mt-1">Cr√©ez un PIN et liez un nom √† ce mobile.</p>
        </div>
        
        <input id="setupPin" class="inpt text-center text-xl tracking-[0.5em]" type="password" maxlength="4" placeholder="****" inputmode="numeric" />
        
        <select id="setupName" class="inpt">
          <option value="">Choisir un nom...</option>
        </select>

        <button onclick="saveSetup()" class="btn-main !text-sm">Valider & Verrouiller ‚úÖ</button>
      </div>

      <div class="mt-auto space-y-2">
        <button onclick="window.open('URL_PLANNING','_blank')" class="btn-blue">üóìÔ∏è Planning</button>
        <button onclick="window.open('URL_RAMADAN','_blank')" class="btn-dark">üåô Menu Ramadan</button>
      </div>
    </div>

    <div id="view-main" class="hidden flex flex-col flex-grow justify-center text-center">
      <div id="userName" class="text-3xl font-black text-yellow-200 mb-6">--</div>
      
      <div id="pinGate">
        <input id="unlockPin" class="inpt text-center text-xl tracking-[0.5em] mb-4" type="password" maxlength="4" placeholder="PIN" inputmode="numeric" />
        <button onclick="unlockApp()" class="btn-blue">D√©verrouiller</button>
      </div>

      <div id="punchZone" class="hidden">
        <div id="gpsStatus" class="text-[10px] mb-4 uppercase gold">V√©rification GPS...</div>
        <button id="btnPunch" class="btn-main" disabled>Valider Arriv√©e</button>
      </div>
    </div>

  </div>

  <div id="toast" class="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // Config Firebase (Ins√©rez votre config ici)
    const firebaseConfig = { apiKey: "...", databaseURL: "..." }; 
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let clicks = 0;
    const staffList = ["BENKHADA ABDESLAM", "ENNHAILI SOUMIA", "SALIL HOUDA", "CHKAIRI YOUSSEF"]; // etc...

    // --- INITIALISATION ---
    auth.onAuthStateChanged(user => {
      if (!user) {
        showView('view-login');
      } else {
        checkBinding();
        loadSheetMsg();
      }
    });

    function checkBinding() {
      const boundName = localStorage.getItem('gc_name');
      if (boundName) {
        showView('view-main');
        document.getElementById('userName').textContent = boundName;
      } else {
        showView('view-setup');
        fillStaffSelect();
      }
    }

    function showView(id) {
      ['view-login', 'view-setup', 'view-main'].forEach(v => document.getElementById(v).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    // --- LOGIQUE SHEET ---
    function loadSheetMsg() {
      // Simul√© ici, liez √† votre endpoint Google Script
      db.ref('system/message_fixe').on('value', s => {
        document.getElementById('sheetMsg').textContent = s.val() || "Bienvenue au Grey Corner.";
      });
    }

    // --- AUTH ---
    async function login() {
      const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
      try { await auth.signInWithEmailAndPassword(e, p); } 
      catch(err) { document.getElementById('loginError').textContent = "Erreur d'acc√®s."; }
    }

    // --- SETUP ---
    function fillStaffSelect() {
      const sel = document.getElementById('setupName');
      staffList.forEach(name => {
        let opt = document.createElement('option'); opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
      });
    }

    function saveSetup() {
      const pin = document.getElementById('setupPin').value, name = document.getElementById('setupName').value;
      if (pin.length === 4 && name) {
        localStorage.setItem('gc_pin', pin);
        localStorage.setItem('gc_name', name);
        location.reload();
      } else { alert("Veuillez remplir le PIN et le Nom."); }
    }

    // --- UNLOCK & POINTAGE ---
    function unlockApp() {
      const input = document.getElementById('unlockPin').value;
      if (input === localStorage.getItem('gc_pin')) {
        document.getElementById('pinGate').classList.add('hidden');
        document.getElementById('punchZone').classList.remove('hidden');
        startGps();
      } else { alert("PIN Incorrect"); }
    }

    function handleLogoClick() {
      clicks++;
      if (clicks === 3) {
        if (confirm("R√©initialiser l'appareil ?")) { localStorage.clear(); location.reload(); }
        clicks = 0;
      }
      setTimeout(() => clicks = 0, 1000);
    }

    function startGps() {
      // Logique GPS ici (d√©j√† fournie pr√©c√©demment)
      document.getElementById('btnPunch').disabled = false; // Simul√© pour test
    }
  </script>
</body>
</html>
