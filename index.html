<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Grey Corner • Système Master</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
<style>
    html,body{height:100%;margin:0;overflow:hidden;background:radial-gradient(circle at top,#111827 0%,#020617 100%);font-family:'Plus Jakarta Sans',sans-serif;touch-action:pan-y}
    .card{width:100%;max-width:420px;height:96vh;background:linear-gradient(180deg,#0b0e14,#030712);border-radius:40px;padding:18px;box-shadow:0 0 60px rgba(212,175,55,.25), inset 0 0 40px rgba(255,215,120,.08);border:1px solid rgba(212,175,55,.25);position:relative}
    .gold{color:#d4af37}
    .btn-main{background:linear-gradient(180deg,#f5d776,#b8942e);color:#111;font-weight:900;border-radius:28px;padding:26px;font-size:26px;box-shadow:0 10px 40px rgba(212,175,55,.4)}
    .btn-main:disabled{opacity:.25}
    .scroll{overflow-y:auto;-webkit-overflow-scrolling:touch}
    .drawer-header{background:rgba(255,255,255,.04);border:1px solid rgba(212,175,55,.18);border-radius:14px;padding:14px;margin-top:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none}
    .drawer-header span{font-size:10px;font-weight:900;color:#d4af37;text-transform:uppercase;letter-spacing:1px}
    .drawer-content{display:none;grid-template-columns:repeat(2, 1fr);gap:8px;padding:10px 0}
    .drawer-content.active{display:grid}
    .btn-staff{background:rgba(255,255,255,.05);border:1px solid rgba(212,175,55,.12);height:46px;font-size:10px;font-weight:800;border-radius:12px;text-transform:uppercase;color:#f8fafc;display:flex;align-items:center;justify-content:center;text-align:center;padding:8px}
    .big-name{font-size:34px;font-weight:900;color:#f5d776;text-align:center;margin:20px 0}
</style>
</head>
<body class="flex items-center justify-center p-4">
<div class="card flex flex-col">
    <div class="text-center mb-3">
        <img src="images/LOGO GREY CORNER.png" class="h-14 mx-auto mb-2">
        <div class="gold font-extrabold text-xs uppercase">Système Master</div>
    </div>
    <div class="bg-white/5 rounded-xl p-2 text-center text-sm mb-3">Présents : <span id="presentCount" class="gold font-black">0</span></div>
    <div id="status" class="text-center text-sm text-gray-300 mb-3 uppercase font-bold tracking-widest text-[10px]">Choisi ton nom</div>
    
    <div id="selection" class="scroll flex-grow"></div>

    <div id="action" class="hidden text-center flex-grow flex flex-col justify-center">
        <div id="username" class="big-name">--</div>
        <button id="btn" class="btn-main w-full" disabled>Pointer arrivée</button>
        <button onclick="resetUser()" class="mt-8 text-xs text-gray-500 underline uppercase tracking-widest">Changer profil</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={databaseURL:"https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

const CAFE_LAT=34.0343959,CAFE_LON=-5.0155941,RAYON_MAX=200;

const equipe = [
    {n: "BENKHADA ABDESLAM", t: "caisse"}, {n: "ENNHAILI SOUMIA", t: "caisse"}, {n: "SALIL HOUDA", t: "caisse"},
    {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"}, {n: "FILALI ABDERAFI", t: "bar"}, {n: "KHALOUQ RACHID", t: "bar"},
    {n: "BELQASSE KHAOULA", t: "cuisine"}, {n: "BOURAHMA ANAS", t: "cuisine"}, {n: "IDRISSI SAAD", t: "cuisine"}, {n: "LEMSSIEH JAWAD", t: "cuisine"}, {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"}, {n: "ZAIR FATIMA", t: "cuisine"},
    {n: "ELGORRAMY ANISSA", t: "menage"}, {n: "ELGORRAMY SOUAD", t: "menage"}, {n: "ELMCHAOURI SOUAD", t: "menage"}, {n: "SBAI HAKIMA", t: "menage"},
    {n: "ALAOUI LAZIZ", t: "service"}, {n: "GUETIBI AMINE", t: "service"}, {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"}, {n: "KAFOUNI ZAKARIAE", t: "service"}, {n: "MOHSINE YOUNESS", t: "service"}
];

let selected=localStorage.getItem('gc_staff_name');
let plannedStart=null;
const dateStr=new Intl.DateTimeFormat('fr-CA',{timeZone:'Africa/Casablanca',year:'numeric',month:'2-digit',day:'2-digit'}).format(new Date());

function keyStaff(n){ return String(n||'').trim().replace(/\s+/g, '_').toUpperCase(); }

function genererListeUI() {
    const sel = document.getElementById('selection');
    sel.innerHTML = '';
    ["caisse","bar","cuisine","menage","service"].forEach(cat => {
        const h = document.createElement('div'); h.className="drawer-header";
        h.innerHTML=`<span>${cat}</span><i class="gold">▼</i>`;
        const cont = document.createElement('div'); cont.className="drawer-content";
        h.onclick=()=> cont.classList.toggle('active');
        equipe.filter(e => e.t === cat).forEach(emp => {
            const b = document.createElement('button'); b.className="btn-staff";
            b.innerText = emp.n;
            b.onclick = () => { if(confirm(emp.n + " ?")) { localStorage.setItem('gc_staff_name', emp.n); location.reload(); }};
            cont.appendChild(b);
        });
        sel.appendChild(h); sel.appendChild(cont);
    });
}

function init() {
    db.ref('presences/'+dateStr).on('value', s => {
        const data = s.val() || {};
        let c=0; Object.values(data).forEach(e=>{if(e&&e.on)c++});
        document.getElementById('presentCount').innerText=c;

        if (selected) {
            const myData = data[keyStaff(selected)];
            // Récupération de l'heure prévue enregistrée en base
            if (myData && myData.hP) plannedStart = myData.hP;
            
            // Vérification si déjà pointé (hA existe)
            if (myData && myData.hA) {
                const btn = document.getElementById('btn');
                btn.disabled = true;
                btn.innerText = "POINTÉ À " + myData.hA + " ✅";
                btn.style.background = "linear-gradient(180deg, #10b981, #059669)";
                document.getElementById('status').innerHTML = '<span class="text-emerald-400 font-bold uppercase tracking-widest text-[10px]">Session Validée</span>';
            }
        }
    });

    if (selected) {
        document.getElementById('selection').classList.add('hidden');
        document.getElementById('action').classList.remove('hidden');
        document.getElementById('username').innerText = selected;
        checkGPS();
    } else {
        genererListeUI();
    }
}

function checkGPS(){
    navigator.geolocation.getCurrentPosition(p=>{
        const d=getDist(p.coords.latitude,p.coords.longitude,CAFE_LAT,CAFE_LON);
        if(d<=RAYON_MAX){
            document.getElementById('status').innerHTML=`<span class="text-green-400 font-bold">DANS LA ZONE</span> ${plannedStart?'<br><span class="text-[9px] gold">PRÉVU : '+plannedStart+'</span>':''}`;
            document.getElementById('btn').disabled=false;
        } else {
            document.getElementById('status').innerHTML=`<span class="text-red-400 font-bold">HORS ZONE (${Math.round(d)}m)</span>`;
        }
    }, null, {enableHighAccuracy:true});
}

function getDist(a,b,c,d){
    const R=6371e3; const dLat=(c-a)*Math.PI/180; const dLon=(d-b)*Math.PI/180;
    const q=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q));
}

document.getElementById('btn').onclick=()=>{
    const t=new Date();
    const actual=t.getHours().toString().padStart(2,'0')+":"+t.getMinutes().toString().padStart(2,'0');
    
    let retard = false;
    let retardMin = 0;

    // Calcul du retard SEULEMENT si hP est présent
    if(plannedStart && plannedStart !== "N/A" && plannedStart !== ""){
        const [ph, pm] = plannedStart.split(':').map(Number);
        const [ah, am] = actual.split(':').map(Number);
        const totalP = ph * 60 + pm;
        const totalA = ah * 60 + am;
        if(totalA > totalP) {
            retard = true;
            retardMin = totalA - totalP;
        }
    }

    db.ref('presences/'+dateStr+'/'+keyStaff(selected)).update({
        on:true, 
        hA:actual, 
        retard:retard, 
        retardMin:retardMin, 
        timestamp:firebase.database.ServerValue.TIMESTAMP
    }).then(()=>location.reload());
};

function resetUser(){localStorage.clear();location.reload();}
init();
</script>
</body>
</html>
