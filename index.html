<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grey Corner ‚Ä¢ Syst√®me</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); font-family: 'Plus Jakarta Sans', sans-serif; }
        body::before { content: ""; position: absolute; inset: 0; background-image: url('https://www.transparenttextures.com/patterns/arabesque.png'); opacity: 0.1; pointer-events: none; }
        
        .glass-card { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(197, 160, 89, 0.3); width: 100%; max-width: 400px; height: 95vh; border-radius: 2.5rem; padding: 1.2rem; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 40px rgba(197, 160, 89, 0.1); }
        
        /* TICKER */
        .info-ticker-container { background: rgba(197, 160, 89, 0.1); border: 1px solid #c5a059; border-radius: 12px; margin-bottom: 12px; height: 60px; overflow: hidden; white-space: nowrap; display: none; align-items: center; z-index: 10; }
        .ticker-text { display: inline-block; padding-left: 100%; animation: ticker 25s linear infinite; color: #f3e8d2; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* TIROIRS */
        .drawer-header { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(197, 160, 89, 0.2); border-radius: 12px; padding: 14px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .drawer-header span { font-size: 10px; font-weight: 800; color: #c5a059; text-transform: uppercase; letter-spacing: 1px; }
        .drawer-content { display: none; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 10px 0; }
        .drawer-content.active { display: grid; }

        .btn-staff { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(197, 160, 89, 0.1); height: 45px; font-size: 10px; font-weight: 700; border-radius: 10px; text-transform: uppercase; color: #f3e8d2; display: flex; align-items: center; justify-content: center; text-align: center; width: 100%; }
        .btn-staff:disabled { opacity: 0.2; color: #64748b; }

        /* ANIMATION SUCC√àS */
        #successOverlay { display: none; position: absolute; inset: 0; background: #0f172a; z-index: 200; border-radius: 2.5rem; flex-direction: column; align-items: center; justify-content: center; text-align: center; animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .seal-anim { width: 100px; height: 100px; filter: drop-shadow(0 0 15px #c5a059); animation: sealScale 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes sealScale { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c5a059; border-radius: 10px; }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass-card">
        <div id="successOverlay"></div>

        <div class="text-center mb-2">
            <img src="images/LOGO GREY CORNER.png" id="logoAdmin" class="h-12 mx-auto mb-2 cursor-pointer active:scale-90 transition-transform">
            <div class="bg-emerald-500/10 border border-emerald-500/50 text-emerald-400 px-4 py-1.5 rounded-xl text-[10px] font-bold inline-flex items-center gap-2">
                üìÖ <span id="date-label"></span>
            </div>
        </div>

        <div id="tickerContainer" class="info-ticker-container">
            <div id="tickerText" class="ticker-text"></div>
        </div>

        <div id="liveCounter" class="bg-white/5 border border-white/10 rounded-2xl p-3 mb-3 flex items-center justify-center gap-3">
            <div class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#c5a059] opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-[#c5a059]"></span>
            </div>
            <div class="text-[10px] font-bold uppercase tracking-wider text-slate-300">
                <span id="presentCount" class="text-[#c5a059] text-sm">0</span> membres de la famille en poste
            </div>
        </div>

        <div id="statusLabel" class="text-center px-3 py-2 text-[10px] font-bold uppercase mb-4 bg-black/40 border border-white/5 rounded-xl min-h-[50px] flex items-center justify-center text-slate-400">
            Initialisation...
        </div>

        <div id="selectionZone" class="overflow-y-auto flex-grow custom-scroll hidden"></div>

        <div id="actionZone" class="hidden text-center flex-grow flex flex-col justify-between py-4">
            <div class="bg-white/5 p-6 rounded-3xl border border-white/10">
                <label class="block text-[#c5a059] text-[10px] font-black uppercase mb-3 tracking-[0.2em]">Heure d'entr√©e pr√©vue</label>
                <input type="time" id="heurePrevue" class="w-full bg-slate-900 border-2 border-[#c5a059]/30 text-[#c5a059] text-3xl font-bold text-center rounded-2xl p-3 focus:border-[#c5a059] outline-none transition-all">
                <p class="text-slate-500 text-[9px] mt-3 italic">Saisissez l'heure de votre shift</p>
            </div>

            <div>
                <button id="submitBtn" onclick="validerPresence()" disabled class="w-full py-7 rounded-3xl bg-gradient-to-r from-[#c5a059] to-[#8a6d3b] text-slate-900 font-extrabold text-xl shadow-2xl active:scale-95 disabled:opacity-20 transition-all uppercase">
                    Valider Pr√©sence
                </button>
                <button onclick="resetUserMemory()" class="mt-6 text-[9px] text-slate-500 underline uppercase tracking-widest">Changer de profil</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const CAFE_LAT = 34.0343959, CAFE_LON = -5.0155941, RAYON_MAX = 200;

        const equipeConfig = [
            {n: "BENKHADA ABDESLAM", t: "admin"}, {n: "ENNHAILI SOUMIA", t: "admin"}, {n: "SALIL HOUDA", t: "admin"},
            {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"}, {n: "FILALI ABDERAFI", t: "bar"}, {n: "KHALOUQ RACHID", t: "bar"},
            {n: "BELQASSE KHAOULA", t: "cuisine"}, {n: "BOURAHMA ANAS", t: "cuisine"}, {n: "IDRISSI SAAD", t: "cuisine"}, {n: "LEMSSIEH JAWAD", t: "cuisine"}, {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"}, {n: "ZAIR FATIMA", t: "cuisine"},
            {n: "ELGORRAMY ANISSA", t: "menage"}, {n: "ELGORRAMY SOUAD", t: "menage"}, {n: "ELMCHAOURI SOUAD", t: "menage"}, {n: "SBAI HAKIMA", t: "menage"},
            {n: "ALAOUI LAZIZ", t: "service"}, {n: "GUETIBI AMINE", t: "service"}, {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"}, {n: "KAFOUNI ZAKARIAE", t: "service"}, {n: "MOHSINE YOUNESS", t: "service"}
        ];

        let selectedUser = localStorage.getItem('gc_staff_name');
        const dateStr = new Intl.DateTimeFormat('fr-CA', {timeZone: 'Africa/Casablanca', year: 'numeric', month: '2-digit', day: '2-digit'}).format(new Date());
        document.getElementById('date-label').innerText = "VOTRE POINTAGE : " + dateStr.split('-').reverse().join('/');

        function lancerGPS() {
            document.getElementById('statusLabel').innerHTML = "üìç V√âRIFICATION LOCALISATION...";
            navigator.geolocation.getCurrentPosition((pos) => {
                const dist = getDistance(pos.coords.latitude, pos.coords.longitude, CAFE_LAT, CAFE_LON);
                if (dist <= RAYON_MAX) {
                    document.getElementById('statusLabel').innerHTML = "Bonjour " + selectedUser + "<br><span class='text-emerald-400 font-extrabold'>‚úÖ AU GREY CORNER</span>";
                    document.getElementById('submitBtn').disabled = false;
                } else {
                    document.getElementById('statusLabel').innerHTML = `<span class="text-red-400">‚ùå HORS ZONE (${Math.round(dist)}m)</span>`;
                }
            }, (err) => { document.getElementById('statusLabel').innerHTML = "‚ùå GPS REQUIS"; }, { enableHighAccuracy: true });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function validerPresence() {
            const hPrev = document.getElementById('heurePrevue').value;
            if(!hPrev) return alert("Veuillez saisir votre heure pr√©vue !");

            const maintenant = new Date();
            const hReel = maintenant.getHours().toString().padStart(2,'0') + ":" + maintenant.getMinutes().toString().padStart(2,'0');
            
            // Calcul retard
            const [hp, mp] = hPrev.split(':').map(Number);
            const [hr, mr] = hReel.split(':').map(Number);
            const diff = (hr * 60 + mr) - (hp * 60 + mp);

            const status = diff > 5 ? {t: "Retard de " + diff + "m", c: "text-red-500"} : {t: "√Ä l'heure", c: "text-emerald-400"};
            const key = selectedUser.trim().replace(/\s+/g, '_').toUpperCase();

            database.ref('presences/' + dateStr + '/' + key).update({
                on: true, hA: hReel, hP: hPrev, retard: diff > 0 ? diff : 0, timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                afficherAnimationSucces(hReel, status.t, status.c);
            });
        }

        function afficherAnimationSucces(heure, status, colorClass) {
            const overlay = document.getElementById('successOverlay');
            overlay.innerHTML = `
                <img src="images/LOGO GREY CORNER.png" class="seal-anim mb-4">
                <div class="text-[#c5a059] font-black text-2xl tracking-tighter uppercase">Pointage R√©ussi</div>
                <div class="text-white text-5xl font-extrabold my-4">${heure}</div>
                <div class="${colorClass} font-black uppercase text-[12px] tracking-widest mb-10">${status}</div>
                <div class="text-slate-400 text-[10px] px-10 italic border-t border-white/5 pt-6 uppercase tracking-widest">Famille Grey Corner</div>
            `;
            overlay.style.display = 'flex';
            setTimeout(() => location.reload(), 4000);
        }

        function init() {
            const selection = document.getElementById('selectionZone');
            const action = document.getElementById('actionZone');
            
            // Compteur Live
            database.ref('presences/' + dateStr).on('value', snap => {
                let count = 0;
                Object.values(snap.val() || {}).forEach(e => { if(e.on) count++; });
                document.getElementById('presentCount').innerText = count;
            });

            if (selectedUser) {
                selection.classList.add('hidden');
                action.classList.remove('hidden');
                lancerGPS();
            } else {
                selection.classList.remove('hidden');
                document.getElementById('statusLabel').innerText = "CHOISISSEZ VOTRE PROFIL";
                ["admin", "bar", "cuisine", "menage", "service"].forEach(c => {
                    const h = document.createElement('div'); h.className = "drawer-header";
                    h.innerHTML = `<span>${c}</span> <i>‚ñº</i>`;
                    const div = document.createElement('div'); div.className = "drawer-content";
                    h.onclick = () => { div.classList.toggle('active'); };
                    equipeConfig.filter(e => e.t === c).forEach(emp => {
                        const b = document.createElement('button'); b.className = "btn-staff"; b.innerText = emp.n;
                        b.onclick = () => { if(confirm(emp.n + " ?")) { localStorage.setItem('gc_staff_name', emp.n); location.reload(); }};
                        div.appendChild(b);
                    });
                    selection.appendChild(h); selection.appendChild(div);
                });
            }
        }

        async function chargerTicker() {
            const URL = `https://docs.google.com/spreadsheets/d/1boSKTYt4TQW00j02eBCWPzDHngFZmSqPGBvDL1wsq64/gviz/tq?tqx=out:json&sheet=Messages_Urgent`;
            try {
                const r = await fetch(URL); const txt = await r.text();
                const json = JSON.parse(txt.substr(47).slice(0, -2));
                const active = json.table.rows.find(row => row.c[3] && row.c[3].v === "Actif");
                if (active) {
                    document.getElementById('tickerText').innerHTML = `üåô INFO : ${active.c[1].v} &nbsp;&nbsp; ‚ú¶ &nbsp;&nbsp; ${active.c[1].v}`;
                    document.getElementById('tickerContainer').style.display = 'flex';
                }
            } catch (e) {}
        }

        function resetUserMemory() { if(confirm("Changer de nom ?")) { localStorage.clear(); location.reload(); } }
        window.onload = () => { init(); chargerTicker(); };
    </script>
</body>
</html>
