<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pointage Certifi√© ‚Ä¢ Grey Corner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fdfaf6; }
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(197, 160, 89, 0.2); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
        }
        .btn-grey { background: #c5a059; transition: all 0.3s ease; }
        .btn-grey:disabled { background: #d1d5db; cursor: not-allowed; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div class="glass-card p-10 rounded-[2.5rem] w-full max-w-md text-center">
        <div class="bg-amber-50 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-amber-100">
            <span class="text-3xl">üåø</span>
        </div>

        <h1 class="text-2xl font-bold text-slate-800 tracking-tight mb-1">Grey Corner F√®s</h1>
        
        <div id="connectionStatus" class="inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-slate-100 text-slate-400 mb-8">
            V√©rification du r√©seau...
        </div>

        <div class="space-y-6">
            <div class="text-left">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-3 mb-2 block tracking-wider">Identit√© de l'√©quipier</label>
                <select id="staffSelect" class="w-full p-4 rounded-2xl border-2 border-slate-50 bg-white text-slate-700 font-semibold focus:border-amber-500 outline-none transition-all shadow-sm">
                    <option value="">-- Choisir --</option>
                </select>
            </div>

            <button onclick="validerPresence()" id="submitBtn" disabled class="w-full btn-grey text-white font-bold py-5 rounded-2xl shadow-lg shadow-amber-100 uppercase tracking-widest text-sm">
                V√©rification Wi-Fi...
            </button>
        </div>

        <div id="msg" class="mt-8 text-sm font-medium hidden leading-relaxed"></div>

        <footer class="mt-12 pt-6 border-t border-slate-50">
            <p class="text-[9px] text-slate-400 uppercase font-bold tracking-[0.3em]">Famille Grey Corner ‚Ä¢ 2026</p>
        </footer>
    </div>

    <audio id="zenSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // üîí IP FIXE DU CAF√â
        const IP_AUTORISEE = "41.142.204.14"; 

        const equipe = [
            "SALIL HOUDA", "BENKHADA ABDESLAM", "ENNHAIlI SOUMIA", "EL KOBBI MOSTAFA",
            "CHKAIRI YOUSSEF", "KHALOUQ RACHID", "FILALI ABDERAFI", "SBAI HAKIMA",
            "ELGORRAMY SOUAD", "ELGORRAMY ANISSA", "ELMCHAOURI SOUAD", "ZAIR FATIMA",
            "BELQASSE KHAOULA", "MAJDOUB JIHANE", "LEMSSIEH JAWAD", "BOURAHMA ANAS",
            "MOUJAHID IMANE", "IDRISSI SAAD", "GUETIBI AMINE", "EL MOEDEN HASSAN",
            "HIDARA YOUSSEF", "ALAOUI LAZIZ", "HATTAF MOHAMED", "MOHSINE YOUNESS"
        ];

        const select = document.getElementById('staffSelect');
        const btn = document.getElementById('submitBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const zenSound = document.getElementById('zenSound');

        equipe.sort().forEach(name => {
            let opt = document.createElement('option');
            opt.value = name.replace(/\s+/g, '_');
            opt.innerHTML = name;
            select.appendChild(opt);
        });

        async function verifierReseau() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                const userIP = data.ip;

                if (userIP === IP_AUTORISEE) {
                    connectionStatus.innerHTML = "‚úÖ R√©seau Grey Corner Valid√©";
                    connectionStatus.className = "inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-green-100 text-green-700 mb-8";
                    btn.disabled = false;
                    btn.innerHTML = "Valider mon arriv√©e";
                } else {
                    connectionStatus.innerHTML = "‚ùå R√©seau non autoris√© (F√®s)";
                    connectionStatus.className = "inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-red-100 text-red-700 mb-8";
                    btn.innerHTML = "Connectez-vous au Wi-Fi";
                    btn.disabled = true;
                }
            } catch (error) {
                connectionStatus.innerHTML = "‚ö†Ô∏è Erreur v√©rification";
                btn.innerHTML = "V√©rifiez votre connexion";
            }
        }

        async function validerPresence() {
            const user = select.value;
            if(!user) return alert("S√©lectionnez votre nom");

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            btn.disabled = true;
            btn.innerHTML = "Enregistrement...";

            const snap = await database.ref('presences/' + dateStr + '/' + user).once('value');
            if (snap.exists() && snap.val().hA) {
                msg.innerHTML = "‚ö†Ô∏è D√©j√† point√© pour aujourd'hui.";
                msg.className = "mt-8 p-4 bg-amber-50 text-amber-700 rounded-2xl font-bold block border border-amber-100";
                msg.style.display = "block";
                btn.innerHTML = "D√©j√† valid√©";
                return;
            }

            database.ref('presences/' + dateStr + '/' + user).update({
                on: true, 
                hA: timeStr,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                // Lecture du son Zen
                zenSound.play().catch(e => console.log("Audio bloqu√© par le navigateur"));

                msg.innerHTML = `‚ú® Merci ! <br> Arriv√©e certifi√©e √† <span class="text-amber-600">${timeStr}</span>. <br> Bon service √† toute la famille !`;
                msg.className = "mt-8 p-4 bg-green-50 text-green-700 rounded-2xl font-bold block border border-green-100";
                msg.style.display = "block";
                setTimeout(() => location.reload(), 4000);
            }).catch(err => {
                alert("Erreur r√©seau. R√©essayez.");
                btn.disabled = false;
            });
        }
        
        window.onload = verifierReseau;
    </script>
</body>
</html>
