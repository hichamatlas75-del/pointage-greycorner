<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pointage Certifi√© ‚Ä¢ Grey Corner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #fdfaf6; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(197, 160, 89, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        .btn-grey { background: #c5a059; transition: all 0.3s ease; }
        .btn-grey:disabled { background: #d1d5db; cursor: not-allowed; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

    <div class="glass-card p-10 rounded-[2.5rem] w-full max-w-md text-center">
        <div class="bg-amber-50 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 border border-amber-100">
            <span class="text-3xl">üåø</span>
        </div>

        <h1 class="text-2xl font-bold text-slate-800 tracking-tight mb-1">Grey Corner F√®s</h1>
        
        <div id="geoStatus" class="inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-slate-100 text-slate-400 mb-8">
            V√©rification GPS...
        </div>

        <div class="space-y-6">
            <div class="text-left">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-3 mb-2 block tracking-wider">Identit√© de l'√©quipier</label>
                <select id="staffSelect" class="w-full p-4 rounded-2xl border-2 border-slate-50 bg-white text-slate-700 font-semibold focus:border-amber-500 outline-none transition-all shadow-sm">
                    <option value="">-- Choisir --</option>
                </select>
            </div>
            <button onclick="validerPresence()" id="submitBtn" disabled class="w-full btn-grey text-white font-bold py-5 rounded-2xl shadow-lg shadow-amber-100 uppercase tracking-widest text-sm">
                Patientez...
            </button>
        </div>

        <div id="msg" class="mt-8 text-sm font-medium hidden leading-relaxed"></div>

        <footer class="mt-12 pt-6 border-t border-slate-50">
            <p class="text-[9px] text-slate-400 uppercase font-bold tracking-[0.3em]">Ouverture 06:30 ‚Ä¢ Famille Grey Corner</p>
        </footer>
    </div>

    <audio id="zenSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const CAFE_LAT = 34.0343959; 
        const CAFE_LON = -5.0155941;
        const RAYON_AUTORISE = 300; 

        let deviceId = localStorage.getItem('grey_corner_device_id');
        if (!deviceId) {
            deviceId = Math.random().toString(36).substring(2, 15) + "_" + Date.now();
            localStorage.setItem('grey_corner_device_id', deviceId);
        }

        // üìã LISTE DES EMPLOY√âS MISE √Ä JOUR
        const equipe = [
            "SALIL HOUDA", "BENKHADA ABDESLAM", "ENNHAIlI SOUMIA", "EL KOBBI MOSTAFA", 
            "CHKAIRI YOUSSEF", "KHALOUQ RACHID", "FILALI ABDERAFI", "SBAI HAKIMA", 
            "ELGORRAMY SOUAD", "ELGORRAMY ANISSA", "ELMCHAOURI SOUAD", "ZAIR FATIMA", 
            "BELQASSE KHAOULA", "MAJDOUB JIHANE", "LEMSSIEH JAWAD", "BOURAHMA ANAS", 
            "MOUJAHID IMANE", "IDRISSI SAAD", "GUETIBI AMINE", 
            "HIDARA YOUSSEF", "ALAOUI LAZIZ", "HATTAF MOHAMED", "MOHSINE YOUNESS",
            "KAFOUNI Zakariae"
        ];

        const select = document.getElementById('staffSelect');
        const btn = document.getElementById('submitBtn');
        const geoStatus = document.getElementById('geoStatus');

        equipe.sort().forEach(name => {
            let opt = document.createElement('option');
            opt.value = name.replace(/\s+/g, '_');
            opt.innerHTML = name;
            select.appendChild(opt);
        });

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180; const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180; const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function verifierPosition() {
            if (!navigator.geolocation) {
                geoStatus.innerHTML = "‚ùå GPS Non support√©";
                return;
            }
            navigator.geolocation.watchPosition((pos) => {
                const d = getDistance(pos.coords.latitude, pos.coords.longitude, CAFE_LAT, CAFE_LON);
                if (d <= RAYON_AUTORISE) {
                    geoStatus.innerHTML = "‚úÖ Bienvenue au Grey Corner";
                    geoStatus.className = "inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-green-100 text-green-700 mb-8";
                    btn.disabled = false;
                    btn.innerHTML = "Valider mon arriv√©e";
                } else {
                    geoStatus.innerHTML = "üìç Hors du Caf√©";
                    geoStatus.className = "inline-block px-4 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-red-100 text-red-700 mb-8";
                    btn.innerHTML = "Approchez-vous du caf√©";
                    btn.disabled = true;
                }
            }, null, { enableHighAccuracy: true });
        }

        async function validerPresence() {
            const user = select.value;
            if(!user) return alert("S√©lectionnez votre nom");

            btn.disabled = true;
            btn.innerHTML = "V√©rification...";

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            const dailyDevicesRef = database.ref('security/' + dateStr);
            const devSnap = await dailyDevicesRef.once('value');
            const devicesUsedToday = devSnap.val() || {};

            for (let name in devicesUsedToday) {
                if (devicesUsedToday[name] === deviceId && name !== user) {
                    alert("‚ùå S√©curit√© : Votre t√©l√©phone a d√©j√† servi aujourd'hui.");
                    btn.disabled = false;
                    btn.innerHTML = "Acc√®s refus√©";
                    return;
                }
            }

            const snap = await database.ref('presences/' + dateStr + '/' + user).once('value');
            if (snap.exists() && snap.val().hA) {
                alert("Vous avez d√©j√† valid√© votre arriv√©e !");
                btn.innerHTML = "D√©j√† point√©";
                return;
            }

            database.ref('presences/' + dateStr + '/' + user).update({
                on: true, hA: timeStr, device: deviceId, timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                dailyDevicesRef.update({ [user]: deviceId });
                document.getElementById('zenSound').play();
                msg.innerHTML = `‚ú® Merci ! <br> Arriv√©e certifi√©e √† <span class="text-amber-600">${timeStr}</span>.`;
                msg.className = "mt-8 p-4 bg-green-50 text-green-700 rounded-2xl font-bold block border border-green-100";
                msg.style.display = "block";
                setTimeout(() => location.reload(), 4000);
            });
        }
        window.onload = verifierPosition;
    </script>
</body>
</html>
