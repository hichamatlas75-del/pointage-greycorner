<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grey Corner ‚Ä¢ Pointage S√©curis√©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; background: #fdfaf6; font-family: 'Plus Jakarta Sans', sans-serif; }
        .main-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; }
        .glass-card { 
            background: white; border: 2px solid #c5a059; 
            width: 100%; max-width: 380px; height: 92vh; 
            border-radius: 2.5rem; padding: 1.2rem;
            display: flex; flex-direction: column; position: relative;
        }
        .staff-grid { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
            overflow-y: auto; flex-grow: 1; padding: 5px; margin-bottom: 10px;
        }
        .btn-staff { 
            border: 2px solid transparent; height: 60px; font-size: 9px; font-weight: 800; 
            border-radius: 12px; text-transform: uppercase; display: flex; 
            align-items: center; justify-content: center; text-align: center;
        }
        .btn-staff.selected { border-color: #c5a059; background: #fffcf5; box-shadow: 0 4px 12px rgba(197, 160, 89, 0.15); }
        .type-service { background: #eff6ff; color: #1e40af; }
        .type-cuisine { background: #fef2f2; color: #991b1b; }
        .type-menage { background: #ecfdf5; color: #065f46; }
        .type-bar { background: #f5f3ff; color: #5b21b6; }
        .type-admin { background: #fdf2f8; color: #9d174d; }

        /* ANIMATION DU BOUTON GPS */
        @keyframes pulse-geo {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.98); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .searching { animation: pulse-geo 1.5s infinite ease-in-out; background-color: #4b5563 !important; }

        .confirm-zone { display: flex; flex-direction: column; gap: 10px; padding: 15px 0; border-top: 1px solid #f1f5f9; }
        .btn-main {
            background: linear-gradient(135deg, #c5a059 0%, #d4af37 100%);
            color: white; font-weight: 800; padding: 20px; border-radius: 20px;
            text-transform: uppercase; font-size: 13px; box-shadow: 0 10px 25px rgba(197, 160, 89, 0.3);
        }
        .btn-main:disabled { background: #e2e8f0; box-shadow: none; color: #94a3b8; opacity: 0.6; }
        .logo-img { height: 70px; width: auto; object-fit: contain; margin: 0 auto 10px auto; }
        .staff-grid::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="glass-card">
            <img src="images/LOGO GREY CORNER.png" alt="Logo" class="logo-img">
            <div id="statusLabel" class="text-center px-3 py-1.5 rounded-full text-[8px] font-black uppercase tracking-widest bg-slate-100 text-slate-400 mb-2">S√©lectionnez votre nom</div>

            <div id="staffGrid" class="staff-grid"></div>

            <div class="confirm-zone">
                <button onclick="verifierPosition()" id="geoBtn" class="w-full bg-slate-800 text-white font-black py-4 rounded-xl text-[10px] uppercase tracking-widest hidden transition-all">
                    üìç √âtape 1 : Localisation
                </button>
                <button onclick="validerPresence()" id="submitBtn" class="btn-main w-full" disabled>Appuyer pour confirmer</button>
            </div>
            <div id="msg" class="mt-2 text-[11px] font-bold hidden p-3 rounded-xl text-center"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fingerprintjs2/2.1.0/fingerprint2.min.js"></script>

    <script>
        const firebaseConfig = { databaseURL: "https://grey-corner-presence-default-rtdb.europe-west1.firebasedatabase.app" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const CAFE_LAT = 34.0343959; const CAFE_LON = -5.0155941;
        const RAYON_AUTORISE = 300; 

        const equipeConfig = [
            {n: "ALAOUI LAZIZ", t: "service"}, {n: "BELQASSE KHAOULA", t: "cuisine"},
            {n: "BENKHADA ABDESLAM", t: "admin"}, {n: "BOURAHMA ANAS", t: "cuisine"},
            {n: "CHKAIRI YOUSSEF", t: "bar"}, {n: "ELKOBBI MOSTAFA", t: "bar"},
            {n: "ELGORRAMY ANISSA", t: "menage", ex: true}, {n: "ELGORRAMY SOUAD", t: "menage"},
            {n: "ELMCHAOURI SOUAD", t: "menage", ex: true}, {n: "ENNHAIlI SOUMIA", t: "admin"},
            {n: "FILALI ABDERAFI", t: "bar"}, {n: "GUETIBI AMINE", t: "service"},
            {n: "HATTAF MOHAMED", t: "service"}, {n: "HIDARA YOUSSEF", t: "service"},
            {n: "IDRISSI SAAD", t: "cuisine"}, {n: "KAFOUNI ZAKARIAE", t: "service"},
            {n: "KHALOUQ RACHID", t: "bar", ex: true}, {n: "LEMSSIEH JAWAD", t: "cuisine"},
            {n: "MAJDOUB JIHANE", t: "cuisine"}, {n: "MOUJAHID IMANE", t: "cuisine"},
            {n: "MOHSINE YOUNESS", t: "service"}, {n: "SALIL HOUDA", t: "admin"},
            {n: "SBAI HAKIMA", t: "menage", ex: true}, {n: "ZAIR FATIMA", t: "cuisine"}
        ];

        let selectedUser = null; let hpCache = null; let deviceID = null;
        const grid = document.getElementById('staffGrid');
        const submitBtn = document.getElementById('submitBtn');
        const geoBtn = document.getElementById('geoBtn');

        Fingerprint2.get((components) => {
            deviceID = Fingerprint2.x64hash128(components.map(c => c.value).join(''), 31);
        });

        const ordreFonctions = { "admin": 1, "bar": 2, "cuisine": 3, "menage": 4, "service": 5 };
        equipeConfig.sort((a, b) => ordreFonctions[a.t] - ordreFonctions[b.t] || a.n.localeCompare(b.n)).forEach(emp => {
            const btn = document.createElement('button');
            btn.className = `btn-staff type-${emp.t}`;
            btn.innerHTML = emp.n;
            btn.onclick = () => s√©lectionnerEmploy√©(btn, emp);
            grid.appendChild(btn);
        });

        async function s√©lectionnerEmploy√©(element, emp) {
            document.querySelectorAll('.btn-staff').forEach(b => b.classList.remove('selected'));
            element.classList.add('selected');
            selectedUser = emp.n.replace(/\s+/g, '_').toUpperCase();
            
            const dateStr = new Date().toISOString().split('T')[0];
            const snap = await database.ref('presences/' + dateStr + '/' + selectedUser).once('value');
            const data = snap.val();
            
            if (data && data.on === true) {
                alert("‚úÖ D√©j√† point√© pour aujourd'hui. Bon service !");
                selectedUser = null; element.classList.remove('selected');
                submitBtn.disabled = true; geoBtn.style.display = "none";
                return;
            }

            hpCache = data ? data.hP : null;
            geoBtn.style.display = emp.ex ? "none" : "block";
            geoBtn.innerHTML = "üìç √âtape 1 : Localisation"; // Reset texte
            geoBtn.classList.remove('searching');
            submitBtn.disabled = !emp.ex;
        }

        function verifierPosition() {
            // Activer l'animation
            geoBtn.innerHTML = "üîç Recherche de l'emplacement...";
            geoBtn.classList.add('searching');
            geoBtn.disabled = true;

            navigator.geolocation.getCurrentPosition((pos) => {
                const dist = getDistance(pos.coords.latitude, pos.coords.longitude, CAFE_LAT, CAFE_LON);
                if (dist <= RAYON_AUTORISE) {
                    geoBtn.innerHTML = "‚úÖ Emplacement valid√©";
                    geoBtn.classList.remove('searching');
                    geoBtn.style.backgroundColor = "#10b981"; // Vert succ√®s
                    submitBtn.disabled = false;
                } else { 
                    alert("‚ö†Ô∏è Vous n'√™tes pas au Grey Corner."); 
                    geoBtn.innerHTML = "üìç R√©essayer la localisation";
                    geoBtn.classList.remove('searching');
                    geoBtn.disabled = false;
                }
            }, (err) => {
                alert("‚ö†Ô∏è Erreur GPS. Activez votre localisation.");
                geoBtn.innerHTML = "üìç R√©essayer";
                geoBtn.classList.remove('searching');
                geoBtn.disabled = false;
            }, { enableHighAccuracy: true });
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI/180; const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180; const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function validerPresence() {
            if (!deviceID || !selectedUser) return;
            submitBtn.disabled = true;

            const userRef = database.ref('users/' + selectedUser);
            const userSnap = await userRef.once('value');
            const storedID = userSnap.val() ? userSnap.val().deviceID : null;

            if (storedID && storedID !== deviceID) {
                alert("‚ö†Ô∏è Appareil non reconnu.");
                submitBtn.disabled = false; return;
            }

            if (!storedID) { await userRef.set({ deviceID: deviceID }); }

            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            let retard = false;
            if (hpCache) {
                const [h, m] = hpCache.split(':').map(Number);
                if ((now.getHours() * 60 + now.getMinutes()) > (h * 60 + m + 5)) retard = true;
            }

            database.ref('presences/' + dateStr + '/' + selectedUser).update({
                on: true, hA: timeStr, retard: retard, device: deviceID
            }).then(() => {
                const msg = document.getElementById('msg');
                msg.innerHTML = `‚ú® Pointage r√©ussi √† ${timeStr}`;
                msg.className = "mt-2 p-3 font-bold block bg-green-100 text-green-700";
                msg.style.display = "block";
                setTimeout(() => location.reload(), 3000);
            });
        }
    </script>
</body>
</html>
